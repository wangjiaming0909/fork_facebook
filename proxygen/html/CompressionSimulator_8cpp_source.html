<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>proxygen: proxygen/lib/http/codec/compress/experimental/simulator/CompressionSimulator.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">proxygen
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('CompressionSimulator_8cpp_source.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">CompressionSimulator.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="CompressionSimulator_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> *  Copyright (c) 2015-present, Facebook, Inc.</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *  All rights reserved.</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *  This source code is licensed under the BSD-style license found in the</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> *  LICENSE file in the root directory of this source tree. An additional grant</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> *  of patent rights can be found in the PATENTS file in the same directory.</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="CompressionSimulator_8h.html">proxygen/lib/http/codec/compress/experimental/simulator/CompressionSimulator.h</a>&quot;</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="CompressionUtils_8h.html">proxygen/lib/http/codec/compress/experimental/simulator/CompressionUtils.h</a>&quot;</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="HPACKScheme_8h.html">proxygen/lib/http/codec/compress/experimental/simulator/HPACKScheme.h</a>&quot;</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="QPACKScheme_8h.html">proxygen/lib/http/codec/compress/experimental/simulator/QPACKScheme.h</a>&quot;</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="QMINScheme_8h.html">proxygen/lib/http/codec/compress/experimental/simulator/QMINScheme.h</a>&quot;</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="HTTPArchive_8h.html">proxygen/lib/http/codec/compress/test/HTTPArchive.h</a>&gt;</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="utils_2TestUtils_8h.html">proxygen/lib/utils/TestUtils.h</a>&gt;</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="Time_8h.html">proxygen/lib/utils/Time.h</a>&gt;</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="keyword">using namespace </span><a class="code" href="namespacestd.html">std</a>;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="keyword">using namespace </span><a class="code" href="namespacefolly.html">folly</a>;</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="keyword">using namespace </span><a class="code" href="namespaceproxygen.html">proxygen</a>;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="keyword">namespace </span>{</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="keyword">using namespace </span><a class="code" href="namespaceproxygen_1_1compress.html">proxygen::compress</a>;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">// This needs to be synchronized with HPACKEncoder::kAutoFlushThreshold.</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="keyword">const</span> <span class="keywordtype">size_t</span> kMTU = 1400;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="keyword">const</span> std::string kTestDir = <a class="code" href="utils_2TestUtils_8h.html#af8eec91e411dbb6899c8554284c9971d">getContainingDirectory</a>(__FILE__).str();</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;} <span class="comment">// namespace</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespaceproxygen.html">proxygen</a> { <span class="keyword">namespace </span>compress {</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#a669fd5e309fe7b672d0a192039782b9a">   36</a></span>&#160;<span class="keywordtype">bool</span> CompressionSimulator::readInputFromFileAndSchedule(</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; filename) {</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;  unique_ptr&lt;HTTPArchive&gt; har;</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;  <span class="keywordflow">try</span> {</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    har = HTTPArchive::fromFile(kTestDir + filename);</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;  } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; ex) {</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    LOG(<a class="code" href="namespaceproxygen.html#ab18179a16a0bebed81cf3f62dff11064abb1ca97ec761fc37101737ba0aa2e7c5">ERROR</a>) &lt;&lt; folly::exceptionStr(ex);</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;  }</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;  <span class="keywordflow">if</span> (!har || har-&gt;<a class="code" href="classproxygen_1_1HTTPArchive.html#a3b0e159ff83d50caf77b1dd29dd3c868">requests</a>.size() == 0) {</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;  }</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;  <span class="comment">// Sort by start time (har ordered by finish time?)</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;  std::sort(har-&gt;<a class="code" href="classproxygen_1_1HTTPArchive.html#a3b0e159ff83d50caf77b1dd29dd3c868">requests</a>.begin(),</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;            har-&gt;<a class="code" href="classproxygen_1_1HTTPArchive.html#a3b0e159ff83d50caf77b1dd29dd3c868">requests</a>.end(),</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;            [](<span class="keyword">const</span> <a class="code" href="classproxygen_1_1HTTPMessage.html">HTTPMessage</a>&amp; a, <span class="keyword">const</span> <a class="code" href="classproxygen_1_1HTTPMessage.html">HTTPMessage</a>&amp; b) {</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;              <span class="keywordflow">return</span> a.<a class="code" href="classproxygen_1_1HTTPMessage.html#ad50401dd7754119846424e9b26434976">getStartTime</a>() &lt; b.getStartTime();</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;            });</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;  <a class="code" href="namespaceproxygen.html#ab1ccd825f69c99dd89b92765687b8d27">TimePoint</a> last = har-&gt;<a class="code" href="classproxygen_1_1HTTPArchive.html#a3b0e159ff83d50caf77b1dd29dd3c868">requests</a>[0].getStartTime();</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  std::chrono::milliseconds cumulativeDelay(0);</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  uint16_t index = 0;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  <span class="keywordflow">for</span> (<a class="code" href="classproxygen_1_1HTTPMessage.html">HTTPMessage</a>&amp; msg : har-&gt;<a class="code" href="classproxygen_1_1HTTPArchive.html#a3b0e159ff83d50caf77b1dd29dd3c868">requests</a>) {</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    <span class="keyword">auto</span> delayFromPrevious = <a class="code" href="namespaceproxygen.html#ae94f36adf5ce28528d9e34c9ba9cc5f8">millisecondsBetween</a>(msg.<a class="code" href="classproxygen_1_1HTTPMessage.html#ad50401dd7754119846424e9b26434976">getStartTime</a>(), last);</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="comment">// If there was a quiescent gap in the HAR of at least some value, shrink</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <span class="comment">// it so the test doesn&#39;t last forever</span></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <span class="keywordflow">if</span> (delayFromPrevious &gt; std::chrono::milliseconds(1000)) {</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;      delayFromPrevious = std::chrono::milliseconds(1000);</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    }</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    last = msg.<a class="code" href="classproxygen_1_1HTTPMessage.html#ad50401dd7754119846424e9b26434976">getStartTime</a>();</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    cumulativeDelay += delayFromPrevious;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    setupRequest(index++, std::move(msg), cumulativeDelay);</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;  }</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;  <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; kv : domains_) {</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    flushRequests(kv.second.get());</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;  }</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;}</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div><div class="line"><a name="l00073"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#a5b756a2a20de3ecd7f2fd00c995b78d6">   73</a></span>&#160;<span class="keywordtype">void</span> CompressionSimulator::run() {</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="preprocessor">#ifndef HAVE_REAL_QMIN</span></div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  <span class="keywordflow">if</span> (params_.type == SchemeType::QMIN) {</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    LOG(INFO) &lt;&lt; <span class="stringliteral">&quot;QMIN not available&quot;</span>;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  }</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  LOG(INFO) &lt;&lt; <span class="stringliteral">&quot;Starting run&quot;</span>;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  eventBase_.loop();</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  uint32_t holBlockCount = 0;</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; scheme : domains_) {</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    holBlockCount += scheme.second-&gt;getHolBlockCount();</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  }</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  LOG(INFO) &lt;&lt; <span class="stringliteral">&quot;Complete&quot;</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;\nStats:&quot;</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;               <span class="stringliteral">&quot;\nSeed: &quot;</span></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;            &lt;&lt; params_.seed &lt;&lt; <span class="stringliteral">&quot;\nBlocks sent: &quot;</span> &lt;&lt; requests_.size()</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;\nAllowed OOO: &quot;</span> &lt;&lt; stats_.allowedOOO</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;\nPackets: &quot;</span> &lt;&lt; stats_.packets</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;\nPacket Losses: &quot;</span> &lt;&lt; stats_.packetLosses</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;\nHOL Block Count: &quot;</span> &lt;&lt; holBlockCount</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;\nHOL Delay (ms): &quot;</span> &lt;&lt; stats_.holDelay.count()</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;\nMax Queue Buffer Bytes: &quot;</span> &lt;&lt; stats_.maxQueueBufferBytes</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;\nUncompressed Bytes: &quot;</span> &lt;&lt; stats_.uncompressed</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;\nCompressed Bytes: &quot;</span> &lt;&lt; stats_.compressed</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;\nCompression Ratio: &quot;</span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;            &lt;&lt; int(100 - <span class="keywordtype">double</span>(100 * stats_.compressed) / stats_.uncompressed);</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;}</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div><div class="line"><a name="l00103"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#ae5507a6cc20d0189a91a840c1e9650ea">  103</a></span>&#160;<span class="keywordtype">void</span> CompressionSimulator::flushRequests(<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html">CompressionScheme</a>* scheme) {</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  VLOG(5) &lt;&lt; <span class="stringliteral">&quot;schedule encode for &quot;</span> &lt;&lt; scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#a625e785dd8c5fa8aa84d686739d604ec">packetIndices</a>.size()</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;          &lt;&lt; <span class="stringliteral">&quot; blocks at &quot;</span> &lt;&lt; scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#a2a356966d15ef97cdda9c121985f84dd">prev</a>.count();</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  <span class="comment">// Flush previous train</span></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;  scheduleEvent(</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;      [<span class="keyword">this</span>, scheme, indices = std::move(scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#a625e785dd8c5fa8aa84d686739d604ec">packetIndices</a>)]() <span class="keyword">mutable</span> {</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        bool newPacket = true;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        while (!indices.empty()) {</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;          int16_t index = indices.front();</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;          indices.pop_front();</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;          auto schemeIndex = scheme-&gt;index;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;          auto encodeRes = encode(scheme, newPacket, index);</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;          FrameFlags flags = encodeRes.first;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;          bool allowOOO = flags.allowOOO;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;          if (schemeIndex &lt; minOOOThresh()) {</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;            allowOOO = false;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;            auto ack = scheme-&gt;getAck(schemeIndex);</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;            if (ack) {</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;              scheme-&gt;recvAck(std::move(ack));</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;            }</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;          }</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;          stats_.allowedOOO += (allowOOO) ? 1 : 0;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;          flags.allowOOO = allowOOO;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;          scheme-&gt;encodedBlocks.emplace_back(flags,</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;                                             newPacket,</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;                                             std::move(encodeRes.second),</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;                                             &amp;callbacks_[index]);</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;          newPacket = false;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        }</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        eventBase_.runInLoop(scheme, <span class="keyword">true</span>);</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;      },</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;      scheme-&gt;prev);</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;}</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div><div class="line"><a name="l00137"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#a63980bd7582703dfdd89aa3fffdc93ff">  137</a></span>&#160;<span class="keywordtype">void</span> CompressionSimulator::setupRequest(uint16_t index,</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;                                        <a class="code" href="classproxygen_1_1HTTPMessage.html">HTTPMessage</a>&amp;&amp; msg,</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;                                        std::chrono::milliseconds encodeDelay) {</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;  <span class="comment">// Normalize to relative paths</span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; query = msg.getQueryString();</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;  <span class="keywordflow">if</span> (query.empty()) {</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    msg.setURL(msg.getPath());</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    msg.setURL(folly::to&lt;string&gt;(msg.getPath(), <span class="stringliteral">&quot;?&quot;</span>, query));</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  }</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;  <span class="keyword">auto</span> scheme = getScheme(msg.getHeaders().getSingleOrEmpty(HTTP_HEADER_HOST));</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;  requests_.emplace_back(msg);</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;  <span class="keyword">auto</span> decodeCompleteCB =</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;      [index, <span class="keyword">this</span>, scheme](std::chrono::milliseconds holDelay) {</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <span class="comment">// record processed timestamp</span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;        CHECK(!callbacks_[index].getResult().hasError());</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        DCHECK_EQ(requests_[index], *callbacks_[index].getResult().value());</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        stats_.holDelay += holDelay;</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        VLOG(1) &lt;&lt; <span class="stringliteral">&quot;Finished decoding request=&quot;</span> &lt;&lt; index</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;                &lt;&lt; <span class="stringliteral">&quot; with holDelay=&quot;</span> &lt;&lt; holDelay.count()</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;                &lt;&lt; <span class="stringliteral">&quot; cumulative HoL delay=&quot;</span> &lt;&lt; stats_.holDelay.count();</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        <span class="keywordflow">if</span> (callbacks_[index].acknowledge) {</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;          sendAck(scheme, scheme-&gt;getAck(callbacks_[index].seqn));</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        }</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;      };</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  callbacks_.emplace_back(index, decodeCompleteCB);</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  <span class="comment">// Assume that all packets with same encodeDelay will form a packet</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;  <span class="comment">// train.  Encode them as a group, so can we can emulate packet</span></div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  <span class="comment">// boundaries more realistically, telling the encoder which blocks</span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  <span class="comment">// start such trains.</span></div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;  <span class="keywordflow">if</span> (scheme-&gt;packetIndices.size() &gt; 0) {</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="keyword">auto</span> delayFromPrevious = encodeDelay - scheme-&gt;prev;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    VLOG(1) &lt;&lt; <span class="stringliteral">&quot;request &quot;</span> &lt;&lt; index &lt;&lt; <span class="stringliteral">&quot; delay &quot;</span> &lt;&lt; delayFromPrevious.count();</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    <span class="keywordflow">if</span> (delayFromPrevious &gt; std::chrono::milliseconds(1)) {</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;      flushRequests(scheme);</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    }</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;  }</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;  scheme-&gt;prev = encodeDelay;</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  scheme-&gt;packetIndices.push_back(index);</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;}</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="comment">// Once per loop, each connection flushes it&#39;s encode blocks and schedules</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="comment">// decodes based on how many packets the block occupies</span></div><div class="line"><a name="l00182"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionScheme.html#ab3f9a79c53cc1e5bea7a1ebc6fd47e6b">  182</a></span>&#160;<span class="keywordtype">void</span> CompressionScheme::runLoopCallback() noexcept {</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  simulator_-&gt;flushSchemePackets(<span class="keyword">this</span>);</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;}</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div><div class="line"><a name="l00186"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#adbe2351c3837f1532bedee587d37d4b0">  186</a></span>&#160;<span class="keywordtype">void</span> CompressionSimulator::flushPacket(<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html">CompressionScheme</a>* scheme) {</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;  <span class="keywordflow">if</span> (scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#af6fb1e0f08c33671a116f4fe85d4ebe1">packetBlocks</a>.empty()) {</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;  }</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;  stats_.packets++;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;  VLOG(1) &lt;&lt; <span class="stringliteral">&quot;schedule decode for &quot;</span> &lt;&lt; scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#af6fb1e0f08c33671a116f4fe85d4ebe1">packetBlocks</a>.size()</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;          &lt;&lt; <span class="stringliteral">&quot; blocks at &quot;</span> &lt;&lt; scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#a7941a48e560dae88e07d62943dc4da7a">decodeDelay</a>.count();</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;  scheduleEvent(</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;      {[<span class="keyword">this</span>, scheme, blocks = std::move(scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#af6fb1e0f08c33671a116f4fe85d4ebe1">packetBlocks</a>)]() <span class="keyword">mutable</span> {</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        decodePacket(scheme, blocks);</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;      }},</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;      scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#a7941a48e560dae88e07d62943dc4da7a">decodeDelay</a>);</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;  scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#a4f71fa1ca3db61ad6b7aa4a078bb8b76">packetBytes</a> = 0;</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;}</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div><div class="line"><a name="l00202"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#a884a49adac43a3f563dc5d09b15de14a">  202</a></span>&#160;<span class="keywordtype">void</span> CompressionSimulator::flushSchemePackets(<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html">CompressionScheme</a>* scheme) {</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;  CHECK(!scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#ab9712b0de439245609196d02570ae20e">encodedBlocks</a>.empty());</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;  VLOG(2) &lt;&lt; <span class="stringliteral">&quot;Flushing &quot;</span> &lt;&lt; scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#ab9712b0de439245609196d02570ae20e">encodedBlocks</a>.size() &lt;&lt; <span class="stringliteral">&quot; requests&quot;</span>;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;  <span class="comment">// tracks the number of bytes in the current simulated packet</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;  <span class="keyword">auto</span> encodeRes = &amp;scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#ab9712b0de439245609196d02570ae20e">encodedBlocks</a>.front();</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;  <span class="keywordtype">bool</span> newPacket = std::get&lt;1&gt;(*encodeRes);</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;  <span class="keywordtype">size_t</span> headerBlockBytesRemaining =</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;      std::get&lt;2&gt;(*encodeRes)-&gt;computeChainDataLength();</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;  std::chrono::milliseconds packetDelay = deliveryDelay();</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;  scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#a7941a48e560dae88e07d62943dc4da7a">decodeDelay</a> = packetDelay;</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;  <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    <span class="keywordflow">if</span> (newPacket) {</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;      flushPacket(scheme);</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    }</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    newPacket = <span class="keyword">false</span>;</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <span class="comment">// precondition packetBytes &lt; kMTU</span></div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="keywordflow">if</span> (scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#a4f71fa1ca3db61ad6b7aa4a078bb8b76">packetBytes</a> + headerBlockBytesRemaining &gt;= kMTU) {</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;      <span class="comment">// Header block filled current packet, triggering a flush</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;      VLOG(2) &lt;&lt; <span class="stringliteral">&quot;Request(s) spanned multiple packets&quot;</span>;</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;      newPacket = <span class="keyword">true</span>;</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;      scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#a4f71fa1ca3db61ad6b7aa4a078bb8b76">packetBytes</a> += headerBlockBytesRemaining;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    }</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    headerBlockBytesRemaining -=</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        std::min(headerBlockBytesRemaining, kMTU - scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#a4f71fa1ca3db61ad6b7aa4a078bb8b76">packetBytes</a>);</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="keywordflow">if</span> (headerBlockBytesRemaining == 0) {</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;      <span class="comment">// Move from the first element of encodedBlocks to the last</span></div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;      <span class="comment">// element of packetBlocks.</span></div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;      scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#af6fb1e0f08c33671a116f4fe85d4ebe1">packetBlocks</a>.splice(scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#af6fb1e0f08c33671a116f4fe85d4ebe1">packetBlocks</a>.end(),</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                                  scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#ab9712b0de439245609196d02570ae20e">encodedBlocks</a>,</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                                  scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#ab9712b0de439245609196d02570ae20e">encodedBlocks</a>.begin());</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;      <span class="keywordflow">if</span> (scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#ab9712b0de439245609196d02570ae20e">encodedBlocks</a>.empty()) {</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        <span class="comment">// All done</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;      }</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;      <span class="comment">// Grab the next request</span></div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;      encodeRes = &amp;scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#ab9712b0de439245609196d02570ae20e">encodedBlocks</a>.front();</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;      newPacket = std::get&lt;1&gt;(*encodeRes);</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;      headerBlockBytesRemaining =</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;          std::get&lt;2&gt;(*encodeRes)-&gt;computeChainDataLength();</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    }</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    <span class="keywordflow">if</span> (newPacket) {</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;      packetDelay = deliveryDelay();</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;      scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#a7941a48e560dae88e07d62943dc4da7a">decodeDelay</a> = std::max(scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#a7941a48e560dae88e07d62943dc4da7a">decodeDelay</a>, packetDelay);</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    }</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;  }</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;  flushPacket(scheme);</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;  CHECK(scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#ab9712b0de439245609196d02570ae20e">encodedBlocks</a>.empty());</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;}</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;</div><div class="line"><a name="l00252"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#a1d2618417295b3be19f67d35d8f974af">  252</a></span>&#160;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html">CompressionScheme</a>* CompressionSimulator::getScheme(StringPiece domain) {</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">string</span> blended(<span class="stringliteral">&quot;\&quot;Facebook\&quot;&quot;</span>);</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;  <span class="keywordflow">if</span> (params_.blend &amp;&amp;</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;      (domain.endsWith(<span class="stringliteral">&quot;facebook.com&quot;</span>) || domain.endsWith(<span class="stringliteral">&quot;fbcdn.net&quot;</span>))) {</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    domain = blended;</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;  }</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;  <span class="keyword">auto</span> it = domains_.find(domain.str());</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;  <a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html">CompressionScheme</a>* scheme = <span class="keyword">nullptr</span>;</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;  <span class="keywordflow">if</span> (it == domains_.end()) {</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    LOG(INFO) &lt;&lt; <span class="stringliteral">&quot;Creating scheme for domain=&quot;</span> &lt;&lt; domain;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    <span class="keyword">auto</span> schemePtr = makeScheme();</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    scheme = schemePtr.get();</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    domains_.emplace(domain.str(), std::move(schemePtr));</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;  } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    scheme = it-&gt;second.get();</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;  }</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;  <span class="keywordflow">return</span> scheme;</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;}</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;</div><div class="line"><a name="l00272"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#a8be7f9576f03cd8f562ebb0755cd8d69">  272</a></span>&#160;unique_ptr&lt;CompressionScheme&gt; CompressionSimulator::makeScheme() {</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;  <span class="keywordflow">switch</span> (params_.type) {</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <span class="keywordflow">case</span> SchemeType::QPACK:</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;      <span class="keywordflow">return</span> make_unique&lt;QPACKScheme&gt;(<span class="keyword">this</span>, params_.tableSize,</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                                      params_.maxBlocking);</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <span class="keywordflow">case</span> SchemeType::QMIN:</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;      <span class="keywordflow">return</span> make_unique&lt;QMINScheme&gt;(<span class="keyword">this</span>, params_.tableSize);</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    <span class="keywordflow">case</span> SchemeType::HPACK:</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;      <span class="keywordflow">return</span> make_unique&lt;HPACKScheme&gt;(<span class="keyword">this</span>, params_.tableSize);</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;  }</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;  LOG(FATAL) &lt;&lt; <span class="stringliteral">&quot;Bad scheme&quot;</span>;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;}</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;</div><div class="line"><a name="l00286"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#a566957fa4b7a925f5cae7660b4ed24b9">  286</a></span>&#160;std::pair&lt;FrameFlags, unique_ptr&lt;IOBuf&gt;&gt; <a class="code" href="HPACKBenchmark_8cpp.html#a860e4ea0c5704e11bd4caccf4a64180f">CompressionSimulator::encode</a>(</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    <a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html">CompressionScheme</a>* scheme, <span class="keywordtype">bool</span> newPacket, uint16_t index) {</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;  VLOG(1) &lt;&lt; <span class="stringliteral">&quot;Start encoding request=&quot;</span> &lt;&lt; index;</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;  <span class="comment">// vector to hold cookie crumbs</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;  vector&lt;string&gt; cookies;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  vector&lt;compress::Header&gt; allHeaders = <a class="code" href="namespaceproxygen_1_1compress.html#a87be4e4c674336304ac9c82b0e244685">prepareMessageForCompression</a>(</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;      requests_[index], cookies);</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;  <span class="keyword">auto</span> before = stats_.uncompressed;</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;  <span class="keyword">auto</span> res = scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#a4e013945112c438374a2cb99eb753d67">encode</a>(newPacket, std::move(allHeaders), stats_);</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;  VLOG(1) &lt;&lt; <span class="stringliteral">&quot;Encoded request=&quot;</span> &lt;&lt; index &lt;&lt; <span class="stringliteral">&quot; for host=&quot;</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;          &lt;&lt; requests_[index].getHeaders().getSingleOrEmpty(HTTP_HEADER_HOST)</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;          &lt;&lt; <span class="stringliteral">&quot; orig size=&quot;</span> &lt;&lt; (stats_.uncompressed - before)</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;          &lt;&lt; <span class="stringliteral">&quot; block size=&quot;</span> &lt;&lt; res.second-&gt;computeChainDataLength()</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;          &lt;&lt; <span class="stringliteral">&quot; cumulative bytes=&quot;</span> &lt;&lt; stats_.compressed</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;          &lt;&lt; <span class="stringliteral">&quot; cumulative compression ratio=&quot;</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;          &lt;&lt; int(100 - <span class="keywordtype">double</span>(100 * stats_.compressed) / stats_.uncompressed);</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;  <span class="keywordflow">return</span> res;</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;}</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;</div><div class="line"><a name="l00306"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#ae82cb6f93c12771defb01fe392d12639">  306</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespaceproxygen_1_1hpack.html#aa061a948252af0d148d16d87f86d1872">CompressionSimulator::decode</a>(<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html">CompressionScheme</a>* scheme,</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                                  <a class="code" href="structproxygen_1_1compress_1_1FrameFlags.html">FrameFlags</a> <a class="code" href="http__parser_8h.html#ab6b306ef981f5e21bb41ea2c2dbe8cd9">flags</a>,</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                                  unique_ptr&lt;IOBuf&gt; encodedReq,</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;                                  <a class="code" href="classproxygen_1_1compress_1_1SimStreamingCallback.html">SimStreamingCallback</a>&amp; cb) {</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;  scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#ac5ddabc82889df4797e1e869dc32e4e2">decode</a>(flags, std::move(encodedReq), stats_, cb);</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;}</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;</div><div class="line"><a name="l00313"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#a38bef8da0daefefa016062dfc5374f11">  313</a></span>&#160;<span class="keywordtype">void</span> CompressionSimulator::decodePacket(</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    <a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html">CompressionScheme</a>* scheme,</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    std::list&lt;CompressionScheme::BlockInfo&gt;&amp; blocks) {</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;  VLOG(1) &lt;&lt; <span class="stringliteral">&quot;decode packet with &quot;</span> &lt;&lt; blocks.size() &lt;&lt; <span class="stringliteral">&quot; blocks&quot;</span>;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;  <span class="keywordflow">while</span> (!blocks.empty()) {</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    <span class="keyword">auto</span> encodeRes = &amp;blocks.front();</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    <span class="comment">// TODO(ckrasic) - to get packet coordination correct, could plumb</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    <span class="comment">// through &quot;start of packet&quot; flag here.  Probably not worth it,</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    <span class="comment">// since it seems to make only a very small difference (about a</span></div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    <span class="comment">// 0.1% compressiondifference on my facebook har).</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    <a class="code" href="namespaceproxygen_1_1hpack.html#aa061a948252af0d148d16d87f86d1872">decode</a>(scheme,</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;           std::get&lt;0&gt;(*encodeRes),</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;           std::move(std::get&lt;2&gt;(*encodeRes)),</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;           *std::get&lt;3&gt;(*encodeRes));</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    blocks.pop_front();</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;  }</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;}</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;</div><div class="line"><a name="l00331"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#ac04f1b78922a01355be9bc27d20455a7">  331</a></span>&#160;<span class="keywordtype">void</span> CompressionSimulator::scheduleEvent(folly::Function&lt;<span class="keywordtype">void</span>()&gt; f,</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                                         std::chrono::milliseconds ms) {</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;  eventBase_.runAfterDelay(std::move(f), ms.count());</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;}</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;</div><div class="line"><a name="l00336"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#a6d9e755a51c6b580b6c793bbdd0e72d9">  336</a></span>&#160;<span class="keywordtype">void</span> CompressionSimulator::sendAck(<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html">CompressionScheme</a>* scheme,</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;                                   unique_ptr&lt;CompressionScheme::Ack&gt; ack) {</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;  <span class="keywordflow">if</span> (!ack) {</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;  }</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;  <span class="comment">// An ack is a packet</span></div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;  stats_.packets++;</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;  scheduleEvent([a = std::move(ack),</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;                 <span class="keyword">this</span>,</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;                 scheme]() <span class="keyword">mutable</span> { recvAck(scheme, std::move(a)); },</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                deliveryDelay());</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;}</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;</div><div class="line"><a name="l00349"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#a1edc5901ae87a12da5851a6a238293fc">  349</a></span>&#160;<span class="keywordtype">void</span> CompressionSimulator::recvAck(<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html">CompressionScheme</a>* scheme,</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;                                   unique_ptr&lt;CompressionScheme::Ack&gt; ack) {</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;  scheme-&gt;<a class="code" href="classproxygen_1_1compress_1_1CompressionScheme.html#a8b5b9dbfd8f08e0dfdc6415e7432ddbf">recvAck</a>(std::move(ack));</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;}</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;</div><div class="line"><a name="l00354"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#af0d6d728f67553cdfa0149c7bc7e634f">  354</a></span>&#160;std::chrono::milliseconds CompressionSimulator::deliveryDelay() {</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;  std::chrono::milliseconds delay = one_half_rtt();</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;  <span class="keywordflow">while</span> (loss()) {</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    stats_.packetLosses++;</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    scheduleEvent([] { VLOG(4) &lt;&lt; <span class="stringliteral">&quot;Packet lost!&quot;</span>; }, delay);</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    std::chrono::milliseconds rxmit = rxmitDelay();</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;    delay += rxmit;</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    scheduleEvent(</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        [rxmit] {</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;          VLOG(4) &lt;&lt; <span class="stringliteral">&quot;Packet loss detected, retransmitting with additional &quot;</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                  &lt;&lt; rxmit.count();</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        },</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;        delay - one_half_rtt());</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;  }</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;  <span class="keywordflow">if</span> (delayed()) {</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    scheduleEvent([] { VLOG(4) &lt;&lt; <span class="stringliteral">&quot;Packet delayed in network&quot;</span>; }, delay);</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    delay += extraDelay();</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;  }</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;  <span class="keywordflow">return</span> delay;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;}</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;</div><div class="line"><a name="l00375"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#aee96fdc737e78658a558b44c877bca6d">  375</a></span>&#160;std::chrono::milliseconds CompressionSimulator::rtt() {</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;  <span class="keywordflow">return</span> params_.rtt;</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;}</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;</div><div class="line"><a name="l00379"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#ac277f5cf3c36830948b344ecad58db3e">  379</a></span>&#160;std::chrono::milliseconds CompressionSimulator::one_half_rtt() {</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;  <span class="keywordflow">return</span> params_.rtt / 2;</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;}</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;</div><div class="line"><a name="l00383"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#a5c93f855c37efddfc1468a754aca7539">  383</a></span>&#160;std::chrono::milliseconds CompressionSimulator::rxmitDelay() {</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;  uint32_t ms = rtt().count() * Random::randDouble(1.1, 2, rng_);</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;  <span class="keywordflow">return</span> std::chrono::milliseconds(ms);</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;}</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;</div><div class="line"><a name="l00388"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#a8c5b3ac32f847eb57ffa25b48bbc938a">  388</a></span>&#160;<span class="keywordtype">bool</span> CompressionSimulator::loss() {</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;  <span class="keywordflow">return</span> Random::randDouble01(rng_) &lt; params_.lossProbability;</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;}</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;</div><div class="line"><a name="l00392"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#a1946a350f39d75b58da56fcf21080b08">  392</a></span>&#160;<span class="keywordtype">bool</span> CompressionSimulator::delayed() {</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;  <span class="keywordflow">return</span> Random::randDouble01(rng_) &lt; params_.delayProbability;</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;}</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;</div><div class="line"><a name="l00396"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#a17527a82237c46d5d9968605cefe2aee">  396</a></span>&#160;std::chrono::milliseconds CompressionSimulator::extraDelay() {</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;  uint32_t ms = params_.maxDelay.count() * Random::randDouble01(rng_);</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;  <span class="keywordflow">return</span> std::chrono::milliseconds(ms);</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;}</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;</div><div class="line"><a name="l00401"></a><span class="lineno"><a class="line" href="classproxygen_1_1compress_1_1CompressionSimulator.html#aa3aa2b684f8d8a8aad6850bfafa94c29">  401</a></span>&#160;uint32_t CompressionSimulator::minOOOThresh() {</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;  <span class="keywordflow">return</span> params_.minOOOThresh;</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;}</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;}} <span class="comment">// namespace proxygen::compress</span></div><div class="ttc" id="QPACKScheme_8h_html"><div class="ttname"><a href="QPACKScheme_8h.html">QPACKScheme.h</a></div></div>
<div class="ttc" id="namespaceproxygen_html_ae94f36adf5ce28528d9e34c9ba9cc5f8"><div class="ttname"><a href="namespaceproxygen.html#ae94f36adf5ce28528d9e34c9ba9cc5f8">proxygen::millisecondsBetween</a></div><div class="ttdeci">std::chrono::milliseconds millisecondsBetween(std::chrono::time_point&lt; ClockType &gt; finish, std::chrono::time_point&lt; ClockType &gt; start)</div><div class="ttdef"><b>Definition:</b> <a href="Time_8h_source.html#l00085">Time.h:85</a></div></div>
<div class="ttc" id="http__parser_8h_html_ab6b306ef981f5e21bb41ea2c2dbe8cd9"><div class="ttname"><a href="http__parser_8h.html#ab6b306ef981f5e21bb41ea2c2dbe8cd9">flags</a></div><div class="ttdeci">flags</div><div class="ttdef"><b>Definition:</b> <a href="http__parser_8h_source.html#l00127">http_parser.h:127</a></div></div>
<div class="ttc" id="classproxygen_1_1compress_1_1CompressionScheme_html_a2a356966d15ef97cdda9c121985f84dd"><div class="ttname"><a href="classproxygen_1_1compress_1_1CompressionScheme.html#a2a356966d15ef97cdda9c121985f84dd">proxygen::compress::CompressionScheme::prev</a></div><div class="ttdeci">std::chrono::milliseconds prev</div><div class="ttdef"><b>Definition:</b> <a href="CompressionScheme_8h_source.html#l00076">CompressionScheme.h:76</a></div></div>
<div class="ttc" id="HPACKBenchmark_8cpp_html_a860e4ea0c5704e11bd4caccf4a64180f"><div class="ttname"><a href="HPACKBenchmark_8cpp.html#a860e4ea0c5704e11bd4caccf4a64180f">encode</a></div><div class="ttdeci">unique_ptr&lt; IOBuf &gt; encode(vector&lt; HPACKHeader &gt; &amp;headers, HPACKEncoder &amp;encoder)</div><div class="ttdef"><b>Definition:</b> <a href="HPACKBenchmark_8cpp_source.html#l00022">HPACKBenchmark.cpp:22</a></div></div>
<div class="ttc" id="classproxygen_1_1compress_1_1CompressionScheme_html_af6fb1e0f08c33671a116f4fe85d4ebe1"><div class="ttname"><a href="classproxygen_1_1compress_1_1CompressionScheme.html#af6fb1e0f08c33671a116f4fe85d4ebe1">proxygen::compress::CompressionScheme::packetBlocks</a></div><div class="ttdeci">std::list&lt; BlockInfo &gt; packetBlocks</div><div class="ttdef"><b>Definition:</b> <a href="CompressionScheme_8h_source.html#l00070">CompressionScheme.h:70</a></div></div>
<div class="ttc" id="CompressionUtils_8h_html"><div class="ttname"><a href="CompressionUtils_8h.html">CompressionUtils.h</a></div></div>
<div class="ttc" id="classproxygen_1_1compress_1_1CompressionScheme_html_a8b5b9dbfd8f08e0dfdc6415e7432ddbf"><div class="ttname"><a href="classproxygen_1_1compress_1_1CompressionScheme.html#a8b5b9dbfd8f08e0dfdc6415e7432ddbf">proxygen::compress::CompressionScheme::recvAck</a></div><div class="ttdeci">virtual void recvAck(std::unique_ptr&lt; Ack &gt;)=0</div></div>
<div class="ttc" id="Time_8h_html"><div class="ttname"><a href="Time_8h.html">Time.h</a></div></div>
<div class="ttc" id="classproxygen_1_1compress_1_1CompressionScheme_html_a4e013945112c438374a2cb99eb753d67"><div class="ttname"><a href="classproxygen_1_1compress_1_1CompressionScheme.html#a4e013945112c438374a2cb99eb753d67">proxygen::compress::CompressionScheme::encode</a></div><div class="ttdeci">virtual std::pair&lt; FrameFlags, std::unique_ptr&lt; folly::IOBuf &gt; &gt; encode(bool newPacket, std::vector&lt; compress::Header &gt; allHeaders, SimStats &amp;stats)=0</div></div>
<div class="ttc" id="namespacestd_html"><div class="ttname"><a href="namespacestd.html">std</a></div><div class="ttdoc">STL namespace. </div></div>
<div class="ttc" id="classproxygen_1_1compress_1_1CompressionScheme_html_a4f71fa1ca3db61ad6b7aa4a078bb8b76"><div class="ttname"><a href="classproxygen_1_1compress_1_1CompressionScheme.html#a4f71fa1ca3db61ad6b7aa4a078bb8b76">proxygen::compress::CompressionScheme::packetBytes</a></div><div class="ttdeci">size_t packetBytes</div><div class="ttdef"><b>Definition:</b> <a href="CompressionScheme_8h_source.html#l00078">CompressionScheme.h:78</a></div></div>
<div class="ttc" id="namespacefolly_html"><div class="ttname"><a href="namespacefolly.html">folly</a></div><div class="ttdef"><b>Definition:</b> <a href="HeaderCodec_8h_source.html#l00020">HeaderCodec.h:20</a></div></div>
<div class="ttc" id="namespaceproxygen_1_1compress_html_a87be4e4c674336304ac9c82b0e244685"><div class="ttname"><a href="namespaceproxygen_1_1compress.html#a87be4e4c674336304ac9c82b0e244685">proxygen::compress::prepareMessageForCompression</a></div><div class="ttdeci">std::vector&lt; compress::Header &gt; prepareMessageForCompression(const HTTPMessage &amp;msg, std::vector&lt; string &gt; &amp;cookies)</div><div class="ttdef"><b>Definition:</b> <a href="CompressionUtils_8cpp_source.html#l00083">CompressionUtils.cpp:83</a></div></div>
<div class="ttc" id="QMINScheme_8h_html"><div class="ttname"><a href="QMINScheme_8h.html">QMINScheme.h</a></div></div>
<div class="ttc" id="classproxygen_1_1HTTPMessage_html_ad50401dd7754119846424e9b26434976"><div class="ttname"><a href="classproxygen_1_1HTTPMessage.html#ad50401dd7754119846424e9b26434976">proxygen::HTTPMessage::getStartTime</a></div><div class="ttdeci">TimePoint getStartTime() const </div><div class="ttdef"><b>Definition:</b> <a href="HTTPMessage_8h_source.html#l00629">HTTPMessage.h:629</a></div></div>
<div class="ttc" id="namespaceproxygen_1_1compress_html"><div class="ttname"><a href="namespaceproxygen_1_1compress.html">proxygen::compress</a></div><div class="ttdef"><b>Definition:</b> <a href="CompressionScheme_8h_source.html#l00016">CompressionScheme.h:16</a></div></div>
<div class="ttc" id="CompressionSimulator_8h_html"><div class="ttname"><a href="CompressionSimulator_8h.html">CompressionSimulator.h</a></div></div>
<div class="ttc" id="classproxygen_1_1compress_1_1CompressionScheme_html_a625e785dd8c5fa8aa84d686739d604ec"><div class="ttname"><a href="classproxygen_1_1compress_1_1CompressionScheme.html#a625e785dd8c5fa8aa84d686739d604ec">proxygen::compress::CompressionScheme::packetIndices</a></div><div class="ttdeci">std::list&lt; uint16_t &gt; packetIndices</div><div class="ttdef"><b>Definition:</b> <a href="CompressionScheme_8h_source.html#l00081">CompressionScheme.h:81</a></div></div>
<div class="ttc" id="namespaceproxygen_html_ab18179a16a0bebed81cf3f62dff11064abb1ca97ec761fc37101737ba0aa2e7c5"><div class="ttname"><a href="namespaceproxygen.html#ab18179a16a0bebed81cf3f62dff11064abb1ca97ec761fc37101737ba0aa2e7c5">proxygen::ZstdStatusType::ERROR</a></div></div>
<div class="ttc" id="classproxygen_1_1compress_1_1SimStreamingCallback_html"><div class="ttname"><a href="classproxygen_1_1compress_1_1SimStreamingCallback.html">proxygen::compress::SimStreamingCallback</a></div><div class="ttdef"><b>Definition:</b> <a href="SimStreamingCallback_8h_source.html#l00019">SimStreamingCallback.h:19</a></div></div>
<div class="ttc" id="namespaceproxygen_html_ab1ccd825f69c99dd89b92765687b8d27"><div class="ttname"><a href="namespaceproxygen.html#ab1ccd825f69c99dd89b92765687b8d27">proxygen::TimePoint</a></div><div class="ttdeci">SteadyClock::time_point TimePoint</div><div class="ttdef"><b>Definition:</b> <a href="Time_8h_source.html#l00025">Time.h:25</a></div></div>
<div class="ttc" id="namespaceproxygen_1_1hpack_html_aa061a948252af0d148d16d87f86d1872"><div class="ttname"><a href="namespaceproxygen_1_1hpack.html#aa061a948252af0d148d16d87f86d1872">proxygen::hpack::decode</a></div><div class="ttdeci">unique_ptr&lt; HPACKDecoder::headers_t &gt; decode(HPACKDecoder &amp;decoder, const IOBuf *buffer)</div><div class="ttdef"><b>Definition:</b> <a href="TestUtil_8cpp_source.html#l00095">TestUtil.cpp:95</a></div></div>
<div class="ttc" id="classproxygen_1_1compress_1_1CompressionScheme_html"><div class="ttname"><a href="classproxygen_1_1compress_1_1CompressionScheme.html">proxygen::compress::CompressionScheme</a></div><div class="ttdef"><b>Definition:</b> <a href="CompressionScheme_8h_source.html#l00020">CompressionScheme.h:20</a></div></div>
<div class="ttc" id="classproxygen_1_1compress_1_1CompressionScheme_html_a7941a48e560dae88e07d62943dc4da7a"><div class="ttname"><a href="classproxygen_1_1compress_1_1CompressionScheme.html#a7941a48e560dae88e07d62943dc4da7a">proxygen::compress::CompressionScheme::decodeDelay</a></div><div class="ttdeci">std::chrono::milliseconds decodeDelay</div><div class="ttdef"><b>Definition:</b> <a href="CompressionScheme_8h_source.html#l00079">CompressionScheme.h:79</a></div></div>
<div class="ttc" id="classproxygen_1_1compress_1_1CompressionScheme_html_ac5ddabc82889df4797e1e869dc32e4e2"><div class="ttname"><a href="classproxygen_1_1compress_1_1CompressionScheme.html#ac5ddabc82889df4797e1e869dc32e4e2">proxygen::compress::CompressionScheme::decode</a></div><div class="ttdeci">virtual void decode(FrameFlags flags, std::unique_ptr&lt; folly::IOBuf &gt; encodedReq, SimStats &amp;stats, SimStreamingCallback &amp;cb)=0</div></div>
<div class="ttc" id="classproxygen_1_1compress_1_1CompressionScheme_html_ab9712b0de439245609196d02570ae20e"><div class="ttname"><a href="classproxygen_1_1compress_1_1CompressionScheme.html#ab9712b0de439245609196d02570ae20e">proxygen::compress::CompressionScheme::encodedBlocks</a></div><div class="ttdeci">std::list&lt; BlockInfo &gt; encodedBlocks</div><div class="ttdef"><b>Definition:</b> <a href="CompressionScheme_8h_source.html#l00068">CompressionScheme.h:68</a></div></div>
<div class="ttc" id="utils_2TestUtils_8h_html"><div class="ttname"><a href="utils_2TestUtils_8h.html">TestUtils.h</a></div></div>
<div class="ttc" id="namespaceproxygen_html"><div class="ttname"><a href="namespaceproxygen.html">proxygen</a></div><div class="ttdef"><b>Definition:</b> <a href="ExMessageHandler_8h_source.html#l00014">ExMessageHandler.h:14</a></div></div>
<div class="ttc" id="structproxygen_1_1compress_1_1FrameFlags_html"><div class="ttname"><a href="structproxygen_1_1compress_1_1FrameFlags.html">proxygen::compress::FrameFlags</a></div><div class="ttdef"><b>Definition:</b> <a href="CompressionTypes_8h_source.html#l00019">CompressionTypes.h:19</a></div></div>
<div class="ttc" id="classproxygen_1_1HTTPArchive_html_a3b0e159ff83d50caf77b1dd29dd3c868"><div class="ttname"><a href="classproxygen_1_1HTTPArchive.html#a3b0e159ff83d50caf77b1dd29dd3c868">proxygen::HTTPArchive::requests</a></div><div class="ttdeci">std::vector&lt; HTTPMessage &gt; requests</div><div class="ttdef"><b>Definition:</b> <a href="HTTPArchive_8h_source.html#l00024">HTTPArchive.h:24</a></div></div>
<div class="ttc" id="classproxygen_1_1HTTPMessage_html"><div class="ttname"><a href="classproxygen_1_1HTTPMessage.html">proxygen::HTTPMessage</a></div><div class="ttdef"><b>Definition:</b> <a href="HTTPMessage_8h_source.html#l00039">HTTPMessage.h:39</a></div></div>
<div class="ttc" id="HTTPArchive_8h_html"><div class="ttname"><a href="HTTPArchive_8h.html">HTTPArchive.h</a></div></div>
<div class="ttc" id="HPACKScheme_8h_html"><div class="ttname"><a href="HPACKScheme_8h.html">HPACKScheme.h</a></div></div>
<div class="ttc" id="utils_2TestUtils_8h_html_af8eec91e411dbb6899c8554284c9971d"><div class="ttname"><a href="utils_2TestUtils_8h.html#af8eec91e411dbb6899c8554284c9971d">getContainingDirectory</a></div><div class="ttdeci">folly::StringPiece getContainingDirectory(folly::StringPiece input)</div><div class="ttdef"><b>Definition:</b> <a href="utils_2TestUtils_8h_source.html#l00033">TestUtils.h:33</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_d333e33cf903653326082c1f32e03be5.html">proxygen</a></li><li class="navelem"><a class="el" href="dir_baa8b6fadb61b56c035914fe171fd962.html">lib</a></li><li class="navelem"><a class="el" href="dir_bf1b8217360450c8f2328843af490dd2.html">http</a></li><li class="navelem"><a class="el" href="dir_f30caabe577ba4a66bd56f7edcb2a3d8.html">codec</a></li><li class="navelem"><a class="el" href="dir_5b6b83f02e88647fa33e02dfd197e4dd.html">compress</a></li><li class="navelem"><a class="el" href="dir_59bd631e86ca68933504f30adc832f18.html">experimental</a></li><li class="navelem"><a class="el" href="dir_bae065f780e12528891a1684866ce1ab.html">simulator</a></li><li class="navelem"><a class="el" href="CompressionSimulator_8cpp.html">CompressionSimulator.cpp</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
