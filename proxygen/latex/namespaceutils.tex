\section{utils Namespace Reference}
\label{namespaceutils}\index{utils@{utils}}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
def {\bf recursively\+\_\+flatten\+\_\+list} (l)
\item 
def {\bf run\+\_\+command} (cmd, kwargs)
\item 
def {\bf make\+\_\+temp\+\_\+dir} (d)
\item 
def {\bf \+\_\+inner\+\_\+read\+\_\+config} (path)
\item 
def {\bf read\+\_\+fbcode\+\_\+builder\+\_\+config} (filename)
\item 
def {\bf steps\+\_\+for\+\_\+spec} (builder, spec, processed\+\_\+modules=None)
\item 
def {\bf build\+\_\+fbcode\+\_\+builder\+\_\+config} (config)
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\index{utils@{utils}!\+\_\+inner\+\_\+read\+\_\+config@{\+\_\+inner\+\_\+read\+\_\+config}}
\index{\+\_\+inner\+\_\+read\+\_\+config@{\+\_\+inner\+\_\+read\+\_\+config}!utils@{utils}}
\subsubsection[{\+\_\+inner\+\_\+read\+\_\+config(path)}]{\setlength{\rightskip}{0pt plus 5cm}def utils.\+\_\+inner\+\_\+read\+\_\+config (
\begin{DoxyParamCaption}
\item[{}]{path}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [private]}}\label{namespaceutils_a0ba51e26b995494d933a498f659820ca}
\begin{DoxyVerb}Helper to read a named config file.
The grossness with the global is a workaround for this python bug:
https://bugs.python.org/issue21591
The bug prevents us from defining either a local function or a lambda
in the scope of read_fbcode_builder_config below.
\end{DoxyVerb}
 

Definition at line 42 of file utils.\+py.



References read\+\_\+fbcode\+\_\+builder\+\_\+config().


\begin{DoxyCode}
42 \textcolor{keyword}{def }_inner_read_config(path):
43     \textcolor{stringliteral}{'''}
44 \textcolor{stringliteral}{    Helper to read a named config file.}
45 \textcolor{stringliteral}{    The grossness with the global is a workaround for this python bug:}
46 \textcolor{stringliteral}{    https://bugs.python.org/issue21591}
47 \textcolor{stringliteral}{    The bug prevents us from defining either a local function or a lambda}
48 \textcolor{stringliteral}{    in the scope of read\_fbcode\_builder\_config below.}
49 \textcolor{stringliteral}{    '''}
50     \textcolor{keyword}{global} \_project\_dir
51     full\_path = os.path.join(\_project\_dir, path)
52     \textcolor{keywordflow}{return} read_fbcode_builder_config(full\_path)
53 
54 
\end{DoxyCode}
\index{utils@{utils}!build\+\_\+fbcode\+\_\+builder\+\_\+config@{build\+\_\+fbcode\+\_\+builder\+\_\+config}}
\index{build\+\_\+fbcode\+\_\+builder\+\_\+config@{build\+\_\+fbcode\+\_\+builder\+\_\+config}!utils@{utils}}
\subsubsection[{build\+\_\+fbcode\+\_\+builder\+\_\+config(config)}]{\setlength{\rightskip}{0pt plus 5cm}def utils.\+build\+\_\+fbcode\+\_\+builder\+\_\+config (
\begin{DoxyParamCaption}
\item[{}]{config}
\end{DoxyParamCaption}
)}\label{namespaceutils_aa9d6bd65b30c0f28220950775b7717e1}


Definition at line 93 of file utils.\+py.



References steps\+\_\+for\+\_\+spec().


\begin{DoxyCode}
93 \textcolor{keyword}{def }build_fbcode_builder_config(config):
94     \textcolor{keywordflow}{return} \textcolor{keyword}{lambda} builder: builder.build(
95         steps_for_spec(builder, config[\textcolor{stringliteral}{'fbcode\_builder\_spec'}](builder))
96     )
97 \end{DoxyCode}
\index{utils@{utils}!make\+\_\+temp\+\_\+dir@{make\+\_\+temp\+\_\+dir}}
\index{make\+\_\+temp\+\_\+dir@{make\+\_\+temp\+\_\+dir}!utils@{utils}}
\subsubsection[{make\+\_\+temp\+\_\+dir(d)}]{\setlength{\rightskip}{0pt plus 5cm}def utils.\+make\+\_\+temp\+\_\+dir (
\begin{DoxyParamCaption}
\item[{}]{d}
\end{DoxyParamCaption}
)}\label{namespaceutils_a15ff4620a052007b58cb914afdccffe7}


Definition at line 34 of file utils.\+py.


\begin{DoxyCode}
34 \textcolor{keyword}{def }make_temp_dir(d):
35     os.mkdir(d)
36     \textcolor{keywordflow}{try}:
37         \textcolor{keywordflow}{yield} d
38     \textcolor{keywordflow}{finally}:
39         shutil.rmtree(d, ignore\_errors=\textcolor{keyword}{True})
40 
41 
\end{DoxyCode}
\index{utils@{utils}!read\+\_\+fbcode\+\_\+builder\+\_\+config@{read\+\_\+fbcode\+\_\+builder\+\_\+config}}
\index{read\+\_\+fbcode\+\_\+builder\+\_\+config@{read\+\_\+fbcode\+\_\+builder\+\_\+config}!utils@{utils}}
\subsubsection[{read\+\_\+fbcode\+\_\+builder\+\_\+config(filename)}]{\setlength{\rightskip}{0pt plus 5cm}def utils.\+read\+\_\+fbcode\+\_\+builder\+\_\+config (
\begin{DoxyParamCaption}
\item[{}]{filename}
\end{DoxyParamCaption}
)}\label{namespaceutils_a5a264ca572108fe7f965f712108ba39a}


Definition at line 55 of file utils.\+py.



Referenced by \+\_\+inner\+\_\+read\+\_\+config().


\begin{DoxyCode}
55 \textcolor{keyword}{def }read_fbcode_builder_config(filename):
56     \textcolor{comment}{# Allow one spec to read another}
57     \textcolor{comment}{# When doing so, treat paths as relative to the config's project directory.}
58     \textcolor{comment}{# \_project\_dir is a "local" for \_inner\_read\_config; see the comments}
59     \textcolor{comment}{# in that function for an explanation of the use of global.}
60     \textcolor{keyword}{global} \_project\_dir
61     \_project\_dir = os.path.dirname(filename)
62 
63     scope = \{\textcolor{stringliteral}{'read\_fbcode\_builder\_config'}: \_inner\_read\_config\}
64     with open(filename) \textcolor{keyword}{as} config\_file:
65         code = compile(config\_file.read(), filename, mode=\textcolor{stringliteral}{'exec'})
66     exec(code, scope)
67     \textcolor{keywordflow}{return} scope[\textcolor{stringliteral}{'config'}]
68 
69 
\end{DoxyCode}
\index{utils@{utils}!recursively\+\_\+flatten\+\_\+list@{recursively\+\_\+flatten\+\_\+list}}
\index{recursively\+\_\+flatten\+\_\+list@{recursively\+\_\+flatten\+\_\+list}!utils@{utils}}
\subsubsection[{recursively\+\_\+flatten\+\_\+list(l)}]{\setlength{\rightskip}{0pt plus 5cm}def utils.\+recursively\+\_\+flatten\+\_\+list (
\begin{DoxyParamCaption}
\item[{}]{l}
\end{DoxyParamCaption}
)}\label{namespaceutils_a20307e321cde826f76af488224f32d7e}


Definition at line 19 of file utils.\+py.



Referenced by shell\+\_\+builder.\+Shell\+F\+B\+Code\+Builder.\+\_\+render\+\_\+impl(), and docker\+\_\+builder.\+Docker\+F\+B\+Code\+Builder.\+\_\+render\+\_\+impl().


\begin{DoxyCode}
19 \textcolor{keyword}{def }recursively_flatten_list(l):
20     \textcolor{keywordflow}{return} itertools.chain.from\_iterable(
21         (recursively_flatten_list(i) \textcolor{keywordflow}{if} type(i) \textcolor{keywordflow}{is} list \textcolor{keywordflow}{else} (i,))
22             \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} l
23     )
24 
25 
\end{DoxyCode}
\index{utils@{utils}!run\+\_\+command@{run\+\_\+command}}
\index{run\+\_\+command@{run\+\_\+command}!utils@{utils}}
\subsubsection[{run\+\_\+command(cmd, kwargs)}]{\setlength{\rightskip}{0pt plus 5cm}def utils.\+run\+\_\+command (
\begin{DoxyParamCaption}
\item[{}]{cmd, }
\item[{}]{kwargs}
\end{DoxyParamCaption}
)}\label{namespaceutils_a0fafd8f7d1ad58f7367cd430ce27bb10}


Definition at line 26 of file utils.\+py.



Referenced by docker\+\_\+builder.\+Docker\+F\+B\+Code\+Builder.\+copy\+\_\+local\+\_\+repo().


\begin{DoxyCode}
26 \textcolor{keyword}{def }run_command(*cmd, **kwargs):
27     \textcolor{stringliteral}{'The stdout of most fbcode\_builder utilities is meant to be parsed.'}
28     logging.debug(\textcolor{stringliteral}{'Running: \{0\} with \{1\}'}.format(cmd, kwargs))
29     kwargs[\textcolor{stringliteral}{'stdout'}] = sys.stderr
30     subprocess.check\_call(cmd, **kwargs)
31 
32 
33 @contextmanager
\end{DoxyCode}
\index{utils@{utils}!steps\+\_\+for\+\_\+spec@{steps\+\_\+for\+\_\+spec}}
\index{steps\+\_\+for\+\_\+spec@{steps\+\_\+for\+\_\+spec}!utils@{utils}}
\subsubsection[{steps\+\_\+for\+\_\+spec(builder, spec, processed\+\_\+modules=\+None)}]{\setlength{\rightskip}{0pt plus 5cm}def utils.\+steps\+\_\+for\+\_\+spec (
\begin{DoxyParamCaption}
\item[{}]{builder, }
\item[{}]{spec, }
\item[{}]{processed\+\_\+modules = {\ttfamily None}}
\end{DoxyParamCaption}
)}\label{namespaceutils_a9cd003d8e745e24c14af21bb154660f0}
\begin{DoxyVerb}Sets `builder` configuration, and returns all the builder steps
necessary to build `spec` and its dependencies.

Traverses the dependencies in depth-first order, honoring the sequencing
in each 'depends_on' list.
\end{DoxyVerb}
 

Definition at line 70 of file utils.\+py.



Referenced by build\+\_\+fbcode\+\_\+builder\+\_\+config().


\begin{DoxyCode}
70 \textcolor{keyword}{def }steps_for_spec(builder, spec, processed\_modules=None):
71     \textcolor{stringliteral}{'''}
72 \textcolor{stringliteral}{    Sets `builder` configuration, and returns all the builder steps}
73 \textcolor{stringliteral}{    necessary to build `spec` and its dependencies.}
74 \textcolor{stringliteral}{}
75 \textcolor{stringliteral}{    Traverses the dependencies in depth-first order, honoring the sequencing}
76 \textcolor{stringliteral}{    in each 'depends\_on' list.}
77 \textcolor{stringliteral}{    '''}
78     \textcolor{keywordflow}{if} processed\_modules \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
79         processed\_modules = set()
80     steps = []
81     \textcolor{keywordflow}{for} module \textcolor{keywordflow}{in} spec.get(\textcolor{stringliteral}{'depends\_on'}, []):
82         \textcolor{keywordflow}{if} module \textcolor{keywordflow}{not} \textcolor{keywordflow}{in} processed\_modules:
83             processed\_modules.add(module)
84             steps.extend(steps_for_spec(
85                 builder,
86                 module.fbcode\_builder\_spec(builder),
87                 processed\_modules
88             ))
89     steps.extend(spec.get(\textcolor{stringliteral}{'steps'}, []))
90     \textcolor{keywordflow}{return} steps
91 
92 
\end{DoxyCode}
