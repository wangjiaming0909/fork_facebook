\section{proxygen/lib/http/session/test/\+H\+T\+T\+P\+Downstream\+Session\+Test.cpp File Reference}
\label{HTTPDownstreamSessionTest_8cpp}\index{proxygen/lib/http/session/test/\+H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{proxygen/lib/http/session/test/\+H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
{\ttfamily \#include $<$string$>$}\\*
{\ttfamily \#include $<$vector$>$}\\*
{\ttfamily \#include $<$folly/\+Conv.\+h$>$}\\*
{\ttfamily \#include $<$folly/\+Range.\+h$>$}\\*
{\ttfamily \#include $<$folly/futures/\+Promise.\+h$>$}\\*
{\ttfamily \#include $<$folly/io/\+Cursor.\+h$>$}\\*
{\ttfamily \#include $<$folly/io/async/\+Event\+Base.\+h$>$}\\*
{\ttfamily \#include $<$folly/io/async/\+Event\+Base\+Manager.\+h$>$}\\*
{\ttfamily \#include $<$folly/io/async/\+Timeout\+Manager.\+h$>$}\\*
{\ttfamily \#include $<$folly/io/async/test/\+Mock\+Async\+Transport.\+h$>$}\\*
{\ttfamily \#include $<$folly/portability/\+G\+Test.\+h$>$}\\*
{\ttfamily \#include $<$proxygen/lib/http/codec/\+H\+T\+T\+P\+Codec\+Factory.\+h$>$}\\*
{\ttfamily \#include $<$proxygen/lib/http/codec/test/\+Test\+Utils.\+h$>$}\\*
{\ttfamily \#include $<$proxygen/lib/http/session/\+H\+T\+T\+P\+Direct\+Response\+Handler.\+h$>$}\\*
{\ttfamily \#include $<$proxygen/lib/http/session/\+H\+T\+T\+P\+Downstream\+Session.\+h$>$}\\*
{\ttfamily \#include $<$proxygen/lib/http/session/\+H\+T\+T\+P\+Session.\+h$>$}\\*
{\ttfamily \#include $<$proxygen/lib/http/session/test/\+H\+T\+T\+P\+Session\+Mocks.\+h$>$}\\*
{\ttfamily \#include $<$proxygen/lib/http/session/test/\+H\+T\+T\+P\+Session\+Test.\+h$>$}\\*
{\ttfamily \#include $<$proxygen/lib/http/session/test/\+Mock\+Byte\+Event\+Tracker.\+h$>$}\\*
{\ttfamily \#include $<$proxygen/lib/http/session/test/\+Test\+Utils.\+h$>$}\\*
{\ttfamily \#include $<$proxygen/lib/test/\+Test\+Async\+Transport.\+h$>$}\\*
{\ttfamily \#include $<$wangle/acceptor/\+Connection\+Manager.\+h$>$}\\*
\subsection*{Classes}
\begin{DoxyCompactItemize}
\item 
class {\bf H\+T\+T\+P\+Downstream\+Test$<$ C $>$}
\item 
class {\bf H\+T\+T\+P\+Downstream\+Session\+Upgrade\+Flow\+Control\+Test}
\item 
class {\bf S\+P\+D\+Y31\+Downstream\+Test}
\end{DoxyCompactItemize}
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define {\bf I\+F\+\_\+\+H\+T\+T\+P2}(X)~if (this-\/$>$client\+Codec\+\_\+-\/$>$get\+Protocol() == Codec\+Protocol\+::\+H\+T\+T\+P\+\_\+2) \{ X; \}
\end{DoxyCompactItemize}
\subsection*{Typedefs}
\begin{DoxyCompactItemize}
\item 
using {\bf H\+T\+T\+P\+Downstream\+Session\+Test} = {\bf H\+T\+T\+P\+Downstream\+Test}$<$ {\bf H\+T\+T\+P1x\+Codec\+Pair} $>$
\item 
using {\bf S\+P\+D\+Y3\+Downstream\+Session\+Test} = {\bf H\+T\+T\+P\+Downstream\+Test}$<$ {\bf S\+P\+D\+Y3\+Codec\+Pair} $>$
\item 
typedef \+::testing\+::\+Types$<$ {\bf S\+P\+D\+Y3\+Codec\+Pair}, {\bf S\+P\+D\+Y3\+\_\+1\+Codec\+Pair}, {\bf H\+T\+T\+P2\+Codec\+Pair} $>$ {\bf Parallel\+Codecs}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Early\+Shutdown\+Test, Early\+Shutdown)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Immediate\+Eof)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http10\+No\+Headers)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http10\+No\+Headers\+Eof)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Single\+Bytes)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Single\+Bytes\+With\+Body)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Split\+Body)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Post\+Chunked)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Multi\+Message)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Connect)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Connect\+Rejected)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Upgrade)
\item 
{\bf T\+E\+ST} ({\bf H\+T\+T\+P\+Downstream\+Test}, Parse\+Error\+No\+Txn)
\item 
{\bf T\+E\+ST} ({\bf H\+T\+T\+P\+Downstream\+Test}, Byte\+Events\+Drained)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+With\+Ack\+Timing)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Test\+On\+Content\+Mismatch)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+With\+Ack\+Timing\+Pipeline)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Exheader\+From\+Server)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Exheader\+From\+Client)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Unidirectional\+Ex\+Transaction)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Pause\+Resume\+Control\+Stream)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Invalid\+Control\+Stream)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Set\+Byte\+Event\+Tracker)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Test\+Tracked\+Byte\+Event\+Tracker)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Trailers)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Trailers)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Explicit\+Chunks)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Drain)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Drain\+Long\+Running)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Early\+Abort)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf S\+P\+D\+Y3\+Downstream\+Session\+Test}, Http\+Paused\+Buffered)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Writes\+Draining\+Timeout)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Rate\+Limit\+Normal)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf S\+P\+D\+Y3\+Downstream\+Session\+Test}, Spdy\+Rate\+Limit\+Normal)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf S\+P\+D\+Y3\+Downstream\+Session\+Test}, Spdy\+Rate\+Limit\+Rst)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Write\+Timeout)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Write\+Timeout\+Pipeline)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Body\+Packetization)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Malformed\+Pkt1)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Big\+Explcit\+Chunk\+Write)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Upgrade\+Non\+Native)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Upgrade\+Non\+Native\+Ignore)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Upgrade\+Non\+Native\+Pipeline)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Upgrade\+Native3)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Upgrade\+Native31)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Upgrade\+Native\+H2)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Upgrade\+Flow\+Control\+Test}, Upgrade\+H2\+Flowcontrol)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Upgrade\+Native\+Unknown)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Upgrade\+Native\+Whitespace)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Upgrade\+Native\+Junk)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Upgrade\+Native\+Txn2)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Upgrade\+Native\+Post)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Upgrade\+Native\+Post\+Early\+Resp)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Upgrade\+Native\+Post\+Early\+Partial\+Resp)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Upgrade\+Native\+Extra)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Upgrade\+Native\+Post100)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Upgrade\+Native\+Post100\+Late)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf S\+P\+D\+Y3\+Downstream\+Session\+Test}, Spdy\+Prio)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Upgrade\+Goaway\+Drain)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf S\+P\+D\+Y3\+Downstream\+Session\+Test}, Spdy\+Timeout)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf S\+P\+D\+Y3\+Downstream\+Session\+Test}, Spdy\+Timeout\+Win)
\item 
{\bf T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+P} ({\bf H\+T\+T\+P\+Downstream\+Test})
\item 
{\bf T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P} ({\bf H\+T\+T\+P\+Downstream\+Test}, Test\+Writes\+Draining)
\item 
{\bf T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P} ({\bf H\+T\+T\+P\+Downstream\+Test}, Test\+Body\+Size\+Limit)
\item 
{\bf T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P} ({\bf H\+T\+T\+P\+Downstream\+Test}, Test\+Uniform\+Pause\+State)
\item 
{\bf T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P} ({\bf H\+T\+T\+P\+Downstream\+Test}, Test\+Max\+Txns)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf S\+P\+D\+Y3\+Downstream\+Session\+Test}, Spdy\+Max\+Concurrent\+Streams)
\item 
{\bf R\+E\+G\+I\+S\+T\+E\+R\+\_\+\+T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+P} ({\bf H\+T\+T\+P\+Downstream\+Test}, Test\+Writes\+Draining, Test\+Body\+Size\+Limit, Test\+Uniform\+Pause\+State, Test\+Max\+Txns)
\item 
{\bf I\+N\+S\+T\+A\+N\+T\+I\+A\+T\+E\+\_\+\+T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+P} ({\bf Parallel\+Codecs}, {\bf H\+T\+T\+P\+Downstream\+Test}, {\bf Parallel\+Codecs})
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf S\+P\+D\+Y31\+Downstream\+Test}, Test\+Session\+Flow\+Control)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf S\+P\+D\+Y3\+Downstream\+Session\+Test}, Test\+E\+O\+F\+On\+Blocked\+Stream)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf S\+P\+D\+Y31\+Downstream\+Test}, Test\+E\+O\+F\+On\+Blocked\+Session)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf S\+P\+D\+Y3\+Downstream\+Session\+Test}, New\+Txn\+Egress\+Paused)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Zero\+Delta\+Window\+Update)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Padding\+Flow\+Control)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Graceful\+Drain\+On\+Timeout)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Server\+Push)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Server\+Push\+Abort\+Paused)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Priority\+Weights\+Tiny\+Ratio)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Priority\+Dependent\+Transactions)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Disable\+Priorities)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Priority\+Weights)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Priority\+Weights\+Tiny\+Window)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Short\+Content\+Length)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Bad\+Content\+Length\+Untie\+Handler)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Long\+Content\+Length)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Malformed\+Content\+Length)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Head\+Content\+Length)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Test304\+Content\+Length)
\item 
{\bf T\+E\+S\+T\+\_\+F} ({\bf H\+T\+T\+P\+Downstream\+Session\+Test}, Http\+Short\+Content\+Length)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Session\+Stall\+By\+Flow\+Control)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Transaction\+Stall\+By\+Flow\+Control)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Transaction\+Not\+Stall\+By\+Flow\+Control)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Set\+Egress\+Settings)
\item 
{\bf T\+E\+S\+T\+\_\+F} (H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Duplicate\+Request\+Stream)
\end{DoxyCompactItemize}


\subsection{Macro Definition Documentation}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!I\+F\+\_\+\+H\+T\+T\+P2@{I\+F\+\_\+\+H\+T\+T\+P2}}
\index{I\+F\+\_\+\+H\+T\+T\+P2@{I\+F\+\_\+\+H\+T\+T\+P2}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{I\+F\+\_\+\+H\+T\+T\+P2}]{\setlength{\rightskip}{0pt plus 5cm}\#define I\+F\+\_\+\+H\+T\+T\+P2(
\begin{DoxyParamCaption}
\item[{}]{X}
\end{DoxyParamCaption}
)~if (this-\/$>$client\+Codec\+\_\+-\/$>$get\+Protocol() == Codec\+Protocol\+::\+H\+T\+T\+P\+\_\+2) \{ X; \}}\label{HTTPDownstreamSessionTest_8cpp_a88caf1ca6b45d98e375adb872bcf9aba}


Definition at line 2363 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



Referenced by T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+P().



\subsection{Typedef Documentation}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!H\+T\+T\+P\+Downstream\+Session\+Test@{H\+T\+T\+P\+Downstream\+Session\+Test}}
\index{H\+T\+T\+P\+Downstream\+Session\+Test@{H\+T\+T\+P\+Downstream\+Session\+Test}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{H\+T\+T\+P\+Downstream\+Session\+Test}]{\setlength{\rightskip}{0pt plus 5cm}using {\bf H\+T\+T\+P\+Downstream\+Session\+Test} =  {\bf H\+T\+T\+P\+Downstream\+Test}$<${\bf H\+T\+T\+P1x\+Codec\+Pair}$>$}\label{HTTPDownstreamSessionTest_8cpp_ae0d77e30fbdab8843b56a9f0f72f43c1}


Definition at line 436 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.

\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!Parallel\+Codecs@{Parallel\+Codecs}}
\index{Parallel\+Codecs@{Parallel\+Codecs}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{Parallel\+Codecs}]{\setlength{\rightskip}{0pt plus 5cm}typedef \+::testing\+::\+Types$<${\bf S\+P\+D\+Y3\+Codec\+Pair}, {\bf S\+P\+D\+Y3\+\_\+1\+Codec\+Pair}, {\bf H\+T\+T\+P2\+Codec\+Pair}$>$ {\bf Parallel\+Codecs}}\label{HTTPDownstreamSessionTest_8cpp_af0b81987bd33a6dd7378d0bb158decc5}


Definition at line 2521 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.

\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!S\+P\+D\+Y3\+Downstream\+Session\+Test@{S\+P\+D\+Y3\+Downstream\+Session\+Test}}
\index{S\+P\+D\+Y3\+Downstream\+Session\+Test@{S\+P\+D\+Y3\+Downstream\+Session\+Test}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{S\+P\+D\+Y3\+Downstream\+Session\+Test}]{\setlength{\rightskip}{0pt plus 5cm}using {\bf S\+P\+D\+Y3\+Downstream\+Session\+Test} =  {\bf H\+T\+T\+P\+Downstream\+Test}$<${\bf S\+P\+D\+Y3\+Codec\+Pair}$>$}\label{HTTPDownstreamSessionTest_8cpp_aac8edc0f5d8a69779e3461ec3c8e993d}


Definition at line 437 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



\subsection{Function Documentation}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!I\+N\+S\+T\+A\+N\+T\+I\+A\+T\+E\+\_\+\+T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+P@{I\+N\+S\+T\+A\+N\+T\+I\+A\+T\+E\+\_\+\+T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+P}}
\index{I\+N\+S\+T\+A\+N\+T\+I\+A\+T\+E\+\_\+\+T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+P@{I\+N\+S\+T\+A\+N\+T\+I\+A\+T\+E\+\_\+\+T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+P}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{I\+N\+S\+T\+A\+N\+T\+I\+A\+T\+E\+\_\+\+T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+\+P(\+Parallel\+Codecs, H\+T\+T\+P\+Downstream\+Test, Parallel\+Codecs)}]{\setlength{\rightskip}{0pt plus 5cm}I\+N\+S\+T\+A\+N\+T\+I\+A\+T\+E\+\_\+\+T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+P (
\begin{DoxyParamCaption}
\item[{{\bf Parallel\+Codecs}}]{, }
\item[{{\bf H\+T\+T\+P\+Downstream\+Test}}]{, }
\item[{{\bf Parallel\+Codecs}}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a52fe314136f029b849018cea6a049fa7}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!R\+E\+G\+I\+S\+T\+E\+R\+\_\+\+T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+P@{R\+E\+G\+I\+S\+T\+E\+R\+\_\+\+T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+P}}
\index{R\+E\+G\+I\+S\+T\+E\+R\+\_\+\+T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+P@{R\+E\+G\+I\+S\+T\+E\+R\+\_\+\+T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+P}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{R\+E\+G\+I\+S\+T\+E\+R\+\_\+\+T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+\+P(\+H\+T\+T\+P\+Downstream\+Test, Test\+Writes\+Draining, Test\+Body\+Size\+Limit, Test\+Uniform\+Pause\+State, Test\+Max\+Txns)}]{\setlength{\rightskip}{0pt plus 5cm}R\+E\+G\+I\+S\+T\+E\+R\+\_\+\+T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+P (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Test}}]{, }
\item[{Test\+Writes\+Draining}]{, }
\item[{Test\+Body\+Size\+Limit}]{, }
\item[{Test\+Uniform\+Pause\+State}]{, }
\item[{Test\+Max\+Txns}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_aa49956350332438aebbbd8ad2d3cd5b3}


Referenced by T\+E\+S\+T\+\_\+\+F().

\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+ST@{T\+E\+ST}}
\index{T\+E\+ST@{T\+E\+ST}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T(\+H\+T\+T\+P\+Downstream\+Test, Parse\+Error\+No\+Txn)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+ST (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Test}}]{, }
\item[{Parse\+Error\+No\+Txn}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a1748417b4451025047cf8c027de34b41}


Definition at line 802 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::k\+Error\+Parse\+Header, proxygen\+::local\+Addr, proxygen\+::make\+Downstream\+Parallel\+Codec(), proxygen\+::make\+Internal\+Timeout\+Set(), proxygen\+::mock\+Transport\+Info, proxygen\+::new\+Mock\+Transport(), proxygen\+::\+H\+T\+T\+P\+Codec\+::\+Callback\+::on\+Error(), proxygen\+::peer\+Addr, proxygen\+::\+H\+T\+T\+P\+Exception\+::set\+Codec\+Status\+Code(), proxygen\+::\+Exception\+::set\+Proxygen\+Error(), and proxygen\+::\+H\+T\+T\+P\+Downstream\+Session\+::start\+Now().


\begin{DoxyCode}
802                                           \{
803   \textcolor{comment}{// 1) Get a parse error on SYN\_STREAM for streamID == 1}
804   \textcolor{comment}{// 2) Expect that the codec should be asked to generate an abort on}
805   \textcolor{comment}{//    streamID==1}
806   EventBase evb;
807 
808   \textcolor{comment}{// Setup the controller and its expecations.}
809   NiceMock<MockController> mockController;
810 
811   \textcolor{comment}{// Setup the codec, its callbacks, and its expectations.}
812   \textcolor{keyword}{auto} codec = makeDownstreamParallelCodec();
813   HTTPCodec::Callback* codecCallback = \textcolor{keyword}{nullptr};
814   EXPECT\_CALL(*codec, setCallback(\_))
815     .WillRepeatedly(SaveArg<0>(&codecCallback));
816   \textcolor{comment}{// Expect egress abort for streamID == 1}
817   EXPECT\_CALL(*codec, generateRstStream(\_, 1, \_));
818 
819   \textcolor{comment}{// Setup transport}
820   \textcolor{keywordtype}{bool} transportGood = \textcolor{keyword}{true};
821   \textcolor{keyword}{auto} transport = newMockTransport(&evb);
822   EXPECT\_CALL(*transport, good())
823     .WillRepeatedly(ReturnPointee(&transportGood));
824   EXPECT\_CALL(*transport, closeNow())
825     .WillRepeatedly(Assign(&transportGood, \textcolor{keyword}{false}));
826   EXPECT\_CALL(*transport, writeChain(\_, \_, \_))
827     .WillRepeatedly(
828       Invoke([&] (folly::AsyncTransportWrapper::WriteCallback* callback,
829                   \textcolor{keyword}{const} shared\_ptr<IOBuf>&, WriteFlags) \{
830                callback->writeSuccess();
831              \}));
832 
833   \textcolor{comment}{// Create the downstream session, thus initializing codecCallback}
834   \textcolor{keyword}{auto} transactionTimeouts = makeInternalTimeoutSet(&evb);
835   \textcolor{keyword}{auto} session = \textcolor{keyword}{new} HTTPDownstreamSession(
836     transactionTimeouts.get(),
837     AsyncTransportWrapper::UniquePtr(transport),
838     localAddr, peerAddr,
839     &mockController, std::move(codec),
840     mockTransportInfo,
841     \textcolor{keyword}{nullptr});
842   session->startNow();
843   HTTPException ex(HTTPException::Direction::INGRESS\_AND\_EGRESS, \textcolor{stringliteral}{"foo"});
844   ex.setProxygenError(kErrorParseHeader);
845   ex.setCodecStatusCode(ErrorCode::REFUSED\_STREAM);
846   codecCallback->onError(HTTPCodec::StreamID(1), ex, \textcolor{keyword}{true});
847 
848   \textcolor{comment}{// cleanup}
849   session->dropConnection();
850   evb.loop();
851 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+ST@{T\+E\+ST}}
\index{T\+E\+ST@{T\+E\+ST}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T(\+H\+T\+T\+P\+Downstream\+Test, Byte\+Events\+Drained)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+ST (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Test}}]{, }
\item[{Byte\+Events\+Drained}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_aff74470c37897a96b3d4c920b4977226}


Definition at line 853 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::local\+Addr, proxygen\+::make\+Downstream\+Parallel\+Codec(), proxygen\+::make\+Internal\+Timeout\+Set(), proxygen\+::mock\+Transport\+Info, proxygen\+::new\+Mock\+Transport(), proxygen\+::peer\+Addr, and proxygen\+::\+H\+T\+T\+P\+Session\+::set\+Byte\+Event\+Tracker().


\begin{DoxyCode}
853                                             \{
854   \textcolor{comment}{// Test that byte events are drained before socket is closed}
855   EventBase evb;
856 
857   NiceMock<MockController> mockController;
858   \textcolor{keyword}{auto} codec = makeDownstreamParallelCodec();
859   \textcolor{keyword}{auto} byteEventTracker = \textcolor{keyword}{new} MockByteEventTracker(\textcolor{keyword}{nullptr});
860   \textcolor{keyword}{auto} transport = newMockTransport(&evb);
861   \textcolor{keyword}{auto} transactionTimeouts = makeInternalTimeoutSet(&evb);
862 
863   \textcolor{comment}{// Create the downstream session}
864   \textcolor{keyword}{auto} session = \textcolor{keyword}{new} HTTPDownstreamSession(
865     transactionTimeouts.get(),
866     AsyncTransportWrapper::UniquePtr(transport),
867     localAddr, peerAddr,
868     &mockController, std::move(codec),
869     mockTransportInfo,
870     \textcolor{keyword}{nullptr});
871   session->setByteEventTracker(
872       std::unique\_ptr<ByteEventTracker>(byteEventTracker));
873 
874   InSequence enforceOrder;
875 
876   session->startNow();
877 
878   \textcolor{comment}{// Byte events should be drained first}
879   EXPECT\_CALL(*byteEventTracker, drainByteEvents())
880     .Times(1);
881   EXPECT\_CALL(*transport, closeNow())
882     .Times(AtLeast(1));
883 
884   \textcolor{comment}{// Close the socket}
885   session->dropConnection();
886   evb.loop();
887 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Early\+Shutdown\+Test, Early\+Shutdown)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Early\+Shutdown\+Test}]{, }
\item[{Early\+Shutdown}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a3ee74a2e1011a509993e452d4efbe8e9}


Definition at line 479 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
479                                                                \{
480   folly::DelayedDestruction::DestructorGuard g(httpSession\_);
481 
482   \textcolor{comment}{// Try shutting down the session and then starting it. This should be properly}
483   \textcolor{comment}{// handled by the HTTPSession such that no HTTP/2 frames are sent in the}
484   \textcolor{comment}{// wrong order.}
485   StrictMock<MockHTTPCodecCallback> callbacks;
486   clientCodec\_->setCallback(&callbacks);
487   EXPECT\_CALL(callbacks, onFrameHeader(\_, \_, \_, \_, \_)).Times(2);
488   EXPECT\_CALL(callbacks, onSettings(\_)).Times(1);
489   EXPECT\_CALL(callbacks, onGoaway(\_, \_, \_)).Times(1);
490   expectDetachSession();
491   httpSession\_->notifyPendingShutdown();
492   httpSession\_->startNow();
493   eventBase\_.loop();
494   parseOutput(*clientCodec\_);
495 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Immediate\+Eof)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Immediate\+Eof}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a9201dbdfe7d143b01cc210d2bd4dba0d}


Definition at line 497 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
497                                                 \{
498   \textcolor{comment}{// Send EOF without any request data}
499   EXPECT\_CALL(mockController\_, getRequestHandler(\_, \_)).Times(0);
500   expectDetachSession();
501 
502   flushRequestsAndLoop(\textcolor{keyword}{true}, milliseconds(0));
503 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http10\+No\+Headers)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http10\+No\+Headers}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_afb69e1257f7fc3e254563cd20d571bd4}


Definition at line 505 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Get\+Request().


\begin{DoxyCode}
505                                                    \{
506   InSequence enforceOrder;
507 
508   \textcolor{keyword}{auto} handler = addSimpleNiceHandler();
509   handler->expectHeaders([&] (std::shared\_ptr<HTTPMessage> msg) \{
510       EXPECT\_FALSE(msg->getIsChunked());
511       EXPECT\_FALSE(msg->getIsUpgraded());
512       EXPECT\_EQ(\textcolor{stringliteral}{"/"}, msg->getURL());
513       EXPECT\_EQ(\textcolor{stringliteral}{"/"}, msg->getPath());
514       EXPECT\_EQ(\textcolor{stringliteral}{""}, msg->getQueryString());
515       EXPECT\_EQ(1, msg->getHTTPVersion().first);
516       EXPECT\_EQ(0, msg->getHTTPVersion().second);
517     \});
518   onEOMTerminateHandlerExpectShutdown(*handler);
519 
520   \textcolor{keyword}{auto} req = getGetRequest();
521   req.setHTTPVersion(1, 0);
522   sendRequest(req);
523   flushRequestsAndLoop();
524 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http10\+No\+Headers\+Eof)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http10\+No\+Headers\+Eof}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a3441c34536eba0068146b1b3170cbb89}


Definition at line 526 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
526                                                       \{
527   InSequence enforceOrder;
528 
529   \textcolor{keyword}{auto} handler = addSimpleNiceHandler();
530   handler->expectHeaders([&] (std::shared\_ptr<HTTPMessage> msg) \{
531       EXPECT\_FALSE(msg->getIsChunked());
532       EXPECT\_FALSE(msg->getIsUpgraded());
533       EXPECT\_EQ(\textcolor{stringliteral}{"http://example.com/foo?bar"}, msg->getURL());
534       EXPECT\_EQ(\textcolor{stringliteral}{"/foo"}, msg->getPath());
535       EXPECT\_EQ(\textcolor{stringliteral}{"bar"}, msg->getQueryString());
536       EXPECT\_EQ(1, msg->getHTTPVersion().first);
537       EXPECT\_EQ(0, msg->getHTTPVersion().second);
538     \});
539   onEOMTerminateHandlerExpectShutdown(*handler);
540 
541   \textcolor{keyword}{const} \textcolor{keywordtype}{char} *req = \textcolor{stringliteral}{"GET http://example.com/foo?bar HTTP/1.0\(\backslash\)r\(\backslash\)n\(\backslash\)r\(\backslash\)n"};
542   requests\_.append(req, strlen(req));
543   flushRequestsAndLoop(\textcolor{keyword}{true}, milliseconds(0));
544 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Single\+Bytes)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Single\+Bytes}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_ac61d21a93aefe783be7f49fd24da0561}


Definition at line 546 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+H\+T\+T\+P\+Headers\+::exists(), and proxygen\+::\+H\+T\+T\+P\+Headers\+::size().


\begin{DoxyCode}
546                                                \{
547   InSequence enforceOrder;
548 
549   \textcolor{keyword}{auto} handler = addSimpleNiceHandler();
550   handler->expectHeaders([&] (std::shared\_ptr<HTTPMessage> msg) \{
551       \textcolor{keyword}{const} HTTPHeaders& hdrs = msg->getHeaders();
552       EXPECT\_EQ(2, hdrs.size());
553       EXPECT\_TRUE(hdrs.exists(\textcolor{stringliteral}{"host"}));
554       EXPECT\_TRUE(hdrs.exists(\textcolor{stringliteral}{"connection"}));
555 
556       EXPECT\_FALSE(msg->getIsChunked());
557       EXPECT\_FALSE(msg->getIsUpgraded());
558       EXPECT\_EQ(\textcolor{stringliteral}{"/somepath.php?param=foo"}, msg->getURL());
559       EXPECT\_EQ(\textcolor{stringliteral}{"/somepath.php"}, msg->getPath());
560       EXPECT\_EQ(\textcolor{stringliteral}{"param=foo"}, msg->getQueryString());
561       EXPECT\_EQ(1, msg->getHTTPVersion().first);
562       EXPECT\_EQ(1, msg->getHTTPVersion().second);
563     \});
564   onEOMTerminateHandlerExpectShutdown(*handler);
565 
566   addSingleByteReads(\textcolor{stringliteral}{"GET /somepath.php?param=foo HTTP/1.1\(\backslash\)r\(\backslash\)n"}
567                      \textcolor{stringliteral}{"Host: example.com\(\backslash\)r\(\backslash\)n"}
568                      \textcolor{stringliteral}{"Connection: close\(\backslash\)r\(\backslash\)n"}
569                      \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
570   transport\_->addReadEOF(milliseconds(0));
571   transport\_->startReadEvents();
572   eventBase\_.loop();
573 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Single\+Bytes\+With\+Body)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Single\+Bytes\+With\+Body}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_aef021d636bdc9d693d2d41e6dbd33f1e}


Definition at line 575 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+H\+T\+T\+P\+Headers\+::exists(), and proxygen\+::\+H\+T\+T\+P\+Headers\+::size().


\begin{DoxyCode}
575                                                        \{
576   InSequence enforceOrder;
577 
578   \textcolor{keyword}{auto} handler = addSimpleNiceHandler();
579   handler->expectHeaders([&] (std::shared\_ptr<HTTPMessage> msg) \{
580       \textcolor{keyword}{const} HTTPHeaders& hdrs = msg->getHeaders();
581       EXPECT\_EQ(3, hdrs.size());
582       EXPECT\_TRUE(hdrs.exists(\textcolor{stringliteral}{"host"}));
583       EXPECT\_TRUE(hdrs.exists(\textcolor{stringliteral}{"content-length"}));
584       EXPECT\_TRUE(hdrs.exists(\textcolor{stringliteral}{"myheader"}));
585 
586       EXPECT\_FALSE(msg->getIsChunked());
587       EXPECT\_FALSE(msg->getIsUpgraded());
588       EXPECT\_EQ(\textcolor{stringliteral}{"/somepath.php?param=foo"}, msg->getURL());
589       EXPECT\_EQ(\textcolor{stringliteral}{"/somepath.php"}, msg->getPath());
590       EXPECT\_EQ(\textcolor{stringliteral}{"param=foo"}, msg->getQueryString());
591       EXPECT\_EQ(1, msg->getHTTPVersion().first);
592       EXPECT\_EQ(1, msg->getHTTPVersion().second);
593     \});
594   EXPECT\_CALL(*handler, onBody(\_))
595     .WillOnce(ExpectString(\textcolor{stringliteral}{"1"}))
596     .WillOnce(ExpectString(\textcolor{stringliteral}{"2"}))
597     .WillOnce(ExpectString(\textcolor{stringliteral}{"3"}))
598     .WillOnce(ExpectString(\textcolor{stringliteral}{"4"}))
599     .WillOnce(ExpectString(\textcolor{stringliteral}{"5"}));
600   onEOMTerminateHandlerExpectShutdown(*handler);
601 
602   addSingleByteReads(\textcolor{stringliteral}{"POST /somepath.php?param=foo HTTP/1.1\(\backslash\)r\(\backslash\)n"}
603                      \textcolor{stringliteral}{"Host: example.com\(\backslash\)r\(\backslash\)n"}
604                      \textcolor{stringliteral}{"MyHeader: FooBar\(\backslash\)r\(\backslash\)n"}
605                      \textcolor{stringliteral}{"Content-Length: 5\(\backslash\)r\(\backslash\)n"}
606                      \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}
607                      \textcolor{stringliteral}{"12345"});
608   transport\_->addReadEOF(milliseconds(0));
609   transport\_->startReadEvents();
610   eventBase\_.loop();
611 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Split\+Body)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Split\+Body}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_aebca5396c4da994bcb662a312ea3e52e}


Definition at line 613 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+H\+T\+T\+P\+Headers\+::size().


\begin{DoxyCode}
613                                              \{
614   InSequence enforceOrder;
615 
616   \textcolor{keyword}{auto} handler = addSimpleNiceHandler();
617   handler->expectHeaders([&] (std::shared\_ptr<HTTPMessage> msg) \{
618       \textcolor{keyword}{const} HTTPHeaders& hdrs = msg->getHeaders();
619       EXPECT\_EQ(2, hdrs.size());
620     \});
621   EXPECT\_CALL(*handler, onBody(\_))
622     .WillOnce(ExpectString(\textcolor{stringliteral}{"12345"}))
623     .WillOnce(ExpectString(\textcolor{stringliteral}{"abcde"}));
624   onEOMTerminateHandlerExpectShutdown(*handler);
625 
626   transport\_->addReadEvent(\textcolor{stringliteral}{"POST / HTTP/1.1\(\backslash\)r\(\backslash\)n"}
627                            \textcolor{stringliteral}{"Host: example.com\(\backslash\)r\(\backslash\)n"}
628                            \textcolor{stringliteral}{"Content-Length: 10\(\backslash\)r\(\backslash\)n"}
629                            \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}
630                            \textcolor{stringliteral}{"12345"}, milliseconds(0));
631   transport\_->addReadEvent(\textcolor{stringliteral}{"abcde"}, milliseconds(5));
632   transport\_->addReadEOF(milliseconds(0));
633   transport\_->startReadEvents();
634   eventBase\_.loop();
635 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Post\+Chunked)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Post\+Chunked}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a7a54ad380abf1d319dec2347f6b8ae37}


Definition at line 637 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+H\+T\+T\+P\+Headers\+::exists(), and proxygen\+::\+H\+T\+T\+P\+Headers\+::size().


\begin{DoxyCode}
637                                                \{
638   InSequence enforceOrder;
639 
640   \textcolor{keyword}{auto} handler = addSimpleNiceHandler();
641   handler->expectHeaders([&] (std::shared\_ptr<HTTPMessage> msg) \{
642       \textcolor{keyword}{const} HTTPHeaders& hdrs = msg->getHeaders();
643       EXPECT\_EQ(3, hdrs.size());
644       EXPECT\_TRUE(hdrs.exists(\textcolor{stringliteral}{"host"}));
645       EXPECT\_TRUE(hdrs.exists(\textcolor{stringliteral}{"content-type"}));
646       EXPECT\_TRUE(hdrs.exists(\textcolor{stringliteral}{"transfer-encoding"}));
647       EXPECT\_TRUE(msg->getIsChunked());
648       EXPECT\_FALSE(msg->getIsUpgraded());
649       EXPECT\_EQ(\textcolor{stringliteral}{"http://example.com/cgi-bin/foo.aspx?abc&def"},
650                 msg->getURL());
651       EXPECT\_EQ(\textcolor{stringliteral}{"/cgi-bin/foo.aspx"}, msg->getPath());
652       EXPECT\_EQ(\textcolor{stringliteral}{"abc&def"}, msg->getQueryString());
653       EXPECT\_EQ(1, msg->getHTTPVersion().first);
654       EXPECT\_EQ(1, msg->getHTTPVersion().second);
655     \});
656   EXPECT\_CALL(*handler, onChunkHeader(3));
657   EXPECT\_CALL(*handler, onBody(\_))
658     .WillOnce(ExpectString(\textcolor{stringliteral}{"bar"}));
659   EXPECT\_CALL(*handler, onChunkComplete());
660   EXPECT\_CALL(*handler, onChunkHeader(0x22));
661   EXPECT\_CALL(*handler, onBody(\_))
662     .WillOnce(ExpectString(\textcolor{stringliteral}{"0123456789abcdef\(\backslash\)nfedcba9876543210\(\backslash\)n"}));
663   EXPECT\_CALL(*handler, onChunkComplete());
664   EXPECT\_CALL(*handler, onChunkHeader(3));
665   EXPECT\_CALL(*handler, onBody(\_))
666     .WillOnce(ExpectString(\textcolor{stringliteral}{"foo"}));
667   EXPECT\_CALL(*handler, onChunkComplete());
668   onEOMTerminateHandlerExpectShutdown(*handler);
669 
670   transport\_->addReadEvent(\textcolor{stringliteral}{"POST http://example.com/cgi-bin/foo.aspx?abc&def "}
671                            \textcolor{stringliteral}{"HTTP/1.1\(\backslash\)r\(\backslash\)n"}
672                            \textcolor{stringliteral}{"Host: example.com\(\backslash\)r\(\backslash\)n"}
673                            \textcolor{stringliteral}{"Content-Type: text/pla"}, milliseconds(0));
674   transport\_->addReadEvent(\textcolor{stringliteral}{"in; charset=utf-8\(\backslash\)r\(\backslash\)n"}
675                            \textcolor{stringliteral}{"Transfer-encoding: chunked\(\backslash\)r\(\backslash\)n"}
676                            \textcolor{stringliteral}{"\(\backslash\)r"}, milliseconds(2));
677   transport\_->addReadEvent(\textcolor{stringliteral}{"\(\backslash\)n"}
678                            \textcolor{stringliteral}{"3\(\backslash\)r\(\backslash\)n"}
679                            \textcolor{stringliteral}{"bar\(\backslash\)r\(\backslash\)n"}
680                            \textcolor{stringliteral}{"22\(\backslash\)r\(\backslash\)n"}
681                            \textcolor{stringliteral}{"0123456789abcdef\(\backslash\)n"}
682                            \textcolor{stringliteral}{"fedcba9876543210\(\backslash\)n"}
683                            \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}
684                            \textcolor{stringliteral}{"3\(\backslash\)r"}, milliseconds(3));
685   transport\_->addReadEvent(\textcolor{stringliteral}{"\(\backslash\)n"}
686                            \textcolor{stringliteral}{"foo\(\backslash\)r\(\backslash\)n"}
687                            \textcolor{stringliteral}{"0\(\backslash\)r\(\backslash\)n\(\backslash\)r\(\backslash\)n"}, milliseconds(1));
688   transport\_->startReadEvents();
689   eventBase\_.loop();
690 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Multi\+Message)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Multi\+Message}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a18ada811650f8e9884ed2a8c7a24bc55}


Definition at line 692 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
692                                                 \{
693   InSequence enforceOrder;
694 
695   \textcolor{keyword}{auto} handler1 = addSimpleNiceHandler();
696   handler1->expectHeaders();
697   EXPECT\_CALL(*handler1, onBody(\_))
698     .WillOnce(ExpectString(\textcolor{stringliteral}{"foo"}))
699     .WillOnce(ExpectString(\textcolor{stringliteral}{"bar9876"}));
700   handler1->expectEOM([&] \{ handler1->sendReply(); \});
701   handler1->expectDetachTransaction();
702 
703   \textcolor{keyword}{auto} handler2 = addSimpleNiceHandler();
704   handler2->expectHeaders();
705   EXPECT\_CALL(*handler2, onChunkHeader(0xa));
706   EXPECT\_CALL(*handler2, onBody(\_))
707     .WillOnce(ExpectString(\textcolor{stringliteral}{"some "}))
708     .WillOnce(ExpectString(\textcolor{stringliteral}{"data\(\backslash\)n"}));
709   EXPECT\_CALL(*handler2, onChunkComplete());
710   onEOMTerminateHandlerExpectShutdown(*handler2);
711 
712   transport\_->addReadEvent(\textcolor{stringliteral}{"POST / HTTP/1.1\(\backslash\)r\(\backslash\)n"}
713                            \textcolor{stringliteral}{"Host: example.com\(\backslash\)r\(\backslash\)n"}
714                            \textcolor{stringliteral}{"Content-Length: 10\(\backslash\)r\(\backslash\)n"}
715                            \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}
716                            \textcolor{stringliteral}{"foo"}, milliseconds(0));
717   transport\_->addReadEvent(\textcolor{stringliteral}{"bar9876"}
718                            \textcolor{stringliteral}{"POST /foo HTTP/1.1\(\backslash\)r\(\backslash\)n"}
719                            \textcolor{stringliteral}{"Host: exa"}, milliseconds(2));
720   transport\_->addReadEvent(\textcolor{stringliteral}{"mple.com\(\backslash\)r\(\backslash\)n"}
721                            \textcolor{stringliteral}{"Connection: close\(\backslash\)r\(\backslash\)n"}
722                            \textcolor{stringliteral}{"Trans"}, milliseconds(0));
723   transport\_->addReadEvent(\textcolor{stringliteral}{"fer-encoding: chunked\(\backslash\)r\(\backslash\)n"}
724                            \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, milliseconds(2));
725   transport\_->addReadEvent(\textcolor{stringliteral}{"a\(\backslash\)r\(\backslash\)nsome "}, milliseconds(0));
726   transport\_->addReadEvent(\textcolor{stringliteral}{"data\(\backslash\)n\(\backslash\)r\(\backslash\)n0\(\backslash\)r\(\backslash\)n\(\backslash\)r\(\backslash\)n"}, milliseconds(2));
727   transport\_->addReadEOF(milliseconds(0));
728   transport\_->startReadEvents();
729   eventBase\_.loop();
730 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Connect)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Connect}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a6d12c26589c8bd283143f6bef94b88c3}


Definition at line 732 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
732                                            \{
733   InSequence enforceOrder;
734 
735   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
736   \textcolor{comment}{// Send HTTP 200 OK to accept the CONNECT request}
737   handler->expectHeaders([&handler] \{
738       handler->sendHeaders(200, 100);
739     \});
740 
741   EXPECT\_CALL(*handler, onUpgrade(\_));
742 
743   \textcolor{comment}{// Data should be received using onBody}
744   EXPECT\_CALL(*handler, onBody(\_))
745     .WillOnce(ExpectString(\textcolor{stringliteral}{"12345"}))
746     .WillOnce(ExpectString(\textcolor{stringliteral}{"abcde"}));
747   onEOMTerminateHandlerExpectShutdown(*handler);
748 
749   transport\_->addReadEvent(\textcolor{stringliteral}{"CONNECT test HTTP/1.1\(\backslash\)r\(\backslash\)n"}
750                            \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}
751                            \textcolor{stringliteral}{"12345"}, milliseconds(0));
752   transport\_->addReadEvent(\textcolor{stringliteral}{"abcde"}, milliseconds(5));
753   transport\_->addReadEOF(milliseconds(0));
754   transport\_->startReadEvents();
755   eventBase\_.loop();
756 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Connect\+Rejected)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Connect\+Rejected}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a74c2902b8ddc7e3e23dd4af66bad9372}


Definition at line 758 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
758                                                    \{
759   InSequence enforceOrder;
760 
761   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
762   \textcolor{comment}{// Send HTTP 400 to reject the CONNECT request}
763   handler->expectHeaders([&handler] \{
764       handler->sendReplyCode(400);
765     \});
766 
767   onEOMTerminateHandlerExpectShutdown(*handler);
768 
769   transport\_->addReadEvent(\textcolor{stringliteral}{"CONNECT test HTTP/1.1\(\backslash\)r\(\backslash\)n"}
770                            \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}
771                            \textcolor{stringliteral}{"12345"}, milliseconds(0));
772   transport\_->addReadEvent(\textcolor{stringliteral}{"abcde"}, milliseconds(5));
773   transport\_->addReadEOF(milliseconds(0));
774   transport\_->startReadEvents();
775   eventBase\_.loop();
776 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Upgrade)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Upgrade}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_aa1bf0dace7a144225fe9e9824fde0d05}


Definition at line 778 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+H\+T\+T\+P\+Headers\+::add(), proxygen\+::get\+Get\+Request(), and proxygen\+::\+H\+T\+T\+P\+Message\+::get\+Headers().


\begin{DoxyCode}
778                                                \{
779   InSequence enforceOrder;
780 
781   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
782   \textcolor{comment}{// Send HTTP 101 Switching Protocls to accept the upgrade request}
783   handler->expectHeaders([&handler] \{
784       handler->sendHeaders(101, 100);
785     \});
786 
787   \textcolor{comment}{// Send the response in the new protocol after upgrade}
788   EXPECT\_CALL(*handler, onUpgrade(\_))
789       .WillOnce(Invoke([&handler](UpgradeProtocol \textcolor{comment}{/*protocol*/}) \{
790         handler->sendReplyCode(100);
791       \}));
792 
793   onEOMTerminateHandlerExpectShutdown(*handler);
794 
795   HTTPMessage req = getGetRequest();
796   req.getHeaders().add(HTTP\_HEADER\_UPGRADE, \textcolor{stringliteral}{"TEST/1.0"});
797   req.getHeaders().add(HTTP\_HEADER\_CONNECTION, \textcolor{stringliteral}{"upgrade"});
798   sendRequest(req);
799   flushRequestsAndLoop(\textcolor{keyword}{true}, milliseconds(0));
800 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+With\+Ack\+Timing)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+With\+Ack\+Timing}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a8059e76004e33faaaa3ad1909ffe074a}


Definition at line 889 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+H\+T\+T\+P\+Transaction\+::increment\+Pending\+Byte\+Events().


\begin{DoxyCode}
889                                                      \{
890   \textcolor{comment}{// This is to test cases where holding a byte event to a finished HTTP/1.1}
891   \textcolor{comment}{// transaction does not masquerade as HTTP pipelining.}
892   \textcolor{keyword}{auto} byteEventTracker = setMockByteEventTracker();
893   InSequence enforceOrder;
894 
895   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
896   handler1->expectHeaders();
897   handler1->expectEOM([&handler1] () \{
898       handler1->sendChunkedReplyWithBody(200, 100, 100, \textcolor{keyword}{false});
899     \});
900   \textcolor{comment}{// Hold a pending byte event}
901   EXPECT\_CALL(*byteEventTracker, addLastByteEvent(\_, \_))
902       .WillOnce(Invoke([] (HTTPTransaction* txn,
903                            uint64\_t \textcolor{comment}{/*byteNo*/}) \{
904                          txn->incrementPendingByteEvents();
905                        \}));
906   sendRequest();
907   flushRequestsAndLoop();
908   expectResponse();
909 
910   \textcolor{comment}{// Send the secode request after receiving the first response (eg: clearly}
911   \textcolor{comment}{// not pipelined)}
912   \textcolor{keyword}{auto} handler2 = addSimpleStrictHandler();
913   handler2->expectHeaders();
914   handler2->expectEOM([&handler2] () \{
915       handler2->sendChunkedReplyWithBody(200, 100, 100, \textcolor{keyword}{false});
916     \});
917   \textcolor{comment}{// This txn processed and destroyed before txn1}
918   EXPECT\_CALL(*byteEventTracker, addLastByteEvent(\_, \_));
919   handler2->expectDetachTransaction();
920 
921   sendRequest();
922   flushRequestsAndLoop();
923   expectResponse();
924 
925   \textcolor{comment}{// Now clear the pending byte event (simulate ack) and the first txn}
926   \textcolor{comment}{// goes away too}
927   handler1->expectDetachTransaction();
928   handler1->txn\_->decrementPendingByteEvents();
929   gracefulShutdown();
930 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Test\+On\+Content\+Mismatch)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Test\+On\+Content\+Mismatch}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a55f952e3a91a448984c28c44c0124ec6}


Definition at line 932 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
932                                                          \{
933   \textcolor{comment}{// Test the behavior when the reported content-length on the header}
934   \textcolor{comment}{// is different from the actual length of the body.}
935   \textcolor{comment}{// The expectation is simply to log the behavior, such as:}
936   \textcolor{comment}{// ".. HTTPTransaction.cpp ] Content-Length/body mismatch: expected: .. "}
937   folly::EventBase base;
938   InSequence enforceOrder;
939   \textcolor{keyword}{auto} handler1 = addSimpleNiceHandler();
940   handler1->expectHeaders();
941   handler1->expectEOM([&handler1] () \{
942         \textcolor{comment}{// over-estimate the content-length on the header}
943         handler1->sendHeaders(200, 105);
944         handler1->sendBody(100);
945         handler1->txn\_->sendEOM();
946       \});
947   sendRequest();
948   flushRequestsAndLoop();
949 
950   \textcolor{keyword}{auto} handler2 = addSimpleNiceHandler();
951   handler2->expectHeaders();
952   handler2->expectEOM([&handler2] () \{
953         \textcolor{comment}{// under-estimate the content-length on the header}
954         handler2->sendHeaders(200, 95);
955         handler2->sendBody(100);
956         handler2->txn\_->sendEOM();
957       \});
958   sendRequest();
959   flushRequestsAndLoop();
960   gracefulShutdown();
961 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+With\+Ack\+Timing\+Pipeline)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+With\+Ack\+Timing\+Pipeline}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a88c8f7e751469ab3c517ac4cdc47ef61}


Definition at line 963 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+H\+T\+T\+P\+Transaction\+::increment\+Pending\+Byte\+Events().


\begin{DoxyCode}
963                                                              \{
964   \textcolor{comment}{// Test a real pipelining case as well.  First request is done waiting for}
965   \textcolor{comment}{// ack, then receive two pipelined requests.}
966   \textcolor{keyword}{auto} byteEventTracker = setMockByteEventTracker();
967   InSequence enforceOrder;
968 
969   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
970   handler1->expectHeaders();
971   handler1->expectEOM([&handler1] () \{
972       handler1->sendChunkedReplyWithBody(200, 100, 100, \textcolor{keyword}{false});
973     \});
974   EXPECT\_CALL(*byteEventTracker, addLastByteEvent(\_, \_))
975       .WillOnce(Invoke([] (HTTPTransaction* txn,
976                            uint64\_t \textcolor{comment}{/*byteNo*/}) \{
977                          txn->incrementPendingByteEvents();
978                        \}));
979   sendRequest();
980   \textcolor{keyword}{auto} handler2 = addSimpleStrictHandler();
981   handler2->expectHeaders();
982   handler2->expectEOM([&handler2] () \{
983       handler2->sendChunkedReplyWithBody(200, 100, 100, \textcolor{keyword}{false});
984     \});
985   EXPECT\_CALL(*byteEventTracker, addLastByteEvent(\_, \_));
986   handler2->expectDetachTransaction();
987 
988   sendRequest();
989   sendRequest();
990   \textcolor{keyword}{auto} handler3 = addSimpleStrictHandler();
991   handler3->expectHeaders();
992   handler3->expectEOM([&handler3] () \{
993       handler3->sendChunkedReplyWithBody(200, 100, 100, \textcolor{keyword}{false});
994     \});
995   EXPECT\_CALL(*byteEventTracker, addLastByteEvent(\_, \_));
996   handler3->expectDetachTransaction();
997   flushRequestsAndLoop();
998   expectResponses(3);
999   handler1->expectDetachTransaction();
1000   handler1->txn\_->decrementPendingByteEvents();
1001   gracefulShutdown();
1002 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Exheader\+From\+Server)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Exheader\+From\+Server}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_acd8f17042fcc240024e73d2cedeacb36}


Definition at line 1012 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Get\+Request(), proxygen\+::get\+Response(), and make\+Buf().


\begin{DoxyCode}
1012                                                        \{
1013   \textcolor{keyword}{auto} cStreamId = HTTPCodec::StreamID(1);
1014   SetupControlStream(cStreamId);
1015 
1016   \textcolor{comment}{// Create a dummy request and a dummy response messages}
1017   \textcolor{keyword}{auto} pub = getGetRequest(\textcolor{stringliteral}{"/sub/fyi"});
1018   \textcolor{comment}{// set up the priority for fun}
1019   pub.setHTTP2Priority(std::make\_tuple(0, \textcolor{keyword}{false}, 7));
1020 
1021   InSequence handlerSequence;
1022   \textcolor{keyword}{auto} cHandler = addSimpleStrictHandler();
1023   StrictMock<MockHTTPHandler> pubHandler;
1024 
1025   cHandler->expectHeaders([&] \{
1026       cHandler->txn\_->pauseIngress();
1027       \textcolor{comment}{// Generate response for the control stream}
1028       cHandler->txn\_->sendHeaders(getResponse(200, 0));
1029       cHandler->txn\_->sendBody(makeBuf(100));
1030 
1031       \textcolor{keyword}{auto}* pubTxn = cHandler->txn\_->newExTransaction(&pubHandler);
1032       \textcolor{comment}{// Generate a pub request (encapsulated in EX\_HEADERS frame)}
1033       pubTxn->sendHeaders(pub);
1034       pubTxn->sendBody(makeBuf(200));
1035       pubTxn->sendEOM();
1036     \});
1037 
1038   EXPECT\_CALL(pubHandler, setTransaction(\_));
1039   EXPECT\_CALL(callbacks\_, onSettings(\_))
1040     .WillOnce(InvokeWithoutArgs([&] \{
1041           clientCodec\_->generateSettingsAck(requests\_);
1042         \}));
1043   EXPECT\_CALL(callbacks\_, onMessageBegin(cStreamId, \_));
1044   EXPECT\_CALL(callbacks\_, onHeadersComplete(cStreamId, \_));
1045   EXPECT\_CALL(callbacks\_, onExMessageBegin(2, \_, \_, \_));
1046   EXPECT\_CALL(callbacks\_, onHeadersComplete(2, \_));
1047   EXPECT\_CALL(callbacks\_, onMessageComplete(2, \_));
1048 
1049   EXPECT\_CALL(pubHandler, onHeadersComplete(\_));
1050   EXPECT\_CALL(pubHandler, onEOM());
1051   EXPECT\_CALL(pubHandler, detachTransaction());
1052 
1053   EXPECT\_CALL(*cHandler, onEOM());
1054   EXPECT\_CALL(*cHandler, detachTransaction());
1055 
1056   transport\_->addReadEvent(requests\_, milliseconds(0));
1057   transport\_->startReadEvents();
1058 
1059   eventBase\_.runAfterDelay([&] \{
1060       parseOutput(*clientCodec\_);
1061       \textcolor{comment}{// send a response from client to server}
1062       clientCodec\_->generateExHeader(requests\_, 2, getResponse(200, 0),
1063                                      HTTPCodec::ExAttributes(cStreamId, \textcolor{keyword}{false}),
1064                                      \textcolor{keyword}{true}, \textcolor{keyword}{nullptr});
1065       transport\_->addReadEvent(requests\_, milliseconds(0));
1066       transport\_->startReadEvents();
1067       parseOutput(*clientCodec\_);
1068       cHandler->txn\_->resumeIngress();
1069       cHandler->txn\_->sendEOM();
1070       transport\_->addReadEOF(milliseconds(0));
1071     \}, 100);
1072 
1073   HTTPSession::DestructorGuard g(httpSession\_);
1074   expectDetachSession();
1075   eventBase\_.loop();
1076 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Exheader\+From\+Client)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Exheader\+From\+Client}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_acc324e1799d76c44692e27158474a6e1}


Definition at line 1086 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Get\+Request(), proxygen\+::get\+Response(), and proxygen\+::\+H\+T\+T\+P\+Transaction\+::set\+Handler().


\begin{DoxyCode}
1086                                                        \{
1087   \textcolor{keyword}{auto} cStreamId = HTTPCodec::StreamID(1);
1088   SetupControlStream(cStreamId);
1089 
1090   \textcolor{comment}{// generate an EX\_HEADERS}
1091   \textcolor{keyword}{auto} exStreamId = cStreamId + 2;
1092   clientCodec\_->generateExHeader(requests\_, exStreamId, getGetRequest(\textcolor{stringliteral}{"/pub"}),
1093                                  HTTPCodec::ExAttributes(cStreamId, \textcolor{keyword}{false}),
1094                                  \textcolor{keyword}{true}, \textcolor{keyword}{nullptr});
1095 
1096   \textcolor{keyword}{auto} cHandler = addSimpleStrictHandler();
1097   cHandler->expectHeaders([&] \{
1098       \textcolor{comment}{// send back the response for control stream, but EOM}
1099       cHandler->txn\_->sendHeaders(getResponse(200, 0));
1100     \});
1101   EXPECT\_CALL(*cHandler, onEOM());
1102 
1103   StrictMock<MockHTTPHandler> pubHandler;
1104   EXPECT\_CALL(*cHandler, onExTransaction(\_))
1105     .WillOnce(Invoke([&pubHandler] (HTTPTransaction* exTxn) \{
1106           exTxn->setHandler(&pubHandler);
1107           pubHandler.txn\_ = exTxn;
1108         \}));
1109 
1110   InSequence handlerSequence;
1111   EXPECT\_CALL(pubHandler, setTransaction(\_));
1112   pubHandler.expectHeaders([&] \{
1113       \textcolor{comment}{// send back the response for the pub request}
1114       pubHandler.txn\_->sendHeadersWithEOM(getResponse(200, 0));
1115     \});
1116   EXPECT\_CALL(pubHandler, onEOM());
1117   EXPECT\_CALL(pubHandler, detachTransaction());
1118   cHandler->expectDetachTransaction();
1119 
1120   EXPECT\_CALL(callbacks\_, onMessageBegin(cStreamId, \_));
1121   EXPECT\_CALL(callbacks\_, onHeadersComplete(cStreamId, \_));
1122   EXPECT\_CALL(callbacks\_, onExMessageBegin(exStreamId, \_, \_, \_));
1123   EXPECT\_CALL(callbacks\_, onHeadersComplete(exStreamId, \_));
1124   EXPECT\_CALL(callbacks\_, onMessageComplete(exStreamId, \_));
1125   EXPECT\_CALL(callbacks\_, onMessageComplete(cStreamId, \_));
1126 
1127   transport\_->addReadEvent(requests\_, milliseconds(0));
1128   transport\_->startReadEvents();
1129   transport\_->addReadEOF(milliseconds(0));
1130   eventBase\_.loop();
1131 
1132   HTTPSession::DestructorGuard g(httpSession\_);
1133   expectDetachSession();
1134   cHandler->txn\_->sendEOM();
1135   eventBase\_.loop();
1136   parseOutput(*clientCodec\_);
1137 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Unidirectional\+Ex\+Transaction)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Unidirectional\+Ex\+Transaction}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_abba5c7c3a2f35e654685880d4bc910b7}


Definition at line 1145 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Get\+Request(), and proxygen\+::get\+Response().


\begin{DoxyCode}
1145                                                                 \{
1146   \textcolor{keyword}{auto} cStreamId = HTTPCodec::StreamID(1);
1147   SetupControlStream(cStreamId);
1148   InSequence handlerSequence;
1149   \textcolor{keyword}{auto} cHandler = addSimpleStrictHandler();
1150   StrictMock<MockHTTPHandler> uniHandler;
1151 
1152   cHandler->expectHeaders([&] \{
1153       \textcolor{keyword}{auto}* uniTxn = cHandler->txn\_->newExTransaction(&uniHandler, \textcolor{keyword}{true});
1154       EXPECT\_TRUE(uniTxn->isIngressComplete());
1155       uniTxn->sendHeaders(getGetRequest(\textcolor{stringliteral}{"/uni"}));
1156       uniTxn->sendEOM();
1157 
1158       \textcolor{comment}{// close control stream}
1159       cHandler->txn\_->sendHeadersWithEOM(getResponse(200, 0));
1160     \});
1161 
1162   EXPECT\_CALL(uniHandler, setTransaction(\_));
1163   EXPECT\_CALL(*cHandler, onEOM());
1164   EXPECT\_CALL(uniHandler, detachTransaction());
1165   EXPECT\_CALL(*cHandler, detachTransaction());
1166 
1167   transport\_->addReadEvent(requests\_, milliseconds(0));
1168   transport\_->startReadEvents();
1169   eventBase\_.runAfterDelay([&] \{
1170       transport\_->addReadEOF(milliseconds(0));
1171     \}, 100);
1172 
1173   HTTPSession::DestructorGuard g(httpSession\_);
1174   expectDetachSession();
1175   eventBase\_.loop();
1176 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Pause\+Resume\+Control\+Stream)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Pause\+Resume\+Control\+Stream}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a74d4126728dd5a409fe1595af66ac220}


Definition at line 1178 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Get\+Request(), proxygen\+::get\+Response(), and proxygen\+::\+H\+T\+T\+P\+Transaction\+::set\+Handler().


\begin{DoxyCode}
1178                                                              \{
1179   \textcolor{keyword}{auto} cStreamId = HTTPCodec::StreamID(1);
1180   SetupControlStream(cStreamId);
1181 
1182   \textcolor{comment}{// generate an EX\_HEADERS}
1183   clientCodec\_->generateExHeader(requests\_, cStreamId + 2, getGetRequest(),
1184                                  HTTPCodec::ExAttributes(cStreamId, \textcolor{keyword}{false}),
1185                                  \textcolor{keyword}{true}, \textcolor{keyword}{nullptr});
1186 
1187   \textcolor{keyword}{auto} cHandler = addSimpleStrictHandler();
1188   cHandler->expectHeaders([&] \{
1189       cHandler->txn\_->pauseIngress();
1190       \textcolor{comment}{// send back the response for control stream, but EOM}
1191       cHandler->txn\_->sendHeaders(getResponse(200, 0));
1192     \});
1193   EXPECT\_CALL(*cHandler, onEOM());
1194 
1195   StrictMock<MockHTTPHandler> pubHandler;
1196   EXPECT\_CALL(*cHandler, onExTransaction(\_))
1197     .WillOnce(Invoke([&pubHandler] (HTTPTransaction* exTxn) \{
1198           exTxn->setHandler(&pubHandler);
1199           pubHandler.txn\_ = exTxn;
1200         \}));
1201 
1202   InSequence handlerSequence;
1203   EXPECT\_CALL(pubHandler, setTransaction(\_));
1204   pubHandler.expectHeaders([&] \{
1205       \textcolor{comment}{// send back the response for the pub request}
1206       pubHandler.txn\_->sendHeadersWithEOM(getResponse(200, 0));
1207     \});
1208   EXPECT\_CALL(pubHandler, onEOM());
1209   EXPECT\_CALL(pubHandler, detachTransaction());
1210   cHandler->expectDetachTransaction();
1211 
1212   EXPECT\_CALL(callbacks\_, onMessageBegin(cStreamId, \_));
1213   EXPECT\_CALL(callbacks\_, onHeadersComplete(cStreamId, \_));
1214   EXPECT\_CALL(callbacks\_, onHeadersComplete(cStreamId + 2, \_));
1215   EXPECT\_CALL(callbacks\_, onMessageComplete(cStreamId + 2, \_));
1216   EXPECT\_CALL(callbacks\_, onMessageComplete(cStreamId, \_));
1217 
1218   HTTPSession::DestructorGuard g(httpSession\_);
1219   transport\_->addReadEvent(requests\_, milliseconds(0));
1220   transport\_->addReadEOF(milliseconds(0));
1221   transport\_->startReadEvents();
1222   eventBase\_.loop();
1223 
1224   cHandler->txn\_->resumeIngress();
1225   cHandler->txn\_->sendEOM();
1226   eventBase\_.loop();
1227 
1228   expectDetachSession();
1229   parseOutput(*clientCodec\_);
1230 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Invalid\+Control\+Stream)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Invalid\+Control\+Stream}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a77b54bd3bbb7b3a8c106313866a4ae92}


Definition at line 1232 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Get\+Request(), and proxygen\+::get\+Response().


\begin{DoxyCode}
1232                                                          \{
1233   \textcolor{keyword}{auto} cStreamId = HTTPCodec::StreamID(1);
1234   SetupControlStream(cStreamId);
1235 
1236   \textcolor{comment}{// generate an EX\_HEADERS, but with a non-existing control stream}
1237   clientCodec\_->generateExHeader(requests\_, cStreamId + 2, getGetRequest(),
1238                                  HTTPCodec::ExAttributes(cStreamId + 4, \textcolor{keyword}{false}),
1239                                  \textcolor{keyword}{true}, \textcolor{keyword}{nullptr});
1240 
1241   \textcolor{keyword}{auto} cHandler = addSimpleStrictHandler();
1242   InSequence handlerSequence;
1243   cHandler->expectHeaders([&] \{
1244       \textcolor{comment}{// send back the response for control stream, but EOM}
1245       cHandler->txn\_->sendHeaders(getResponse(200, 0));
1246     \});
1247   EXPECT\_CALL(*cHandler, onExTransaction(\_)).Times(0);
1248   EXPECT\_CALL(*cHandler, onEOM());
1249   cHandler->expectDetachTransaction();
1250 
1251   EXPECT\_CALL(callbacks\_, onMessageBegin(cStreamId, \_));
1252   EXPECT\_CALL(callbacks\_, onHeadersComplete(cStreamId, \_));
1253   EXPECT\_CALL(callbacks\_, onAbort(cStreamId + 2, \_));
1254 
1255   HTTPSession::DestructorGuard g(httpSession\_);
1256   transport\_->addReadEvent(requests\_, milliseconds(0));
1257   transport\_->addReadEOF(milliseconds(0));
1258   transport\_->startReadEvents();
1259   eventBase\_.loop();
1260 
1261   cHandler->txn\_->sendEOM();
1262   eventBase\_.loop();
1263 
1264   expectDetachSession();
1265   parseOutput(*clientCodec\_);
1266 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Set\+Byte\+Event\+Tracker)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Set\+Byte\+Event\+Tracker}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a9f8064a816be8a44896ddad917777b36}


Definition at line 1268 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
1268                                                         \{
1269   InSequence enforceOrder;
1270 
1271   \textcolor{comment}{// Send two requests with writes paused, which will queue several byte events,}
1272   \textcolor{comment}{// including last byte events which are holding a reference to the}
1273   \textcolor{comment}{// transaction.}
1274   transport\_->pauseWrites();
1275   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
1276   handler1->expectHeaders();
1277   handler1->expectEOM([&handler1] () \{
1278       handler1->sendReplyWithBody(200, 100);
1279     \});
1280   \textcolor{keyword}{auto} handler2 = addSimpleStrictHandler();
1281   handler2->expectHeaders();
1282   handler2->expectEOM([&handler2] () \{
1283       handler2->sendReplyWithBody(200, 100);
1284     \});
1285 
1286   sendRequest();
1287   sendRequest();
1288   \textcolor{comment}{// Resume writes from the loop callback}
1289   eventBase\_.runInLoop([\textcolor{keyword}{this}] \{
1290       transport\_->resumeWrites();
1291     \});
1292 
1293   \textcolor{comment}{// Graceful shutdown will notify of GOAWAY}
1294   EXPECT\_CALL(*handler1, onGoaway(ErrorCode::NO\_ERROR));
1295   EXPECT\_CALL(*handler2, onGoaway(ErrorCode::NO\_ERROR));
1296   \textcolor{comment}{// The original byteEventTracker will process the last byte event of the}
1297   \textcolor{comment}{// first transaction, and detach by deleting the event.  Swap out the tracker.}
1298   handler1->expectDetachTransaction([\textcolor{keyword}{this}] \{
1299       \textcolor{keyword}{auto} tracker = std::make\_unique<ByteEventTracker>(httpSession\_);
1300       httpSession\_->setByteEventTracker(std::move(tracker));
1301     \});
1302   \textcolor{comment}{// handler2 should also be detached immediately because the new}
1303   \textcolor{comment}{// ByteEventTracker continues procesing where the old one left off.}
1304   handler2->expectDetachTransaction();
1305   gracefulShutdown();
1306 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Test\+Tracked\+Byte\+Event\+Tracker)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Test\+Tracked\+Byte\+Event\+Tracker}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_aae5c3050a6d94cd9bafb06303ae69de0}


Definition at line 1308 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+H\+T\+T\+P\+Transaction\+::increment\+Pending\+Byte\+Events().


\begin{DoxyCode}
1308                                                                \{
1309   \textcolor{keyword}{auto} byteEventTracker = setMockByteEventTracker();
1310   InSequence enforceOrder;
1311 
1312   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
1313   \textcolor{keywordtype}{size\_t} bytesToSend = 200;
1314   \textcolor{keywordtype}{size\_t} expectedTrackedByteOffset = bytesToSend + 99;
1315   handler1->expectHeaders();
1316   handler1->expectEOM([&handler1, &bytesToSend] () \{
1317     handler1->sendHeaders(200, 200);
1318     handler1->sendBodyWithLastByteTracking(bytesToSend);
1319     handler1->txn\_->sendEOM();
1320     \});
1321 
1322   EXPECT\_CALL(*byteEventTracker,
1323     addTrackedByteEvent(\_, expectedTrackedByteOffset))
1324       .WillOnce(Invoke([] (HTTPTransaction* txn,
1325                            uint64\_t \textcolor{comment}{/*byteNo*/}) \{
1326                          txn->incrementPendingByteEvents();
1327                        \}));
1328   sendRequest();
1329   flushRequestsAndLoop();
1330   handler1->expectDetachTransaction();
1331   handler1->txn\_->decrementPendingByteEvents();
1332   gracefulShutdown();
1333 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Trailers)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Trailers}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a116b13dbb86e84f967bf53a2d0e47da7}


Definition at line 1335 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
1335                                              \{
1336   InSequence enforceOrder;
1337 
1338   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
1339   handler->expectHeaders();
1340   handler->expectEOM([&handler]() \{
1341     handler->sendReplyWithBody(
1342         200, 100, \textcolor{keyword}{true} \textcolor{comment}{/* keepalive */}, \textcolor{keyword}{true} \textcolor{comment}{/* sendEOM */}, \textcolor{keyword}{true} \textcolor{comment}{/*trailers*/});
1343   \});
1344   handler->expectDetachTransaction();
1345 
1346   HTTPSession::DestructorGuard g(httpSession\_);
1347   sendRequest();
1348   flushRequestsAndLoop(\textcolor{keyword}{true}, milliseconds(0));
1349 
1350   EXPECT\_CALL(callbacks\_, onMessageBegin(1, \_)).Times(1);
1351   EXPECT\_CALL(callbacks\_, onHeadersComplete(1, \_)).Times(1);
1352   EXPECT\_CALL(callbacks\_, onBody(1, \_, \_));
1353   EXPECT\_CALL(callbacks\_, onTrailersComplete(1, \_));
1354   EXPECT\_CALL(callbacks\_, onMessageComplete(1, \_));
1355 
1356   parseOutput(*clientCodec\_);
1357   expectDetachSession();
1358 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Trailers)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Trailers}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a2185cdeea53ad95ec99e9484a8fccd5a}


Definition at line 1360 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
1360                                             \{
1361   testChunks(\textcolor{keyword}{true});
1362 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Explicit\+Chunks)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Explicit\+Chunks}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a0973000c857bddd45a197ae643462773}


Definition at line 1364 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
1364                                                   \{
1365   testChunks(\textcolor{keyword}{false});
1366 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Drain)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Drain}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_af00f8aeaac9df12897fb891141e55949}


Definition at line 1401 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
1401                                              \{
1402   InSequence enforceOrder;
1403 
1404   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
1405   handler1->expectHeaders([\textcolor{keyword}{this}, &handler1] \{
1406       handler1->sendHeaders(200, 100);
1407       httpSession\_->notifyPendingShutdown();
1408     \});
1409   handler1->expectEOM([&handler1] \{
1410       handler1->sendBody(100);
1411       handler1->txn\_->sendEOM();
1412     \});
1413   handler1->expectDetachTransaction();
1414 
1415   \textcolor{keyword}{auto} handler2 = addSimpleStrictHandler();
1416   handler2->expectHeaders([&handler2] \{
1417       handler2->sendHeaders(200, 100);
1418     \});
1419   handler2->expectEOM([&handler2] \{
1420           handler2->sendBody(100);
1421           handler2->txn\_->sendEOM();
1422     \});
1423   handler2->expectDetachTransaction();
1424 
1425   expectDetachSession();
1426 
1427   sendRequest();
1428   sendRequest();
1429   flushRequestsAndLoop();
1430 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Drain\+Long\+Running)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Drain\+Long\+Running}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a614cc2510001b91b28b3c9f51eab1439}


Definition at line 1436 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
1436                                                         \{
1437   InSequence enforceSequence;
1438 
1439   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
1440   handler->expectHeaders([\textcolor{keyword}{this}, &handler] \{
1441       httpSession\_->notifyPendingShutdown();
1442       eventBase\_.tryRunAfterDelay([\textcolor{keyword}{this}] \{
1443           \textcolor{comment}{// simulate read timeout}
1444           httpSession\_->timeoutExpired();
1445         \}, 100);
1446       eventBase\_.tryRunAfterDelay([&handler] \{
1447           handler->sendReplyWithBody(200, 100);
1448         \}, 200);
1449     \});
1450   handler->expectEOM();
1451   handler->expectDetachTransaction();
1452 
1453   expectDetachSession();
1454 
1455   sendRequest();
1456   flushRequestsAndLoop();
1457 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Early\+Abort)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Early\+Abort}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a2c0a1da6dd136533070325cc153fd3e5}


Definition at line 1459 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+H\+T\+T\+P\+Transaction\+::send\+Abort().


\begin{DoxyCode}
1459                                               \{
1460   StrictMock<MockHTTPHandler> handler;
1461 
1462   InSequence enforceOrder;
1463   EXPECT\_CALL(mockController\_, getRequestHandler(\_, \_))
1464     .WillOnce(Return(&handler));
1465 
1466   EXPECT\_CALL(handler, setTransaction(\_))
1467     .WillOnce(Invoke([&] (HTTPTransaction* txn) \{
1468           handler.txn\_ = txn;
1469           handler.txn\_->sendAbort();
1470         \}));
1471   handler.expectDetachTransaction();
1472   expectDetachSession();
1473 
1474   addSingleByteReads(\textcolor{stringliteral}{"GET /somepath.php?param=foo HTTP/1.1\(\backslash\)r\(\backslash\)n"}
1475                      \textcolor{stringliteral}{"Host: example.com\(\backslash\)r\(\backslash\)n"}
1476                      \textcolor{stringliteral}{"Connection: close\(\backslash\)r\(\backslash\)n"}
1477                      \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
1478   transport\_->addReadEOF(milliseconds(0));
1479   transport\_->startReadEvents();
1480   eventBase\_.loop();
1481 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+S\+P\+D\+Y3\+Downstream\+Session\+Test, Http\+Paused\+Buffered)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf S\+P\+D\+Y3\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Paused\+Buffered}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_ae0eead9f887860f7af10647eb12bf84f}


Definition at line 1483 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+Exception\+::get\+Proxygen\+Error(), and proxygen\+::k\+Error\+Stream\+Abort.


\begin{DoxyCode}
1483                                                        \{
1484   IOBufQueue rst\{IOBufQueue::cacheChainLength()\};
1485   \textcolor{keyword}{auto} s = sendRequest();
1486   clientCodec\_->generateRstStream(rst, s, ErrorCode::CANCEL);
1487   sendRequest();
1488 
1489   InSequence handlerSequence;
1490   \textcolor{keyword}{auto} handler1 = addSimpleNiceHandler();
1491   handler1->expectHeaders();
1492   handler1->expectEOM([&handler1, \textcolor{keyword}{this}] \{
1493       transport\_->pauseWrites();
1494       handler1->sendHeaders(200, 65536 * 2);
1495       handler1->sendBody(65536 * 2);
1496     \});
1497   handler1->expectEgressPaused();
1498   \textcolor{keyword}{auto} handler2 = addSimpleNiceHandler();
1499   handler2->expectEgressPaused();
1500   handler2->expectHeaders();
1501   handler2->expectEOM([&] \{
1502       eventBase\_.runInLoop([&] \{
1503           transport\_->addReadEvent(rst, milliseconds(0)); \});
1504     \});
1505   handler1->expectError([&] (\textcolor{keyword}{const} HTTPException& ex) \{
1506       ASSERT\_EQ(ex.getProxygenError(), kErrorStreamAbort);
1507       resumeWritesInLoop();
1508     \});
1509   handler1->expectDetachTransaction();
1510   handler2->expectEgressResumed([&] \{
1511       handler2->sendReplyWithBody(200, 32768);
1512     \});
1513   handler2->expectDetachTransaction([\textcolor{keyword}{this}] \{
1514       eventBase\_.runInLoop([&] \{ transport\_->addReadEOF(milliseconds(0)); \});
1515     \});
1516   expectDetachSession();
1517 
1518   flushRequestsAndLoop();
1519 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Writes\+Draining\+Timeout)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Writes\+Draining\+Timeout}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_ab3321967fa68e82e62e13d121c7251ba}


Definition at line 1521 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+Exception\+::get\+Proxygen\+Error(), proxygen\+::k\+Error\+Write\+Timeout, and proxygen\+::\+Exception\+::what().


\begin{DoxyCode}
1521                                                              \{
1522   sendRequest();
1523   sendHeader();
1524 
1525   InSequence handlerSequence;
1526   \textcolor{keyword}{auto} handler1 = addSimpleNiceHandler();
1527   handler1->expectHeaders();
1528   handler1->expectEOM([&handler1, \textcolor{keyword}{this}] \{
1529       transport\_->pauseWrites();
1530       handler1->sendHeaders(200, 1000);
1531     \});
1532   handler1->expectError([&] (\textcolor{keyword}{const} HTTPException& ex) \{
1533       ASSERT\_EQ(ex.getProxygenError(), kErrorWriteTimeout);
1534       ASSERT\_EQ(
1535         folly::to<std::string>(\textcolor{stringliteral}{"WriteTimeout on transaction id: "},
1536                                handler1->txn\_->getID()),
1537         std::string(ex.what()));
1538       handler1->txn\_->sendAbort();
1539     \});
1540   handler1->expectDetachTransaction();
1541   expectDetachSession();
1542 
1543   flushRequestsAndLoop();
1544 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Rate\+Limit\+Normal)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Rate\+Limit\+Normal}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_aaabb78412a40799953a206e4870f5dc5}


Definition at line 1546 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::milliseconds\+Between().


\begin{DoxyCode}
1546                                                        \{
1547   \textcolor{comment}{// The rate-limiting code grabs the event base from the EventBaseManager,}
1548   \textcolor{comment}{// so we need to set it.}
1549   folly::EventBaseManager::get()->setEventBase(&eventBase\_, \textcolor{keyword}{false});
1550 
1551   \textcolor{comment}{// Create a request}
1552   sendRequest();
1553 
1554   InSequence handlerSequence;
1555 
1556   \textcolor{comment}{// Set a low rate-limit on the transaction}
1557   \textcolor{keyword}{auto} handler1 = addSimpleNiceHandler();
1558   handler1->expectHeaders([&] \{
1559       uint32\_t rateLimit\_kbps = 640;
1560       handler1->txn\_->setEgressRateLimit(rateLimit\_kbps * 1024);
1561     \});
1562   \textcolor{comment}{// Send a somewhat big response that we know will get rate-limited}
1563   handler1->expectEOM([&handler1] \{
1564       \textcolor{comment}{// At 640kbps, this should take slightly over 800ms}
1565       uint32\_t rspLengthBytes = 100000;
1566       handler1->sendHeaders(200, rspLengthBytes);
1567       handler1->sendBody(rspLengthBytes);
1568       handler1->txn\_->sendEOM();
1569     \});
1570   handler1->expectDetachTransaction();
1571 
1572   \textcolor{comment}{// Keep the session around even after the event base loop completes so we can}
1573   \textcolor{comment}{// read the counters on a valid object.}
1574   HTTPSession::DestructorGuard g(httpSession\_);
1575   flushRequestsAndLoop();
1576 
1577   proxygen::TimePoint timeFirstWrite =
1578     transport\_->getWriteEvents()->front()->getTime();
1579   proxygen::TimePoint timeLastWrite =
1580     transport\_->getWriteEvents()->back()->getTime();
1581   int64\_t writeDuration =
1582     (int64\_t)millisecondsBetween(timeLastWrite, timeFirstWrite).count();
1583   EXPECT\_GE(writeDuration, 800);
1584 
1585   cleanup();
1586 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+S\+P\+D\+Y3\+Downstream\+Session\+Test, Spdy\+Rate\+Limit\+Normal)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf S\+P\+D\+Y3\+Downstream\+Session\+Test}}]{, }
\item[{Spdy\+Rate\+Limit\+Normal}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a081f6cdb1dd101ed11b0848fcce934a2}


Definition at line 1588 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::milliseconds\+Between().


\begin{DoxyCode}
1588                                                         \{
1589   \textcolor{comment}{// The rate-limiting code grabs the event base from the EventBaseManager,}
1590   \textcolor{comment}{// so we need to set it.}
1591   folly::EventBaseManager::get()->setEventBase(&eventBase\_, \textcolor{keyword}{false});
1592 
1593   clientCodec\_->getEgressSettings()->setSetting(SettingsId::INITIAL\_WINDOW\_SIZE,
1594                                                 100000);
1595   clientCodec\_->generateSettings(requests\_);
1596   sendRequest();
1597 
1598   InSequence handlerSequence;
1599   \textcolor{keyword}{auto} handler1 = addSimpleNiceHandler();
1600   handler1->expectHeaders([&] \{
1601       uint32\_t rateLimit\_kbps = 640;
1602       handler1->txn\_->setEgressRateLimit(rateLimit\_kbps * 1024);
1603     \});
1604 
1605   handler1->expectEOM([&handler1] \{
1606       \textcolor{comment}{// At 640kbps, this should take slightly over 800ms}
1607       uint32\_t rspLengthBytes = 100000;
1608       handler1->sendHeaders(200, rspLengthBytes);
1609       handler1->sendBody(rspLengthBytes);
1610       handler1->txn\_->sendEOM();
1611     \});
1612   handler1->expectDetachTransaction();
1613 
1614   \textcolor{comment}{// Keep the session around even after the event base loop completes so we can}
1615   \textcolor{comment}{// read the counters on a valid object.}
1616   HTTPSession::DestructorGuard g(httpSession\_);
1617   flushRequestsAndLoop(\textcolor{keyword}{true}, milliseconds(50));
1618 
1619   proxygen::TimePoint timeFirstWrite =
1620     transport\_->getWriteEvents()->front()->getTime();
1621   proxygen::TimePoint timeLastWrite =
1622     transport\_->getWriteEvents()->back()->getTime();
1623   int64\_t writeDuration =
1624     (int64\_t)millisecondsBetween(timeLastWrite, timeFirstWrite).count();
1625   EXPECT\_GE(writeDuration, 800);
1626   expectDetachSession();
1627 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+S\+P\+D\+Y3\+Downstream\+Session\+Test, Spdy\+Rate\+Limit\+Rst)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf S\+P\+D\+Y3\+Downstream\+Session\+Test}}]{, }
\item[{Spdy\+Rate\+Limit\+Rst}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a189d92233d9b34b75ce604793530d591}
This test will reset the connection while the server is waiting around to send more bytes (so as to keep under the rate limit). 

Definition at line 1633 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References stream\+ID.


\begin{DoxyCode}
1633                                                      \{
1634   \textcolor{comment}{// The rate-limiting code grabs the event base from the EventBaseManager,}
1635   \textcolor{comment}{// so we need to set it.}
1636   folly::EventBaseManager::get()->setEventBase(&eventBase\_, \textcolor{keyword}{false});
1637 
1638   IOBufQueue rst\{IOBufQueue::cacheChainLength()\};
1639   clientCodec\_->getEgressSettings()->setSetting(SettingsId::INITIAL\_WINDOW\_SIZE,
1640                                                 100000);
1641   clientCodec\_->generateSettings(requests\_);
1642   \textcolor{keyword}{auto} streamID = sendRequest();
1643   clientCodec\_->generateRstStream(rst, streamID, ErrorCode::CANCEL);
1644 
1645   InSequence handlerSequence;
1646   \textcolor{keyword}{auto} handler1 = addSimpleNiceHandler();
1647   handler1->expectHeaders([&] \{
1648       uint32\_t rateLimit\_kbps = 640;
1649       handler1->txn\_->setEgressRateLimit(rateLimit\_kbps * 1024);
1650     \});
1651   handler1->expectEOM([&handler1] \{
1652       uint32\_t rspLengthBytes = 100000;
1653       handler1->sendHeaders(200, rspLengthBytes);
1654       handler1->sendBody(rspLengthBytes);
1655       handler1->txn\_->sendEOM();
1656     \});
1657   handler1->expectError();
1658   handler1->expectDetachTransaction();
1659   expectDetachSession();
1660 
1661   flushRequestsAndLoop(\textcolor{keyword}{true}, milliseconds(50), milliseconds(0), [&] \{
1662       transport\_->addReadEvent(rst, milliseconds(10));
1663     \});
1664 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Write\+Timeout)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Write\+Timeout}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a84e5bb1f3070ab9080d20752d1ec84ef}


Definition at line 1669 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Get\+Request(), proxygen\+::\+Exception\+::get\+Proxygen\+Error(), proxygen\+::k\+Error\+Write\+Timeout, proxygen\+::\+H\+T\+T\+P\+Message\+::set\+H\+T\+T\+P\+Version(), and proxygen\+::\+Exception\+::what().


\begin{DoxyCode}
1669                                                 \{
1670   HTTPMessage req = getGetRequest();
1671   req.setHTTPVersion(1, 0);
1672   sendRequest(req);
1673 
1674   InSequence handlerSequence;
1675   \textcolor{keyword}{auto} handler1 = addSimpleNiceHandler();
1676   handler1->expectHeaders();
1677   handler1->expectEOM([&handler1, \textcolor{keyword}{this}] \{
1678       handler1->sendHeaders(200, 100);
1679       eventBase\_.tryRunAfterDelay([&handler1, \textcolor{keyword}{this}] \{
1680           transport\_->pauseWrites();
1681           handler1->sendBody(100);
1682           handler1->txn\_->sendEOM();
1683         \}, 50);
1684     \});
1685   handler1->expectError([&] (\textcolor{keyword}{const} HTTPException& ex) \{
1686       ASSERT\_EQ(ex.getProxygenError(), kErrorWriteTimeout);
1687       ASSERT\_EQ(folly::to<std::string>(\textcolor{stringliteral}{"WriteTimeout on transaction id: "},
1688                                        handler1->txn\_->getID()),
1689                 std::string(ex.what()));
1690     \});
1691   handler1->expectDetachTransaction();
1692 
1693   expectDetachSession();
1694 
1695   flushRequestsAndLoop();
1696 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Write\+Timeout\+Pipeline)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Write\+Timeout\+Pipeline}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_ac9c091a6e8e4fbf4a2a25c3196964fc9}


Definition at line 1699 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+Exception\+::get\+Proxygen\+Error(), proxygen\+::k\+Error\+Write\+Timeout, and proxygen\+::\+Exception\+::what().


\begin{DoxyCode}
1699                                                         \{
1700   \textcolor{keyword}{const} \textcolor{keywordtype}{char}* buf = \textcolor{stringliteral}{"GET / HTTP/1.1\(\backslash\)r\(\backslash\)nHost: localhost\(\backslash\)r\(\backslash\)n\(\backslash\)r\(\backslash\)n"}
1701     \textcolor{stringliteral}{"GET / HTTP/1.1\(\backslash\)r\(\backslash\)nHost: localhost\(\backslash\)r\(\backslash\)n\(\backslash\)r\(\backslash\)n"};
1702   requests\_.append(buf, strlen(buf));
1703 
1704   InSequence handlerSequence;
1705   \textcolor{keyword}{auto} handler1 = addSimpleNiceHandler();
1706   handler1->expectHeaders();
1707   handler1->expectEOM([&handler1, \textcolor{keyword}{this}] \{
1708       handler1->sendHeaders(200, 100);
1709       eventBase\_.tryRunAfterDelay([&handler1, \textcolor{keyword}{this}] \{
1710           transport\_->pauseWrites();
1711           handler1->sendBody(100);
1712           handler1->txn\_->sendEOM();
1713         \}, 50);
1714     \});
1715   \textcolor{keyword}{auto} handler2 = addSimpleNiceHandler();
1716   handler2->expectHeaders();
1717   handler2->expectEOM();
1718   handler1->expectError([&] (\textcolor{keyword}{const} HTTPException& ex) \{
1719       ASSERT\_EQ(ex.getProxygenError(), kErrorWriteTimeout);
1720       ASSERT\_EQ(folly::to<std::string>(\textcolor{stringliteral}{"WriteTimeout on transaction id: "},
1721                                        handler1->txn\_->getID()),
1722                 std::string(ex.what()));
1723       handler1->txn\_->sendAbort();
1724     \});
1725   handler2->expectError([&] (\textcolor{keyword}{const} HTTPException& ex) \{
1726       ASSERT\_EQ(ex.getProxygenError(), kErrorWriteTimeout);
1727       ASSERT\_EQ(folly::to<std::string>(\textcolor{stringliteral}{"WriteTimeout on transaction id: "},
1728                                        handler2->txn\_->getID()),
1729                 std::string(ex.what()));
1730       handler2->txn\_->sendAbort();
1731     \});
1732   handler2->expectDetachTransaction();
1733   handler1->expectDetachTransaction();
1734   expectDetachSession();
1735 
1736   flushRequestsAndLoop();
1737 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Body\+Packetization)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Body\+Packetization}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a985b70d28afda63b2cd89810844622a8}


Definition at line 1739 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Get\+Request(), proxygen\+::\+H\+T\+T\+P\+Message\+::set\+H\+T\+T\+P\+Version(), and proxygen\+::\+H\+T\+T\+P\+Message\+::set\+Wants\+Keepalive().


\begin{DoxyCode}
1739                                                      \{
1740   HTTPMessage req = getGetRequest();
1741   req.setHTTPVersion(1, 0);
1742   req.setWantsKeepalive(\textcolor{keyword}{false});
1743   sendRequest(req);
1744 
1745   InSequence handlerSequence;
1746   \textcolor{keyword}{auto} handler1 = addSimpleNiceHandler();
1747   handler1->expectHeaders();
1748   handler1->expectEOM([&handler1] \{
1749       handler1->sendReplyWithBody(200, 32768);
1750     \});
1751   handler1->expectDetachTransaction();
1752 
1753   expectDetachSession();
1754 
1755   \textcolor{comment}{// Keep the session around even after the event base loop completes so we can}
1756   \textcolor{comment}{// read the counters on a valid object.}
1757   HTTPSession::DestructorGuard g(httpSession\_);
1758   flushRequestsAndLoop();
1759 
1760   EXPECT\_EQ(transport\_->getWriteEvents()->size(), 1);
1761 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Malformed\+Pkt1)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Malformed\+Pkt1}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_ad50eaa5cc4873e137510020ef387708d}


Definition at line 1763 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
1763                                                      \{
1764   \textcolor{comment}{// Create a HTTP connection and keep sending just '\(\backslash\)n' to the HTTP1xCodec.}
1765   std::string data(90000, \textcolor{charliteral}{'\(\backslash\)n'});
1766   requests\_.append(data.data(), data.length());
1767 
1768   expectDetachSession();
1769 
1770   flushRequestsAndLoop(\textcolor{keyword}{true}, milliseconds(0));
1771 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Big\+Explcit\+Chunk\+Write)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Big\+Explcit\+Chunk\+Write}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a2a6e3fc359839cb3d67cc9be0cad2fe8}


Definition at line 1773 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References make\+Buf().


\begin{DoxyCode}
1773                                                         \{
1774   \textcolor{comment}{// even when the handler does a massive write, the transport only gets small}
1775   \textcolor{comment}{// writes}
1776   sendRequest();
1777 
1778   \textcolor{keyword}{auto} handler = addSimpleNiceHandler();
1779   handler->expectHeaders([&handler] \{
1780       handler->sendHeaders(200, 100, \textcolor{keyword}{false});
1781       \textcolor{keywordtype}{size\_t} len = 16 * 1024 * 1024;
1782       handler->txn\_->sendChunkHeader(len);
1783       \textcolor{keyword}{auto} chunk = makeBuf(len);
1784       handler->txn\_->sendBody(std::move(chunk));
1785       handler->txn\_->sendChunkTerminator();
1786       handler->txn\_->sendEOM();
1787     \});
1788   handler->expectDetachTransaction();
1789 
1790   expectDetachSession();
1791 
1792   \textcolor{comment}{// Keep the session around even after the event base loop completes so we can}
1793   \textcolor{comment}{// read the counters on a valid object.}
1794   HTTPSession::DestructorGuard g(httpSession\_);
1795   flushRequestsAndLoop();
1796 
1797   EXPECT\_GT(transport\_->getWriteEvents()->size(), 250);
1798 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Upgrade\+Non\+Native)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Upgrade\+Non\+Native}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a15e15667d4aa89d50b24c26d24c3f685}


Definition at line 1804 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Upgrade\+Request().


\begin{DoxyCode}
1804                                                         \{
1805   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
1806 
1807   handler->expectHeaders([&handler] \{
1808       handler->sendHeaders(101, 0, \textcolor{keyword}{true}, \{\{\textcolor{stringliteral}{"Upgrade"}, \textcolor{stringliteral}{"blarf"}\}\});
1809     \});
1810   EXPECT\_CALL(*handler, onUpgrade(UpgradeProtocol::TCP));
1811   handler->expectEOM([&handler] \{
1812       handler->txn\_->sendEOM();
1813     \});
1814   handler->expectDetachTransaction();
1815 
1816   sendRequest(getUpgradeRequest(\textcolor{stringliteral}{"blarf"}));
1817   expectDetachSession();
1818   flushRequestsAndLoop(\textcolor{keyword}{true});
1819 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Upgrade\+Non\+Native\+Ignore)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Upgrade\+Non\+Native\+Ignore}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a4d4d8447834a8f48c62da4a71d733b13}


Definition at line 1823 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Upgrade\+Request().


\begin{DoxyCode}
1823                                                               \{
1824   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
1825 
1826   handler->expectHeaders([&handler] \{
1827       handler->sendReplyWithBody(200, 100);
1828     \});
1829   handler->expectEOM();
1830   handler->expectDetachTransaction();
1831 
1832   sendRequest(getUpgradeRequest(\textcolor{stringliteral}{"blarf"}));
1833 
1834   expectDetachSession();
1835   flushRequestsAndLoop(\textcolor{keyword}{true});
1836 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Upgrade\+Non\+Native\+Pipeline)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Upgrade\+Non\+Native\+Pipeline}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a0f83b4c3e10e828e47f4602dde8aad7f}


Definition at line 1840 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Upgrade\+Request().


\begin{DoxyCode}
1840                                                                 \{
1841   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
1842 
1843   handler1->expectHeaders([&handler1] (std::shared\_ptr<HTTPMessage> msg) \{
1844       EXPECT\_EQ(msg->getHeaders().getSingleOrEmpty(HTTP\_HEADER\_UPGRADE),
1845                 \textcolor{stringliteral}{"blarf"});
1846       handler1->sendReplyWithBody(200, 100);
1847     \});
1848   handler1->expectEOM();
1849   handler1->expectDetachTransaction();
1850 
1851   \textcolor{keyword}{auto} handler2 = addSimpleStrictHandler();
1852   handler2->expectHeaders([&handler2] \{
1853       handler2->sendReplyWithBody(200, 100);
1854     \});
1855   handler2->expectEOM();
1856   handler2->expectDetachTransaction();
1857 
1858   sendRequest(getUpgradeRequest(\textcolor{stringliteral}{"blarf"}));
1859   transport\_->addReadEvent(\textcolor{stringliteral}{"GET / HTTP/1.1\(\backslash\)r\(\backslash\)n"}
1860                            \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
1861   expectDetachSession();
1862   flushRequestsAndLoop(\textcolor{keyword}{true});
1863 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Upgrade\+Native3)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Upgrade\+Native3}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_acad627c6cc1ed3207fb664dda0696f4f}


Definition at line 1915 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
1915                                                       \{
1916   testSimpleUpgrade(\textcolor{stringliteral}{"spdy/3"}, CodecProtocol::SPDY\_3, \textcolor{stringliteral}{"spdy/3"});
1917 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Upgrade\+Native31)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Upgrade\+Native31}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_aefdc8fe84f001ca94a7bfdf5737e64b3}


Definition at line 1920 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
1920                                                        \{
1921   testSimpleUpgrade(\textcolor{stringliteral}{"spdy/3.1"}, CodecProtocol::SPDY\_3\_1, \textcolor{stringliteral}{"spdy/3.1"});
1922 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Upgrade\+Native\+H2)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Upgrade\+Native\+H2}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a51e0aea72e272c832a4b4ecbcec69eee}


Definition at line 1925 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
1925                                                        \{
1926   testSimpleUpgrade(\textcolor{stringliteral}{"h2c"}, CodecProtocol::HTTP\_2, \textcolor{stringliteral}{"h2c"});
1927 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Upgrade\+Flow\+Control\+Test, Upgrade\+H2\+Flowcontrol)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Upgrade\+Flow\+Control\+Test}}]{, }
\item[{Upgrade\+H2\+Flowcontrol}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a17ad0248695d404501c256262e5f93db}


Definition at line 1937 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
1937                                                                           \{
1938   testSimpleUpgrade(\textcolor{stringliteral}{"h2c"}, CodecProtocol::HTTP\_2, \textcolor{stringliteral}{"h2c"});
1939 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Upgrade\+Native\+Unknown)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Upgrade\+Native\+Unknown}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a702fcfb888ae7ac6e47be0e89ade1def}


Definition at line 1942 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
1942                                                             \{
1943   \textcolor{comment}{// This is maybe weird, the client asked for non-native as first choice,}
1944   \textcolor{comment}{// but we go native}
1945   testSimpleUpgrade(\textcolor{stringliteral}{"blarf, spdy/3.1, spdy/3"},
1946                     CodecProtocol::SPDY\_3\_1, \textcolor{stringliteral}{"spdy/3.1"});
1947 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Upgrade\+Native\+Whitespace)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Upgrade\+Native\+Whitespace}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_ae9d1a8158d07dcc876e40cb9df4781bd}


Definition at line 1950 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
1950                                                                \{
1951   testSimpleUpgrade(\textcolor{stringliteral}{" \(\backslash\)tspdy/3.1\(\backslash\)t , spdy/3"},
1952                     CodecProtocol::SPDY\_3\_1, \textcolor{stringliteral}{"spdy/3.1"});
1953 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Upgrade\+Native\+Junk)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Upgrade\+Native\+Junk}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_ad5f6849a7b6eaf535943fe68ab5a4811}


Definition at line 1956 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
1956                                                          \{
1957   testSimpleUpgrade(\textcolor{stringliteral}{",,,,   ,,\(\backslash\)t~^%$(*&@(@$^^*(,spdy/3"},
1958                     CodecProtocol::SPDY\_3, \textcolor{stringliteral}{"spdy/3"});
1959 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Upgrade\+Native\+Txn2)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Upgrade\+Native\+Txn2}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_ac3c4595abba9aac66ffbf4a8bef27f2f}


Definition at line 1962 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Get\+Request(), and proxygen\+::get\+Upgrade\+Request().


\begin{DoxyCode}
1962                                                          \{
1963   this->rawCodec\_->setAllowedUpgradeProtocols(\{\textcolor{stringliteral}{"spdy/3"}\});
1964   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
1965   handler1->expectHeaders();
1966   handler1->expectEOM([&handler1] \{
1967       handler1->sendReplyWithBody(200, 100);
1968     \});
1969   handler1->expectDetachTransaction();
1970   sendRequest(getGetRequest());
1971   flushRequestsAndLoop();
1972   expectResponse();
1973 
1974   \textcolor{keyword}{auto} handler2 = addSimpleStrictHandler();
1975   handler2->expectHeaders();
1976   handler2->expectEOM([&handler2] \{
1977       handler2->sendReplyWithBody(200, 100);
1978     \});
1979   handler2->expectDetachTransaction();
1980 
1981   sendRequest(getUpgradeRequest(\textcolor{stringliteral}{"spdy/3"}));
1982   flushRequestsAndLoop();
1983   expectResponse();
1984   gracefulShutdown();
1985 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Upgrade\+Native\+Post)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Upgrade\+Native\+Post}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a3f0f63759184255c8fba6075a658239b}


Definition at line 1988 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Upgrade\+Request(), make\+Buf(), and stream\+ID.


\begin{DoxyCode}
1988                                                          \{
1989   this->rawCodec\_->setAllowedUpgradeProtocols(\{\textcolor{stringliteral}{"spdy/3"}\});
1990   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
1991   handler->expectHeaders();
1992   handler->expectBody();
1993   EXPECT\_CALL(mockController\_, onSessionCodecChange(httpSession\_));
1994   handler->expectEOM([&handler] \{
1995       handler->sendReplyWithBody(200, 100);
1996     \});
1997   handler->expectDetachTransaction();
1998 
1999   HTTPMessage req = getUpgradeRequest(\textcolor{stringliteral}{"spdy/3"}, HTTPMethod::POST, 10);
2000   \textcolor{keyword}{auto} streamID = sendRequest(req, \textcolor{keyword}{false});
2001   clientCodec\_->generateBody(requests\_, streamID, makeBuf(10),
2002                              HTTPCodec::NoPadding, \textcolor{keyword}{true});
2003   \textcolor{comment}{// cheat and not sending EOM, it's a no-op}
2004   flushRequestsAndLoop();
2005   expect101(CodecProtocol::SPDY\_3, \textcolor{stringliteral}{"spdy/3"});
2006   expectResponse();
2007   gracefulShutdown();
2008 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Upgrade\+Native\+Post\+Early\+Resp)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Upgrade\+Native\+Post\+Early\+Resp}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a5a624550a2c43c3f02201d26e3e8b14b}


Definition at line 2011 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Upgrade\+Request(), make\+Buf(), and stream\+ID.


\begin{DoxyCode}
2011                                                                   \{
2012   this->rawCodec\_->setAllowedUpgradeProtocols(\{\textcolor{stringliteral}{"spdy/3"}\});
2013   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
2014   handler->expectHeaders([&handler] \{
2015       handler->sendReplyWithBody(200, 100);
2016     \});
2017   handler->expectBody();
2018   handler->expectEOM();
2019   handler->expectDetachTransaction();
2020 
2021   HTTPMessage req = getUpgradeRequest(\textcolor{stringliteral}{"spdy/3"}, HTTPMethod::POST, 10);
2022   \textcolor{keyword}{auto} streamID = sendRequest(req, \textcolor{keyword}{false});
2023   clientCodec\_->generateBody(requests\_, streamID, makeBuf(10),
2024                              HTTPCodec::NoPadding, \textcolor{keyword}{true});
2025   flushRequestsAndLoop();
2026   expectResponse();
2027   gracefulShutdown();
2028 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Upgrade\+Native\+Post\+Early\+Partial\+Resp)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Upgrade\+Native\+Post\+Early\+Partial\+Resp}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a4e75c7dc348c4b77ef657046339dc434}


Definition at line 2030 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Upgrade\+Request(), make\+Buf(), and stream\+ID.


\begin{DoxyCode}
2030                                                                          \{
2031   this->rawCodec\_->setAllowedUpgradeProtocols(\{\textcolor{stringliteral}{"spdy/3"}\});
2032   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
2033   handler->expectHeaders([&handler] \{
2034       handler->sendHeaders(200, 100);
2035     \});
2036   handler->expectBody();
2037   handler->expectEOM([&handler] \{
2038       handler->sendBody(100);
2039       handler->txn\_->sendEOM();
2040     \});
2041   handler->expectDetachTransaction();
2042 
2043   HTTPMessage req = getUpgradeRequest(\textcolor{stringliteral}{"spdy/3"}, HTTPMethod::POST, 10);
2044   \textcolor{keyword}{auto} streamID = sendRequest(req, \textcolor{keyword}{false});
2045   clientCodec\_->generateBody(requests\_, streamID, makeBuf(10),
2046                              HTTPCodec::NoPadding, \textcolor{keyword}{true});
2047   flushRequestsAndLoop();
2048   expectResponse();
2049   gracefulShutdown();
2050 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Upgrade\+Native\+Extra)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Upgrade\+Native\+Extra}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a2181a2cb2224b6d4e123a17bf0e1230b}


Definition at line 2054 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Upgrade\+Request().


\begin{DoxyCode}
2054                                                           \{
2055   this->rawCodec\_->setAllowedUpgradeProtocols(\{\textcolor{stringliteral}{"spdy/3"}\});
2056   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
2057   handler->expectHeaders();
2058   EXPECT\_CALL(mockController\_, onSessionCodecChange(httpSession\_));
2059   handler->expectEOM([&handler] \{
2060       handler->sendReplyWithBody(200, 100);
2061     \});
2062   handler->expectDetachTransaction();
2063 
2064   sendRequest(getUpgradeRequest(\textcolor{stringliteral}{"spdy/3"}));
2065   \textcolor{comment}{// It's a fatal to send this out on the HTTP1xCodec, so hack it manually}
2066   transport\_->addReadEvent(\textcolor{stringliteral}{"GET / HTTP/1.1\(\backslash\)r\(\backslash\)n"}
2067                            \textcolor{stringliteral}{"Upgrade: spdy/3\(\backslash\)r\(\backslash\)n"}
2068                            \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
2069   flushRequestsAndLoop();
2070   expect101(CodecProtocol::SPDY\_3, \textcolor{stringliteral}{"spdy/3"});
2071   expectResponse(200, ErrorCode::\_SPDY\_INVALID\_STREAM);
2072   gracefulShutdown();
2073 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Upgrade\+Native\+Post100)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Upgrade\+Native\+Post100}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a508db4f40165a34b98ec31dcd537dffd}


Definition at line 2080 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+H\+T\+T\+P\+Headers\+::add(), proxygen\+::\+H\+T\+T\+P\+Message\+::get\+Headers(), proxygen\+::get\+Upgrade\+Request(), make\+Buf(), and stream\+ID.


\begin{DoxyCode}
2080                                                             \{
2081   this->rawCodec\_->setAllowedUpgradeProtocols(\{\textcolor{stringliteral}{"spdy/3"}\});
2082   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
2083   handler->expectHeaders([&handler] \{
2084       handler->sendHeaders(100, 0);
2085     \});
2086   handler->expectBody();
2087   EXPECT\_CALL(mockController\_, onSessionCodecChange(httpSession\_));
2088   handler->expectEOM([&handler] \{
2089       handler->sendReplyWithBody(200, 100);
2090     \});
2091   handler->expectDetachTransaction();
2092 
2093   HTTPMessage req = getUpgradeRequest(\textcolor{stringliteral}{"spdy/3"}, HTTPMethod::POST, 10);
2094   req.getHeaders().add(HTTP\_HEADER\_EXPECT, \textcolor{stringliteral}{"100-continue"});
2095   \textcolor{keyword}{auto} streamID = sendRequest(req, \textcolor{keyword}{false});
2096   clientCodec\_->generateBody(requests\_, streamID, makeBuf(10),
2097                              HTTPCodec::NoPadding, \textcolor{keyword}{true});
2098   flushRequestsAndLoop();
2099   expect101(CodecProtocol::SPDY\_3, \textcolor{stringliteral}{"spdy/3"}, \textcolor{keyword}{true} \textcolor{comment}{/* expect 100 continue */});
2100   expectResponse();
2101   gracefulShutdown();
2102 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Upgrade\+Native\+Post100\+Late)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Upgrade\+Native\+Post100\+Late}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a05115355a41f9fc1c38914dd149ede81}


Definition at line 2104 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+H\+T\+T\+P\+Headers\+::add(), proxygen\+::\+H\+T\+T\+P\+Message\+::get\+Headers(), proxygen\+::get\+Upgrade\+Request(), make\+Buf(), and stream\+ID.


\begin{DoxyCode}
2104                                                                 \{
2105   this->rawCodec\_->setAllowedUpgradeProtocols(\{\textcolor{stringliteral}{"spdy/3"}\});
2106   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
2107   handler->expectHeaders();
2108   handler->expectBody();
2109   EXPECT\_CALL(mockController\_, onSessionCodecChange(httpSession\_));
2110   handler->expectEOM([&handler] \{
2111       handler->sendHeaders(100, 0);
2112       handler->sendReplyWithBody(200, 100);
2113     \});
2114   handler->expectDetachTransaction();
2115 
2116   HTTPMessage req = getUpgradeRequest(\textcolor{stringliteral}{"spdy/3"}, HTTPMethod::POST, 10);
2117   req.getHeaders().add(HTTP\_HEADER\_EXPECT, \textcolor{stringliteral}{"100-continue"});
2118   \textcolor{keyword}{auto} streamID = sendRequest(req, \textcolor{keyword}{false});
2119   clientCodec\_->generateBody(requests\_, streamID, makeBuf(10),
2120                              HTTPCodec::NoPadding, \textcolor{keyword}{true});
2121   flushRequestsAndLoop();
2122   expect101(CodecProtocol::SPDY\_3, \textcolor{stringliteral}{"spdy/3"});
2123   expectResponse(200, ErrorCode::NO\_ERROR, \textcolor{keyword}{true} \textcolor{comment}{/* expect 100 via SPDY */});
2124   gracefulShutdown();
2125 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+S\+P\+D\+Y3\+Downstream\+Session\+Test, Spdy\+Prio)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf S\+P\+D\+Y3\+Downstream\+Session\+Test}}]{, }
\item[{Spdy\+Prio}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_ae512610f1830113f12e8f3a8b96e2e63}


Definition at line 2128 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
2128                                              \{
2129   testPriorities(8);
2130 
2131   cleanup();
2132 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Upgrade\+Goaway\+Drain)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Upgrade\+Goaway\+Drain}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a15ade93ecb4951a0948bb8d391cc1adf}


Definition at line 2137 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Upgrade\+Request(), make\+Buf(), and stream\+ID.


\begin{DoxyCode}
2137                                                           \{
2138   this->rawCodec\_->setAllowedUpgradeProtocols(\{\textcolor{stringliteral}{"h2c"}\});
2139   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
2140   handler->expectHeaders();
2141   handler->expectBody();
2142   EXPECT\_CALL(mockController\_, onSessionCodecChange(httpSession\_));
2143   handler->expectEOM();
2144   handler->expectGoaway();
2145   handler->expectDetachTransaction();
2146 
2147   EXPECT\_CALL(mockController\_, getHeaderIndexingStrategy())
2148     .WillOnce(
2149       Return(&testH2IndexingStrat\_)
2150   );
2151 
2152   HTTPMessage req = getUpgradeRequest(\textcolor{stringliteral}{"h2c"}, HTTPMethod::POST, 10);
2153   HTTP2Codec::requestUpgrade(req);
2154   \textcolor{keyword}{auto} streamID = sendRequest(req, \textcolor{keyword}{false});
2155   clientCodec\_->generateBody(requests\_, streamID, makeBuf(10),
2156                              HTTPCodec::NoPadding, \textcolor{keyword}{true});
2157   \textcolor{comment}{// cheat and not sending EOM, it's a no-op}
2158 
2159   flushRequestsAndLoop();
2160   expect101(CodecProtocol::HTTP\_2, \textcolor{stringliteral}{"h2c"});
2161   clientCodec\_->generateConnectionPreface(requests\_);
2162   clientCodec\_->generateGoaway(requests\_, 0, ErrorCode::NO\_ERROR);
2163   flushRequestsAndLoop();
2164   eventBase\_.runInLoop([&handler] \{
2165       handler->sendReplyWithBody(200, 100);
2166     \});
2167   HTTPSession::DestructorGuard g(httpSession\_);
2168   eventBase\_.loop();
2169   expectResponse(200, ErrorCode::NO\_ERROR, \textcolor{keyword}{false}, \textcolor{keyword}{true});
2170   expectDetachSession();
2171 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+S\+P\+D\+Y3\+Downstream\+Session\+Test, Spdy\+Timeout)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf S\+P\+D\+Y3\+Downstream\+Session\+Test}}]{, }
\item[{Spdy\+Timeout}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a8d84cd2c15c73b7a4d54ceaa1a86447e}


Definition at line 2229 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
2229                                                 \{
2230   sendRequest();
2231   sendRequest();
2232 
2233   httpSession\_->setWriteBufferLimit(512);
2234 
2235   InSequence handlerSequence;
2236   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
2237   handler1->expectHeaders([\textcolor{keyword}{this}] \{ transport\_->pauseWrites(); \});
2238   handler1->expectEOM([&] \{
2239       handler1->sendHeaders(200, 1000);
2240       handler1->sendBody(1000);
2241     \});
2242   handler1->expectEgressPaused();
2243   \textcolor{keyword}{auto} handler2 = addSimpleStrictHandler();
2244   \textcolor{comment}{// handler2 is paused before it gets headers}
2245   handler2->expectEgressPaused();
2246   handler2->expectHeaders();
2247   handler2->expectEOM([\textcolor{keyword}{this}] \{
2248       \textcolor{comment}{// This transaction should start egress paused.  We've received the}
2249       \textcolor{comment}{// EOM, so the timeout shouldn't be running delay 400ms and resume}
2250       \textcolor{comment}{// writes, this keeps txn1 from getting a write timeout}
2251       resumeWritesAfterDelay(milliseconds(400));
2252     \});
2253   handler1->expectEgressResumed([&handler1] \{ handler1->txn\_->sendEOM(); \});
2254   handler2->expectEgressResumed([&handler2, \textcolor{keyword}{this}] \{
2255       \textcolor{comment}{// delay an additional 200ms.  The total 600ms delay shouldn't fire}
2256       \textcolor{comment}{// onTimeout}
2257       eventBase\_.tryRunAfterDelay([&handler2] \{
2258           handler2->sendReplyWithBody(200, 400); \}, 200
2259         );
2260     \});
2261   handler1->expectDetachTransaction();
2262   handler2->expectDetachTransaction();
2263 
2264   flushRequestsAndLoop(\textcolor{keyword}{false}, milliseconds(0), milliseconds(10));
2265 
2266   cleanup();
2267 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+S\+P\+D\+Y3\+Downstream\+Session\+Test, Spdy\+Timeout\+Win)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf S\+P\+D\+Y3\+Downstream\+Session\+Test}}]{, }
\item[{Spdy\+Timeout\+Win}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_ac09548532d7320ef3b80970d03688b6f}


Definition at line 2271 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+Exception\+::get\+Proxygen\+Error(), proxygen\+::k\+Error\+Write\+Timeout, stream\+ID, T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+\+P(), and proxygen\+::\+Exception\+::what().


\begin{DoxyCode}
2271                                                    \{
2272   clientCodec\_->getEgressSettings()->setSetting(SettingsId::INITIAL\_WINDOW\_SIZE,
2273                                                 500);
2274   clientCodec\_->generateSettings(requests\_);
2275   \textcolor{keyword}{auto} streamID = sendRequest();
2276 
2277   InSequence handlerSequence;
2278   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
2279   handler->expectHeaders();
2280   handler->expectEOM([&] \{
2281       handler->sendReplyWithBody(200, 1000);
2282     \});
2283   handler->expectEgressPaused();
2284   handler->expectError([&] (\textcolor{keyword}{const} HTTPException& ex) \{
2285       ASSERT\_EQ(ex.getProxygenError(), kErrorWriteTimeout);
2286       ASSERT\_EQ(
2287         folly::to<std::string>(\textcolor{stringliteral}{"ingress timeout, streamID="}, streamID),
2288         std::string(ex.what()));
2289       handler->terminate();
2290     \});
2291   handler->expectDetachTransaction();
2292 
2293   flushRequestsAndLoop();
2294 
2295   cleanup();
2296 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+S\+P\+D\+Y3\+Downstream\+Session\+Test, Spdy\+Max\+Concurrent\+Streams)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf S\+P\+D\+Y3\+Downstream\+Session\+Test}}]{, }
\item[{Spdy\+Max\+Concurrent\+Streams}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a874a6d9f2a889bae089fa2fe93f9f76a}


Definition at line 2484 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Get\+Request(), R\+E\+G\+I\+S\+T\+E\+R\+\_\+\+T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+\+P(), proxygen\+::\+H\+T\+T\+P\+Message\+::set\+H\+T\+T\+P\+Version(), and proxygen\+::\+H\+T\+T\+P\+Message\+::set\+Wants\+Keepalive().


\begin{DoxyCode}
2484                                                              \{
2485   HTTPMessage req = getGetRequest();
2486   req.setHTTPVersion(1, 0);
2487   req.setWantsKeepalive(\textcolor{keyword}{false});
2488   sendRequest(req);
2489   \textcolor{keyword}{auto} req2p = sendRequestLater(req, \textcolor{keyword}{true});
2490 
2491   httpSession\_->setEgressSettings(\{\{
2492         SettingsId::MAX\_CONCURRENT\_STREAMS, 1\}\});
2493 
2494   InSequence handlerSequence;
2495   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
2496   handler1->expectHeaders();
2497   handler1->expectEOM([&handler1, req, \textcolor{keyword}{this}, &req2p] \{
2498       transport\_->pauseWrites();
2499       handler1->sendReplyWithBody(200, 100);
2500       req2p.setValue();
2501     \});
2502   \textcolor{keyword}{auto} handler2 = addSimpleStrictHandler();
2503   handler2->expectHeaders();
2504   handler2->expectEOM([&handler2, \textcolor{keyword}{this}] \{
2505       handler2->sendReplyWithBody(200, 100);
2506       resumeWritesInLoop();
2507     \});
2508   handler1->expectDetachTransaction();
2509   handler2->expectDetachTransaction();
2510 
2511   expectDetachSession();
2512 
2513   flushRequestsAndLoop();
2514 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+S\+P\+D\+Y31\+Downstream\+Test, Test\+Session\+Flow\+Control)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf S\+P\+D\+Y31\+Downstream\+Test}}]{, }
\item[{Test\+Session\+Flow\+Control}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a7c4520be801a2a7039cb66dbeaf138a7}


Definition at line 2533 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::http2\+::k\+Initial\+Window.


\begin{DoxyCode}
2533                                                      \{
2534   eventBase\_.loopOnce();
2535 
2536   InSequence sequence;
2537   EXPECT\_CALL(callbacks\_, onSettings(\_));
2538   EXPECT\_CALL(callbacks\_, onWindowUpdate(0, spdy::kInitialWindow));
2539   parseOutput(*clientCodec\_);
2540 
2541   cleanup();
2542 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+S\+P\+D\+Y3\+Downstream\+Session\+Test, Test\+E\+O\+F\+On\+Blocked\+Stream)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf S\+P\+D\+Y3\+Downstream\+Session\+Test}}]{, }
\item[{Test\+E\+O\+F\+On\+Blocked\+Stream}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_af9cc8f6999d26e3414d0b96a2196b15e}


Definition at line 2544 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+H\+T\+T\+P\+Exception\+::get\+Direction().


\begin{DoxyCode}
2544                                                            \{
2545   sendRequest();
2546 
2547   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
2548 
2549   InSequence handlerSequence;
2550   handler1->expectHeaders();
2551   handler1->expectEOM([&handler1] \{
2552       handler1->sendReplyWithBody(200, 80000);
2553     \});
2554   handler1->expectEgressPaused();
2555 
2556   handler1->expectError([&] (\textcolor{keyword}{const} HTTPException& ex) \{
2557       \textcolor{comment}{// Not optimal to have a different error code here than the session}
2558       \textcolor{comment}{// flow control case, but HTTPException direction is immutable and}
2559       \textcolor{comment}{// building another one seems not future proof.}
2560       EXPECT\_EQ(ex.getDirection(), HTTPException::Direction::INGRESS);
2561     \});
2562   handler1->expectDetachTransaction();
2563 
2564   expectDetachSession();
2565 
2566   flushRequestsAndLoop(\textcolor{keyword}{true}, milliseconds(10));
2567 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+S\+P\+D\+Y31\+Downstream\+Test, Test\+E\+O\+F\+On\+Blocked\+Session)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf S\+P\+D\+Y31\+Downstream\+Test}}]{, }
\item[{Test\+E\+O\+F\+On\+Blocked\+Session}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_ab03e31f0d1c5e336a8930c644b5b849f}


Definition at line 2569 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+H\+T\+T\+P\+Exception\+::get\+Direction().


\begin{DoxyCode}
2569                                                       \{
2570   sendRequest();
2571   sendRequest();
2572 
2573   InSequence handlerSequence;
2574   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
2575   handler1->expectHeaders();
2576   handler1->expectEOM([&handler1] \{
2577       handler1->sendHeaders(200, 40000);
2578       handler1->sendBody(32769);
2579     \});
2580   \textcolor{keyword}{auto} handler2 = addSimpleStrictHandler();
2581   handler2->expectHeaders();
2582   handler2->expectEOM([&handler2, \textcolor{keyword}{this}] \{
2583       handler2->sendHeaders(200, 40000);
2584       handler2->sendBody(32768);
2585       eventBase\_.runInLoop([\textcolor{keyword}{this}] \{ transport\_->addReadEOF(milliseconds(0)); \});
2586     \});
2587 
2588   handler1->expectEgressPaused();
2589   handler2->expectEgressPaused();
2590   handler1->expectEgressResumed();
2591   handler2->expectEgressResumed();
2592   handler1->expectError([&] (\textcolor{keyword}{const} HTTPException& ex) \{
2593       EXPECT\_EQ(ex.getDirection(),
2594                 HTTPException::Direction::INGRESS\_AND\_EGRESS);
2595     \});
2596   handler1->expectDetachTransaction();
2597   handler2->expectError([&] (\textcolor{keyword}{const} HTTPException& ex) \{
2598       EXPECT\_EQ(ex.getDirection(),
2599                 HTTPException::Direction::INGRESS\_AND\_EGRESS);
2600     \});
2601   handler2->expectDetachTransaction();
2602 
2603   expectDetachSession();
2604 
2605   flushRequestsAndLoop();
2606 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+S\+P\+D\+Y3\+Downstream\+Session\+Test, New\+Txn\+Egress\+Paused)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf S\+P\+D\+Y3\+Downstream\+Session\+Test}}]{, }
\item[{New\+Txn\+Egress\+Paused}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_adc8b48d853e43c6e4a637998fdddedca}


Definition at line 2609 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Get\+Request().


\begin{DoxyCode}
2609                                                        \{
2610   \textcolor{comment}{// Send 1 request with prio=0}
2611   \textcolor{comment}{// Have egress pause while sending the first response}
2612   \textcolor{comment}{// Send a second request with prio=1}
2613   \textcolor{comment}{//   -- the new txn should start egress paused}
2614   \textcolor{comment}{// Finish the body and eom both responses}
2615   \textcolor{comment}{// Unpause egress}
2616   \textcolor{comment}{// The first txn should complete first}
2617 
2618   sendRequest(\textcolor{stringliteral}{"/"}, 0);
2619   \textcolor{keyword}{auto} req2 = getGetRequest();
2620   req2.setPriority(1);
2621   \textcolor{keyword}{auto} req2p = sendRequestLater(req2, \textcolor{keyword}{true});
2622 
2623   unique\_ptr<StrictMock<MockHTTPHandler>> handler1;
2624   unique\_ptr<StrictMock<MockHTTPHandler>> handler2;
2625 
2626   httpSession\_->setWriteBufferLimit(200); \textcolor{comment}{// lower the per session buffer limit}
2627   \{
2628     InSequence handlerSequence;
2629     handler1 = addSimpleStrictHandler();
2630     handler1->expectHeaders();
2631     handler1->expectEOM([&handler1, \textcolor{keyword}{this}, &req2p] \{
2632         this->transport\_->pauseWrites();
2633         handler1->sendHeaders(200, 1000);
2634         handler1->sendBody(100); \textcolor{comment}{// headers + 100 bytes - over the limit}
2635         req2p.setValue();
2636       \});
2637     handler1->expectEgressPaused([] \{ LOG(INFO) << \textcolor{stringliteral}{"paused 1"}; \});
2638 
2639     handler2 = addSimpleStrictHandler();
2640     handler2->expectEgressPaused(); \textcolor{comment}{// starts paused}
2641     handler2->expectHeaders();
2642     handler2->expectEOM([&] \{
2643         \textcolor{comment}{// Technically shouldn't send while handler is egress paused, but meh.}
2644         handler1->sendBody(900);
2645         handler1->txn\_->sendEOM();
2646         handler2->sendReplyWithBody(200, 1000);
2647         resumeWritesInLoop();
2648       \});
2649     handler1->expectDetachTransaction();
2650     handler2->expectDetachTransaction();
2651   \}
2652   HTTPSession::DestructorGuard g(httpSession\_);
2653   flushRequestsAndLoop();
2654 
2655   std::list<HTTPCodec::StreamID> streams;
2656   EXPECT\_CALL(callbacks\_, onMessageBegin(\_, \_))
2657     .Times(2);
2658   EXPECT\_CALL(callbacks\_, onHeadersComplete(\_, \_))
2659     .Times(2);
2660   \textcolor{comment}{// body is variable and hence ignored;}
2661   EXPECT\_CALL(callbacks\_, onMessageComplete(\_, \_))
2662       .WillRepeatedly(Invoke([&](HTTPCodec::StreamID stream, \textcolor{keywordtype}{bool} \textcolor{comment}{/*upgrade*/}) \{
2663         streams.push\_back(stream);
2664       \}));
2665   parseOutput(*clientCodec\_);
2666 
2667   cleanup();
2668 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Zero\+Delta\+Window\+Update)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Zero\+Delta\+Window\+Update}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_acffc18d9ed1f3430fbc0a3a905d3f595}


Definition at line 2670 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+H\+T\+T\+P\+Exception\+::get\+Codec\+Status\+Code(), proxygen\+::http2\+::k\+Frame\+Window\+Update\+Size, stream\+ID, and proxygen\+::\+Exception\+::what().


\begin{DoxyCode}
2670                                                           \{
2671   \textcolor{comment}{// generateHeader() will create a session and a transaction}
2672   \textcolor{keyword}{auto} streamID = sendHeader();
2673   \textcolor{comment}{// First generate a frame with delta=1 so as to pass the checks, and then}
2674   \textcolor{comment}{// hack the frame so that delta=0 without modifying other checks}
2675   clientCodec\_->generateWindowUpdate(requests\_, streamID, 1);
2676   requests\_.trimEnd(http2::kFrameWindowUpdateSize);
2677   QueueAppender appender(&requests\_, http2::kFrameWindowUpdateSize);
2678   appender.writeBE<uint32\_t>(0);
2679 
2680   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
2681 
2682   InSequence handlerSequence;
2683   handler->expectHeaders();
2684   handler->expectError([&] (\textcolor{keyword}{const} HTTPException& ex) \{
2685       ASSERT\_EQ(ex.getCodecStatusCode(), ErrorCode::PROTOCOL\_ERROR);
2686       ASSERT\_EQ(
2687         \textcolor{stringliteral}{"streamID=1 with HTTP2Codec stream error: window update delta=0"},
2688         std::string(ex.what()));
2689     \});
2690   handler->expectDetachTransaction();
2691   expectDetachSession();
2692 
2693   flushRequestsAndLoop();
2694 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Padding\+Flow\+Control)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Padding\+Flow\+Control}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a57b2ddbd1ca80b57ae2ef309b975cc7c}


Definition at line 2696 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References make\+Buf(), and stream\+ID.


\begin{DoxyCode}
2696                                                        \{
2697   \textcolor{comment}{// generateHeader() will create a session and a transaction}
2698   \textcolor{keyword}{auto} streamID = sendHeader();
2699   \textcolor{comment}{// This sends a total of 33kb including padding, so we should get a session}
2700   \textcolor{comment}{// and stream window update}
2701   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} i = 0; i < 129; i++) \{
2702     clientCodec\_->generateBody(requests\_, streamID, makeBuf(1), 255, \textcolor{keyword}{false});
2703   \}
2704 
2705   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
2706 
2707   InSequence handlerSequence;
2708   handler->expectHeaders([&] \{
2709       handler->txn\_->pauseIngress();
2710       eventBase\_.runAfterDelay([&] \{ handler->txn\_->resumeIngress(); \},
2711                                100);
2712     \});
2713   EXPECT\_CALL(*handler, onBody(\_))
2714     .Times(129);
2715   handler->expectError();
2716   handler->expectDetachTransaction();
2717 
2718   HTTPSession::DestructorGuard g(httpSession\_);
2719   flushRequestsAndLoop(\textcolor{keyword}{false}, milliseconds(0), milliseconds(0), [&] \{
2720       clientCodec\_->generateRstStream(requests\_, streamID, ErrorCode::CANCEL);
2721       clientCodec\_->generateGoaway(requests\_, 0, ErrorCode::NO\_ERROR);
2722       transport\_->addReadEvent(requests\_, milliseconds(110));
2723     \});
2724 
2725   std::list<HTTPCodec::StreamID> streams;
2726   EXPECT\_CALL(callbacks\_, onWindowUpdate(0, \_));
2727   EXPECT\_CALL(callbacks\_, onWindowUpdate(1, \_));
2728   parseOutput(*clientCodec\_);
2729   expectDetachSession();
2730 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Graceful\+Drain\+On\+Timeout)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Graceful\+Drain\+On\+Timeout}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a78dc1fb94e8c06d298d8b6fe6ff41c82}


Definition at line 2732 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Current\+Time().


\begin{DoxyCode}
2732                                                            \{
2733   InSequence handlerSequence;
2734   std::chrono::milliseconds gracefulTimeout(200);
2735   httpSession\_->enableDoubleGoawayDrain();
2736   EXPECT\_CALL(mockController\_, getGracefulShutdownTimeout())
2737     .WillOnce(InvokeWithoutArgs([&] \{
2738           \textcolor{comment}{// Once session asks for graceful shutdown timeout, expect the client}
2739           \textcolor{comment}{// to receive the first GOAWAY}
2740           eventBase\_.runInLoop([&] \{
2741               EXPECT\_CALL(callbacks\_,
2742                           onGoaway(std::numeric\_limits<int32\_t>::max(),
2743                                    ErrorCode::NO\_ERROR, \_));
2744               parseOutput(*clientCodec\_);
2745             \});
2746           \textcolor{keywordflow}{return} gracefulTimeout;
2747         \}));
2748 
2749 
2750   \textcolor{comment}{// Simulate ConnectionManager idle timeout}
2751   eventBase\_.runAfterDelay([&] \{ httpSession\_->timeoutExpired(); \},
2752                            transactionTimeouts\_->getDefaultTimeout().count());
2753   HTTPSession::DestructorGuard g(httpSession\_);
2754   \textcolor{keyword}{auto} start = getCurrentTime();
2755   eventBase\_.loop();
2756   \textcolor{keyword}{auto} finish = getCurrentTime();
2757   \textcolor{keyword}{auto} minDuration =
2758     gracefulTimeout + transactionTimeouts\_->getDefaultTimeout();
2759   EXPECT\_GE((finish - start).count(), minDuration.count());
2760   EXPECT\_CALL(callbacks\_, onGoaway(0, ErrorCode::NO\_ERROR, \_));
2761   parseOutput(*clientCodec\_);
2762   expectDetachSession();
2763 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Server\+Push)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Server\+Push}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a650b3d9ffba8e63437c6a13a9100bd1c}


Definition at line 2773 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Get\+Request(), proxygen\+::\+H\+T\+T\+P\+Message\+::get\+Headers(), make\+Buf(), proxygen\+::\+H\+T\+T\+P\+Headers\+::set(), proxygen\+::\+H\+T\+T\+P\+Message\+::set\+H\+T\+T\+P2\+Priority(), proxygen\+::\+H\+T\+T\+P\+Message\+::set\+Status\+Code(), proxygen\+::\+H\+T\+T\+P\+Message\+::set\+Status\+Message(), and proxygen\+::\+H\+T\+T\+P\+Message\+::set\+U\+R\+L().


\begin{DoxyCode}
2773                                                \{
2774   \textcolor{comment}{// Create a dummy request and a dummy response messages}
2775   HTTPMessage req, res;
2776   req.getHeaders().set(\textcolor{stringliteral}{"HOST"}, \textcolor{stringliteral}{"www.foo.com"});
2777   req.setURL(\textcolor{stringliteral}{"https://www.foo.com/"});
2778   res.setStatusCode(200);
2779   res.setStatusMessage(\textcolor{stringliteral}{"Ohai"});
2780 
2781   \textcolor{comment}{// enable server push}
2782   clientCodec\_->getEgressSettings()->setSetting(SettingsId::ENABLE\_PUSH, 1);
2783   clientCodec\_->generateSettings(requests\_);
2784   \textcolor{comment}{// generateHeader() will create a session and a transaction}
2785   \textcolor{keyword}{auto} assocStreamId = HTTPCodec::StreamID(1);
2786   clientCodec\_->generateHeader(requests\_, assocStreamId, getGetRequest(),
2787                                \textcolor{keyword}{false}, \textcolor{keyword}{nullptr});
2788 
2789   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
2790   StrictMock<MockHTTPPushHandler> pushHandler;
2791 
2792   InSequence handlerSequence;
2793   handler->expectHeaders([&] \{
2794       \textcolor{comment}{// Generate response for the associated stream}
2795       handler->txn\_->sendHeaders(res);
2796       handler->txn\_->sendBody(makeBuf(100));
2797       handler->txn\_->pauseIngress();
2798 
2799       \textcolor{keyword}{auto}* pushTxn = handler->txn\_->newPushedTransaction(&pushHandler);
2800       ASSERT\_NE(pushTxn, \textcolor{keyword}{nullptr});
2801       \textcolor{comment}{// Generate a push request (PUSH\_PROMISE)}
2802       \textcolor{keyword}{auto} outgoingStreams = httpSession\_->getNumOutgoingStreams();
2803       pushTxn->sendHeaders(req);
2804       EXPECT\_EQ(httpSession\_->getNumOutgoingStreams(), outgoingStreams);
2805       \textcolor{comment}{// Generate a push response}
2806       \textcolor{keyword}{auto} pri = handler->txn\_->getPriority();
2807       res.setHTTP2Priority(std::make\_tuple(pri.streamDependency,
2808                                            pri.exclusive, pri.weight));
2809       pushTxn->sendHeaders(res);
2810       EXPECT\_EQ(httpSession\_->getNumOutgoingStreams(), outgoingStreams + 1);
2811       pushTxn->sendBody(makeBuf(200));
2812       pushTxn->sendEOM();
2813 
2814       eventBase\_.runAfterDelay([&] \{ handler->txn\_->resumeIngress(); \},
2815                                100);
2816     \});
2817   EXPECT\_CALL(pushHandler, setTransaction(\_))
2818     .WillOnce(Invoke([&] (HTTPTransaction* txn) \{
2819           pushHandler.txn\_ = txn; \}));
2820   EXPECT\_CALL(pushHandler, detachTransaction());
2821   handler->expectError();
2822   handler->expectDetachTransaction();
2823 
2824   transport\_->addReadEvent(requests\_, milliseconds(0));
2825   clientCodec\_->generateRstStream(requests\_, assocStreamId, ErrorCode::CANCEL);
2826   clientCodec\_->generateGoaway(requests\_, 2, ErrorCode::NO\_ERROR);
2827   transport\_->addReadEvent(requests\_, milliseconds(200));
2828   transport\_->startReadEvents();
2829   HTTPSession::DestructorGuard g(httpSession\_);
2830   eventBase\_.loop();
2831 
2832   EXPECT\_CALL(callbacks\_, onMessageBegin(1, \_));
2833   EXPECT\_CALL(callbacks\_, onHeadersComplete(1, \_));
2834   EXPECT\_CALL(callbacks\_, onPushMessageBegin(2, 1, \_));
2835   EXPECT\_CALL(callbacks\_, onHeadersComplete(2, \_));
2836   EXPECT\_CALL(callbacks\_, onMessageBegin(2, \_));
2837   EXPECT\_CALL(callbacks\_, onHeadersComplete(2, \_));
2838   EXPECT\_CALL(callbacks\_, onMessageComplete(2, \_));
2839 
2840   parseOutput(*clientCodec\_);
2841   expectDetachSession();
2842 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Server\+Push\+Abort\+Paused)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Server\+Push\+Abort\+Paused}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_ab5a03b2511d4426afca62d6e108d490a}


Definition at line 2844 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Get\+Request(), proxygen\+::\+H\+T\+T\+P\+Message\+::get\+Headers(), make\+Buf(), proxygen\+::\+H\+T\+T\+P\+Headers\+::set(), proxygen\+::\+H\+T\+T\+P\+Message\+::set\+Status\+Code(), proxygen\+::\+H\+T\+T\+P\+Message\+::set\+Status\+Message(), and proxygen\+::\+H\+T\+T\+P\+Message\+::set\+U\+R\+L().


\begin{DoxyCode}
2844                                                           \{
2845   \textcolor{comment}{// Create a dummy request and a dummy response messages}
2846   HTTPMessage req, res;
2847   req.getHeaders().set(\textcolor{stringliteral}{"HOST"}, \textcolor{stringliteral}{"www.foo.com"});
2848   req.setURL(\textcolor{stringliteral}{"https://www.foo.com/"});
2849   res.setStatusCode(200);
2850   res.setStatusMessage(\textcolor{stringliteral}{"Ohai"});
2851 
2852   \textcolor{comment}{// enable server push}
2853   clientCodec\_->getEgressSettings()->setSetting(SettingsId::ENABLE\_PUSH, 1);
2854   clientCodec\_->generateSettings(requests\_);
2855   \textcolor{comment}{// generateHeader() will create a session and a transaction}
2856   \textcolor{keyword}{auto} assocStreamId = HTTPCodec::StreamID(1);
2857   clientCodec\_->generateHeader(requests\_, assocStreamId, getGetRequest(),
2858                                \textcolor{keyword}{false}, \textcolor{keyword}{nullptr});
2859 
2860   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
2861   StrictMock<MockHTTPPushHandler> pushHandler;
2862 
2863   InSequence handlerSequence;
2864   handler->expectHeaders([&] \{
2865       \textcolor{comment}{// Generate response for the associated stream}
2866       this->transport\_->pauseWrites();
2867       handler->txn\_->sendHeaders(res);
2868       handler->txn\_->sendBody(makeBuf(100));
2869       handler->txn\_->pauseIngress();
2870 
2871       \textcolor{keyword}{auto}* pushTxn = handler->txn\_->newPushedTransaction(&pushHandler);
2872       ASSERT\_NE(pushTxn, \textcolor{keyword}{nullptr});
2873       \textcolor{comment}{// Generate a push request (PUSH\_PROMISE)}
2874       pushTxn->sendHeaders(req);
2875     \});
2876   EXPECT\_CALL(pushHandler, setTransaction(\_))
2877     .WillOnce(Invoke([&] (HTTPTransaction* txn) \{
2878           pushHandler.txn\_ = txn; \}));
2879   EXPECT\_CALL(pushHandler, onError(\_));
2880   EXPECT\_CALL(pushHandler, detachTransaction());
2881   handler->expectError();
2882   handler->expectDetachTransaction();
2883 
2884   transport\_->addReadEvent(requests\_, milliseconds(0));
2885   \textcolor{comment}{// Cancels everything}
2886   clientCodec\_->generateRstStream(requests\_, assocStreamId, ErrorCode::CANCEL);
2887   transport\_->addReadEvent(requests\_, milliseconds(10));
2888   transport\_->startReadEvents();
2889   HTTPSession::DestructorGuard g(httpSession\_);
2890   eventBase\_.loop();
2891 
2892   parseOutput(*clientCodec\_);
2893   expectDetachSession();
2894 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Priority\+Weights\+Tiny\+Ratio)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Test\+Priority\+Weights\+Tiny\+Ratio}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a21170cd9d55dc655b726c0bbae014256}


Definition at line 2896 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+H\+T\+T\+P\+Transaction\+::\+Priority\+Sample\+Summary\+::\+Weighted\+Average\+::by\+Session\+Bytes\+\_\+, proxygen\+::\+H\+T\+T\+P\+Transaction\+::\+Priority\+Sample\+Summary\+::\+Weighted\+Average\+::by\+Transaction\+Bytes\+\_\+, proxygen\+::\+H\+T\+T\+P\+Transaction\+::\+Priority\+Sample\+Summary\+::contentions\+\_\+, proxygen\+::\+H\+T\+T\+P\+Transaction\+::\+Priority\+Sample\+Summary\+::depth\+\_\+, proxygen\+::\+H\+T\+T\+P\+Transaction\+::\+Priority\+Sample\+Summary\+::expected\+\_\+weight\+\_\+, proxygen\+::get\+Get\+Request(), and proxygen\+::\+H\+T\+T\+P\+Transaction\+::\+Priority\+Sample\+Summary\+::measured\+\_\+weight\+\_\+.


\begin{DoxyCode}
2896                                                                  \{
2897   \textcolor{comment}{// Create a transaction with egress and a ratio small enough that}
2898   \textcolor{comment}{// ratio*4096 < 1.}
2899   \textcolor{comment}{//}
2900   \textcolor{comment}{//     root}
2901   \textcolor{comment}{//     /  \(\backslash\)                                                 level 1}
2902   \textcolor{comment}{//   256   1 (no egress)}
2903   \textcolor{comment}{//        / \(\backslash\)                                               level 2}
2904   \textcolor{comment}{//      256  1  <-- has ratio (1/257)^2}
2905   InSequence enforceOrder;
2906   \textcolor{keyword}{auto} req1 = getGetRequest();
2907   \textcolor{keyword}{auto} req2 = getGetRequest();
2908   req1.setHTTP2Priority(HTTPMessage::HTTPPriority\{0, \textcolor{keyword}{false}, 255\});
2909   req2.setHTTP2Priority(HTTPMessage::HTTPPriority\{0, \textcolor{keyword}{false}, 0\});
2910 
2911   sendRequest(req1);
2912   \textcolor{keyword}{auto} id2 = sendRequest(req2);
2913   req1.setHTTP2Priority(HTTPMessage::HTTPPriority\{id2, \textcolor{keyword}{false}, 255\});
2914   req2.setHTTP2Priority(HTTPMessage::HTTPPriority\{id2, \textcolor{keyword}{false}, 0\});
2915   sendRequest(req1);
2916   sendRequest(req2);
2917 
2918   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
2919   handler1->expectHeaders();
2920   handler1->expectEOM([&] \{
2921       handler1->sendReplyWithBody(200, 4 * 1024);
2922     \});
2923   \textcolor{keyword}{auto} handler2 = addSimpleStrictHandler();
2924   handler2->expectHeaders();
2925   handler2->expectEOM();
2926   \textcolor{keyword}{auto} handler3 = addSimpleStrictHandler();
2927   handler3->expectHeaders();
2928   handler3->expectEOM([&] \{
2929       handler3->sendReplyWithBody(200, 15);
2930     \});
2931   \textcolor{keyword}{auto} handler4 = addSimpleStrictHandler();
2932   handler4->expectHeaders();
2933   handler4->expectEOM([&] \{
2934       handler4->sendReplyWithBody(200, 1);
2935     \});
2936 
2937   handler1->expectDetachTransaction([&] \{
2938       HTTPTransaction::PrioritySampleSummary summary;
2939       EXPECT\_EQ(handler1->txn\_->getPrioritySampleSummary(summary), \textcolor{keyword}{true});
2940       EXPECT\_EQ(handler1->txn\_->getTransport().getHTTP2PrioritiesEnabled(),
2941                 \textcolor{keyword}{true});
2942       \textcolor{comment}{// id1 had no egress when id2 was running, so id1 was contending only with}
2943       \textcolor{comment}{// id3 and id4. Average number of contentions for id1 is 3}
2944       EXPECT\_EQ(summary.contentions_.byTransactionBytes_, 3);
2945       EXPECT\_EQ(summary.contentions_.bySessionBytes_, 3);
2946       \textcolor{comment}{// this is a first level transaction, depth == 1}
2947       EXPECT\_EQ(summary.depth_.byTransactionBytes_, 1);
2948       EXPECT\_EQ(summary.depth_.bySessionBytes_, 1);
2949       \textcolor{comment}{// the expected relative weight is 256/257 ~= 0.9961}
2950       EXPECT\_GT(summary.expected_weight_, 0.996);
2951       EXPECT\_LT(summary.expected_weight_, 0.9962);
2952       \textcolor{comment}{// the measured relative weight is 4096/(4096+15) ~= 0.99635}
2953       \textcolor{comment}{// This value is higher than the expected relative weight of 0.9961.}
2954       \textcolor{comment}{// Due to the arithmetical rounding to the lowest integer, the measured}
2955       \textcolor{comment}{// relative weight tends to be higher for transactions with high relative}
2956       \textcolor{comment}{// weights and lower for transactions with the low relative weights.}
2957       EXPECT\_GT(summary.measured_weight_, 0.9963);
2958       EXPECT\_LT(summary.measured_weight_, 0.9964);
2959     \});
2960   handler3->expectDetachTransaction([&] \{
2961       HTTPTransaction::PrioritySampleSummary summary;
2962       EXPECT\_EQ(handler3->txn\_->getPrioritySampleSummary(summary), \textcolor{keyword}{true});
2963       EXPECT\_EQ(handler3->txn\_->getTransport().getHTTP2PrioritiesEnabled(),
2964                 \textcolor{keyword}{true});
2965       \textcolor{comment}{// Similarly, id3 was contenting with id1 and id4}
2966       \textcolor{comment}{// Average number of contentions for id3 is 3}
2967       EXPECT\_EQ(summary.contentions_.byTransactionBytes_, 3);
2968       EXPECT\_EQ(summary.contentions_.bySessionBytes_, 3);
2969       \textcolor{comment}{// this is a second level transaction where parent has}
2970       \textcolor{comment}{// no egress, depth == 2}
2971       EXPECT\_EQ(summary.depth_.byTransactionBytes_, 2);
2972       EXPECT\_EQ(summary.depth_.bySessionBytes_, 2);
2973       \textcolor{comment}{// the expected relative weight should be}
2974       \textcolor{comment}{// 1/257 * 256/257 ~= 0.00388. However, in the calculation of the}
2975       \textcolor{comment}{// allowed bytes to send we rounding to the lowest positive integer.}
2976       \textcolor{comment}{// Therefore, the measured relative weight tends to be less than}
2977       \textcolor{comment}{// it should be.  In this example, the allowed bytes sent is}
2978       \textcolor{comment}{// 4096 * 0.00388 ~= 15.89, which is rounded to 15. Hence the measured}
2979       \textcolor{comment}{// relative weight is 15/(4096+15) ~= 0.00365}
2980       EXPECT\_GT(summary.expected_weight_, 0.00388);
2981       EXPECT\_LT(summary.expected_weight_, 0.0039);
2982       EXPECT\_GT(summary.measured_weight_, 0.00364);
2983       EXPECT\_LT(summary.measured_weight_, 0.00366);
2984     \});
2985   handler4->expectDetachTransaction([&] \{
2986       HTTPTransaction::PrioritySampleSummary summary;
2987       EXPECT\_EQ(handler4->txn\_->getPrioritySampleSummary(summary), \textcolor{keyword}{true});
2988       EXPECT\_EQ(handler4->txn\_->getTransport().getHTTP2PrioritiesEnabled(),
2989                 \textcolor{keyword}{true});
2990       \textcolor{comment}{// This is the priority-based blocking situation. id4 was blocked by}
2991       \textcolor{comment}{// higher priority transactions id1 and id3. Only when id1 and id3}
2992       \textcolor{comment}{// finished, id4 had a chance to transfer its data.}
2993       \textcolor{comment}{// Average contention number weighted by transaction bytes is 1, which}
2994       \textcolor{comment}{// means that when id4 had a chance to transfer bytes it did not contend}
2995       \textcolor{comment}{// with any other transactions.}
2996       \textcolor{comment}{// id4 was waiting for id1 and id3 during transfer of 4256 bytes (encoded)}
2997       \textcolor{comment}{// after which it tranferred 10 bytes (encoded) without contention.}
2998       \textcolor{comment}{// Therefore, the average number contentions weighted by session bytes is}
2999       \textcolor{comment}{// (4111*3 + 1*1)/(4111 + 1) = 12334/4112 ~= 2.999}
3000       \textcolor{comment}{// The difference in average contentions weighted by transaction and}
3001       \textcolor{comment}{// session bytes tells that id4 was mostly blocked by rather than blocking}
3002       \textcolor{comment}{// other transactions.}
3003       EXPECT\_EQ(summary.contentions_.byTransactionBytes_, 1);
3004       EXPECT\_GT(summary.contentions_.bySessionBytes_, 2.99);
3005       EXPECT\_LT(summary.contentions_.bySessionBytes_, 3.00);
3006       \textcolor{comment}{// this is a second level transaction where parent has}
3007       \textcolor{comment}{// no egress, depth == 2}
3008       EXPECT\_EQ(summary.depth_.byTransactionBytes_, 2);
3009       EXPECT\_EQ(summary.depth_.bySessionBytes_, 2);
3010       \textcolor{comment}{// the expected relative weight should be}
3011       \textcolor{comment}{// 1/257 * 1/257 ~= 0.000015.}
3012       \textcolor{comment}{// Because no bytes of this transaction were sent during the previous}
3013       \textcolor{comment}{// egress, the expected relative weight was calculated as:}
3014       \textcolor{comment}{// (0*4111 + 1*1)/(4111 + 1) ~= 0.000243}
3015       EXPECT\_GT(summary.expected_weight_, 0.000243);
3016       EXPECT\_LT(summary.expected_weight_, 0.000244);
3017       \textcolor{comment}{// The measured weight is (0+1)/(4111+1)  ~= 0.000243}
3018       \textcolor{comment}{// The difference between the theoretical value of 0.000015 and the}
3019       \textcolor{comment}{// measured one is not because of the arithmetical rounding, but because}
3020       \textcolor{comment}{// all other transactions are completed and the relative waight for the}
3021       \textcolor{comment}{// only survived transaction was elevated to 1.0}
3022       EXPECT\_GT(summary.measured_weight_, 0.000243);
3023       EXPECT\_LT(summary.measured_weight_, 0.000244);
3024       handler2->txn\_->sendAbort();
3025     \});
3026   handler2->expectDetachTransaction();
3027   flushRequestsAndLoop();
3028   httpSession\_->closeWhenIdle();
3029   expectDetachSession();
3030   eventBase\_.loop();
3031 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Priority\+Dependent\+Transactions)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Test\+Priority\+Dependent\+Transactions}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_ac9f02de5ac24cc4c44065432c1b11e23}


Definition at line 3033 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+H\+T\+T\+P\+Transaction\+::\+Priority\+Sample\+Summary\+::\+Weighted\+Average\+::by\+Session\+Bytes\+\_\+, proxygen\+::\+H\+T\+T\+P\+Transaction\+::\+Priority\+Sample\+Summary\+::\+Weighted\+Average\+::by\+Transaction\+Bytes\+\_\+, proxygen\+::\+H\+T\+T\+P\+Transaction\+::\+Priority\+Sample\+Summary\+::contentions\+\_\+, proxygen\+::\+H\+T\+T\+P\+Transaction\+::\+Priority\+Sample\+Summary\+::depth\+\_\+, proxygen\+::\+H\+T\+T\+P\+Transaction\+::\+Priority\+Sample\+Summary\+::expected\+\_\+weight\+\_\+, proxygen\+::get\+Get\+Request(), and proxygen\+::\+H\+T\+T\+P\+Transaction\+::\+Priority\+Sample\+Summary\+::measured\+\_\+weight\+\_\+.


\begin{DoxyCode}
3033                                                                       \{
3034   \textcolor{comment}{// Create a dependent transaction to test the priority blocked by dependency.}
3035   \textcolor{comment}{// ratio*4096 < 1.}
3036   \textcolor{comment}{//}
3037   \textcolor{comment}{//     root}
3038   \textcolor{comment}{//      \(\backslash\)                                                 level 1}
3039   \textcolor{comment}{//      16}
3040   \textcolor{comment}{//       \(\backslash\)                                                level 2}
3041   \textcolor{comment}{//       16}
3042   InSequence enforceOrder;
3043   \textcolor{keyword}{auto} req1 = getGetRequest();
3044   req1.setHTTP2Priority(HTTPMessage::HTTPPriority\{0, \textcolor{keyword}{false}, 15\});
3045   \textcolor{keyword}{auto} id1 = sendRequest(req1);
3046 
3047   \textcolor{keyword}{auto} req2 = getGetRequest();
3048   req2.setHTTP2Priority(HTTPMessage::HTTPPriority\{id1, \textcolor{keyword}{false}, 15\});
3049   sendRequest(req2);
3050 
3051   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
3052   handler1->expectHeaders();
3053   handler1->expectEOM([&] \{
3054       handler1->sendReplyWithBody(200, 1024);
3055     \});
3056   \textcolor{keyword}{auto} handler2 = addSimpleStrictHandler();
3057   handler2->expectHeaders();
3058   handler2->expectEOM([&] \{
3059       handler2->sendReplyWithBody(200, 1024);
3060     \});
3061 
3062   handler1->expectDetachTransaction([&] \{
3063       HTTPTransaction::PrioritySampleSummary summary;
3064       EXPECT\_EQ(handler1->txn\_->getPrioritySampleSummary(summary), \textcolor{keyword}{true});
3065       EXPECT\_EQ(handler1->txn\_->getTransport().getHTTP2PrioritiesEnabled(),
3066                 \textcolor{keyword}{true});
3067       \textcolor{comment}{// id1 is contending with id2 during the entire transfer.}
3068       \textcolor{comment}{// Average number of contentions for id1 is 2 in both cases.}
3069       \textcolor{comment}{// The same number of average contentions weighted by both transaction}
3070       \textcolor{comment}{// and session bytes tells that id1 was not blocked by any other}
3071       \textcolor{comment}{// transaction during the entire transfer.}
3072       EXPECT\_EQ(summary.contentions_.byTransactionBytes_, 2);
3073       EXPECT\_EQ(summary.contentions_.bySessionBytes_, 2);
3074       \textcolor{comment}{// this is a first level transaction, depth == 1}
3075       EXPECT\_EQ(summary.depth_.byTransactionBytes_, 1);
3076       EXPECT\_EQ(summary.depth_.bySessionBytes_, 1);
3077       \textcolor{comment}{// dependent transaction is blocked, the parent is egressing on 100%}
3078       EXPECT\_EQ(summary.expected_weight_, 1);
3079       EXPECT\_EQ(summary.measured_weight_, 1);
3080     \});
3081   handler2->expectDetachTransaction([&] \{
3082       HTTPTransaction::PrioritySampleSummary summary;
3083       EXPECT\_EQ(handler2->txn\_->getPrioritySampleSummary(summary), \textcolor{keyword}{true});
3084       EXPECT\_EQ(handler2->txn\_->getTransport().getHTTP2PrioritiesEnabled(),
3085                 \textcolor{keyword}{true});
3086       \textcolor{comment}{// This is the dependency-based blocking. id2 is blocked by id1.}
3087       \textcolor{comment}{// When id2 had a chance to transfer bytes, it was no longer contended}
3088       \textcolor{comment}{// with any other transaction. Hence the average contention weighted by}
3089       \textcolor{comment}{// transaction bytes is 1.}
3090       \textcolor{comment}{// The average number of contentions weighted by the session bytes is}
3091       \textcolor{comment}{// computed as (1024*2 + 1024*1)/(1024 + 1024) = 3072/2048 = 1.5}
3092       EXPECT\_EQ(summary.contentions_.byTransactionBytes_, 1);
3093       EXPECT\_EQ(summary.contentions_.bySessionBytes_, 1.5);
3094       \textcolor{comment}{// The transaction transferred bytes only when its parent transaction}
3095       \textcolor{comment}{// completed. At that time its level decreased to 1. The average depth}
3096       \textcolor{comment}{// weighted by session bytes is (2*1024 + 1*1024)/(2048) = 1.5.}
3097       EXPECT\_EQ(summary.depth_.byTransactionBytes_, 1);
3098       EXPECT\_EQ(summary.depth_.bySessionBytes_, 1.5);
3099       \textcolor{comment}{// this dependent transaction was bloted, so it was egressiong only 1/2}
3100       \textcolor{comment}{// of the session bytes.}
3101       EXPECT\_EQ(summary.expected_weight_, 0.5);
3102       EXPECT\_EQ(summary.measured_weight_, 0.5);
3103       handler2->txn\_->sendAbort();
3104     \});
3105   flushRequestsAndLoop();
3106   httpSession\_->closeWhenIdle();
3107   expectDetachSession();
3108   eventBase\_.loop();
3109 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Disable\+Priorities)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Test\+Disable\+Priorities}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_aa57dd842f72cabcc605187e10afd05e0}


Definition at line 3111 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Get\+Request(), and proxygen\+::\+H\+T\+T\+P\+Message\+::set\+H\+T\+T\+P2\+Priority().


\begin{DoxyCode}
3111                                                           \{
3112   \textcolor{comment}{// turn off HTTP2 priorities}
3113   httpSession\_->setHTTP2PrioritiesEnabled(\textcolor{keyword}{false});
3114 
3115   InSequence enforceOrder;
3116   HTTPMessage req1 = getGetRequest();
3117   req1.setHTTP2Priority(HTTPMessage::HTTPPriority\{0, \textcolor{keyword}{false}, 0\});
3118   sendRequest(req1);
3119 
3120   HTTPMessage req2 = getGetRequest();
3121   req2.setHTTP2Priority(HTTPMessage::HTTPPriority\{0, \textcolor{keyword}{false}, 255\});
3122   sendRequest(req2);
3123 
3124   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
3125   handler1->expectHeaders();
3126   handler1->expectEOM([&] \{
3127       handler1->sendReplyWithBody(200, 4 * 1024);
3128     \});
3129 
3130   \textcolor{keyword}{auto} handler2 = addSimpleStrictHandler();
3131   handler2->expectHeaders();
3132   handler2->expectEOM([&] \{
3133       handler2->sendReplyWithBody(200, 4 * 1024);
3134     \});
3135 
3136   \textcolor{comment}{// expecting handler 1 to finish first irrespective of}
3137   \textcolor{comment}{// request 2 having higher weight}
3138   handler1->expectDetachTransaction();
3139   handler2->expectDetachTransaction();
3140 
3141   flushRequestsAndLoop();
3142   httpSession\_->closeWhenIdle();
3143   expectDetachSession();
3144   eventBase\_.loop();
3145 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Priority\+Weights)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Test\+Priority\+Weights}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a2f12b1bfec3712779a8c95df8638f6aa}


Definition at line 3147 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References make\+Buf().


\begin{DoxyCode}
3147                                                         \{
3148   \textcolor{comment}{// virtual priority node with pri=4}
3149   \textcolor{keyword}{auto} priGroupID = clientCodec\_->createStream();
3150   clientCodec\_->generatePriority(
3151     requests\_, priGroupID, HTTPMessage::HTTPPriority(0, \textcolor{keyword}{false}, 3));
3152   \textcolor{comment}{// Both txn's are at equal pri=16}
3153   \textcolor{keyword}{auto} id1 = sendRequest();
3154   \textcolor{keyword}{auto} id2 = sendRequest();
3155 
3156   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
3157 
3158   handler1->expectHeaders();
3159   handler1->expectEOM([&] \{
3160       handler1->sendHeaders(200, 12 * 1024);
3161       handler1->txn\_->sendBody(makeBuf(4 * 1024));
3162     \});
3163   \textcolor{keyword}{auto} handler2 = addSimpleStrictHandler();
3164   handler2->expectHeaders();
3165   handler2->expectEOM([&] \{
3166       handler2->sendHeaders(200, 12 * 1024);
3167       handler2->txn\_->sendBody(makeBuf(4 * 1024));
3168     \});
3169 
3170   \textcolor{comment}{// twice- once to send and once to receive}
3171   flushRequestsAndLoopN(2);
3172   EXPECT\_CALL(callbacks\_, onSettings(\_));
3173   EXPECT\_CALL(callbacks\_, onMessageBegin(id1, \_));
3174   EXPECT\_CALL(callbacks\_, onHeadersComplete(id1, \_));
3175   EXPECT\_CALL(callbacks\_, onMessageBegin(id2, \_));
3176   EXPECT\_CALL(callbacks\_, onHeadersComplete(id2, \_));
3177   EXPECT\_CALL(callbacks\_, onBody(id1, \_, \_))
3178     .WillOnce(ExpectBodyLen(4 * 1024));
3179   EXPECT\_CALL(callbacks\_, onBody(id2, \_, \_))
3180     .WillOnce(ExpectBodyLen(4 * 1024));
3181   parseOutput(*clientCodec\_);
3182 
3183   \textcolor{comment}{// update handler2 to be in the pri-group (which has lower weight)}
3184   clientCodec\_->generatePriority(
3185     requests\_, id2, HTTPMessage::HTTPPriority(priGroupID, \textcolor{keyword}{false}, 15));
3186 
3187   eventBase\_.runInLoop([&] \{
3188       handler1->txn\_->sendBody(makeBuf(4 * 1024));
3189       handler2->txn\_->sendBody(makeBuf(4 * 1024));
3190     \});
3191   flushRequestsAndLoopN(2);
3192 
3193   EXPECT\_CALL(callbacks\_, onBody(id1, \_, \_))
3194     .WillOnce(ExpectBodyLen(4 * 1024));
3195   EXPECT\_CALL(callbacks\_, onBody(id2, \_, \_))
3196     .WillOnce(ExpectBodyLen(1 * 1024))
3197     .WillOnce(ExpectBodyLen(3 * 1024));
3198   parseOutput(*clientCodec\_);
3199 
3200   \textcolor{comment}{// update vnode weight to match txn1 weight}
3201   clientCodec\_->generatePriority(requests\_, priGroupID,
3202                                  HTTPMessage::HTTPPriority(0, \textcolor{keyword}{false}, 15));
3203   eventBase\_.runInLoop([&] \{
3204       handler1->txn\_->sendBody(makeBuf(4 * 1024));
3205       handler1->txn\_->sendEOM();
3206       handler2->txn\_->sendBody(makeBuf(4 * 1024));
3207       handler2->txn\_->sendEOM();
3208     \});
3209   handler1->expectDetachTransaction();
3210   handler2->expectDetachTransaction();
3211   flushRequestsAndLoopN(2);
3212 
3213   \textcolor{comment}{// expect 32/32}
3214   EXPECT\_CALL(callbacks\_, onBody(id1, \_, \_))
3215     .WillOnce(ExpectBodyLen(4 * 1024));
3216   EXPECT\_CALL(callbacks\_, onMessageComplete(id1, \_));
3217   EXPECT\_CALL(callbacks\_, onBody(id2, \_, \_))
3218     .WillOnce(ExpectBodyLen(4 * 1024));
3219   EXPECT\_CALL(callbacks\_, onMessageComplete(id2, \_));
3220   parseOutput(*clientCodec\_);
3221 
3222   httpSession\_->closeWhenIdle();
3223   expectDetachSession();
3224   this->eventBase\_.loop();
3225 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Priority\+Weights\+Tiny\+Window)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Test\+Priority\+Weights\+Tiny\+Window}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_ac20093b7fcf92ac500ffe962c9319243}


Definition at line 3227 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
3227                                                                   \{
3228   httpSession\_->setWriteBufferLimit(2 * 65536);
3229   InSequence enforceOrder;
3230   \textcolor{keyword}{auto} id1 = sendRequest();
3231   \textcolor{keyword}{auto} id2 = sendRequest();
3232 
3233   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
3234 
3235   handler1->expectHeaders();
3236   handler1->expectEOM([&] \{
3237       handler1->sendReplyWithBody(200, 32 * 1024);
3238     \});
3239   \textcolor{keyword}{auto} handler2 = addSimpleStrictHandler();
3240   handler2->expectHeaders();
3241   handler2->expectEOM([&] \{
3242       handler2->sendReplyWithBody(200, 32 * 1024);
3243     \});
3244 
3245   handler1->expectDetachTransaction();
3246 
3247   \textcolor{comment}{// twice- once to send and once to receive}
3248   flushRequestsAndLoopN(2);
3249   EXPECT\_CALL(callbacks\_, onSettings(\_));
3250   EXPECT\_CALL(callbacks\_, onMessageBegin(id1, \_));
3251   EXPECT\_CALL(callbacks\_, onHeadersComplete(id1, \_));
3252   EXPECT\_CALL(callbacks\_, onMessageBegin(id2, \_));
3253   EXPECT\_CALL(callbacks\_, onHeadersComplete(id2, \_));
3254   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} i = 0; i < 7; i++) \{
3255     EXPECT\_CALL(callbacks\_, onBody(id1, \_, \_))
3256       .WillOnce(ExpectBodyLen(4 * 1024));
3257     EXPECT\_CALL(callbacks\_, onBody(id2, \_, \_))
3258       .WillOnce(ExpectBodyLen(4 * 1024));
3259   \}
3260   EXPECT\_CALL(callbacks\_, onBody(id1, \_, \_))
3261     .WillOnce(ExpectBodyLen(4 * 1024 - 1));
3262   EXPECT\_CALL(callbacks\_, onBody(id2, \_, \_))
3263     .WillOnce(ExpectBodyLen(4 * 1024 - 1));
3264   EXPECT\_CALL(callbacks\_, onBody(id1, \_, \_))
3265     .WillOnce(ExpectBodyLen(1));
3266   EXPECT\_CALL(callbacks\_, onMessageComplete(id1, \_));
3267   parseOutput(*clientCodec\_);
3268 
3269   \textcolor{comment}{// open the window}
3270   clientCodec\_->generateWindowUpdate(requests\_, 0, 100);
3271   handler2->expectDetachTransaction();
3272   flushRequestsAndLoopN(2);
3273 
3274   EXPECT\_CALL(callbacks\_, onBody(id2, \_, \_))
3275     .WillOnce(ExpectBodyLen(1));
3276   EXPECT\_CALL(callbacks\_, onMessageComplete(id2, \_));
3277   parseOutput(*clientCodec\_);
3278 
3279   httpSession\_->closeWhenIdle();
3280   expectDetachSession();
3281   this->eventBase\_.loop();
3282 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Short\+Content\+Length)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Test\+Short\+Content\+Length}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a4776e7cbafe03db4cd7d7fa331585b75}


Definition at line 3284 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Post\+Request(), proxygen\+::\+Exception\+::get\+Proxygen\+Error(), proxygen\+::k\+Error\+Parse\+Body, make\+Buf(), and stream\+ID.


\begin{DoxyCode}
3284                                                            \{
3285   \textcolor{keyword}{auto} req = getPostRequest(10);
3286   \textcolor{keyword}{auto} streamID = sendRequest(req, \textcolor{keyword}{false});
3287   clientCodec\_->generateBody(requests\_, streamID, makeBuf(20),
3288                              HTTPCodec::NoPadding, \textcolor{keyword}{true});
3289   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
3290 
3291   InSequence enforceOrder;
3292   handler1->expectHeaders();
3293   handler1->expectError([&handler1] (\textcolor{keyword}{const} HTTPException& ex) \{
3294       EXPECT\_EQ(ex.getProxygenError(), kErrorParseBody);
3295       handler1->txn\_->sendAbort();
3296     \});
3297   handler1->expectDetachTransaction();
3298   flushRequestsAndLoop();
3299 
3300   gracefulShutdown();
3301 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Bad\+Content\+Length\+Untie\+Handler)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Test\+Bad\+Content\+Length\+Untie\+Handler}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a73073a59e82d3c9994fcede4a27196c4}
If handler chooses to untie itself with transaction during on\+Error, detach\+Transaction shouldn\textquotesingle{}t be expected 

Definition at line 3307 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Post\+Request(), make\+Buf(), and stream\+ID.


\begin{DoxyCode}
3307                                                                      \{
3308   \textcolor{keyword}{auto} req = getPostRequest(10);
3309   \textcolor{keyword}{auto} streamID = sendRequest(req, \textcolor{keyword}{false});
3310   clientCodec\_->generateBody(
3311       requests\_,
3312       streamID,
3313       makeBuf(20),
3314       HTTPCodec::NoPadding,
3315       \textcolor{keyword}{true});
3316   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
3317 
3318   InSequence enforceOrder;
3319   handler1->expectHeaders();
3320   handler1->expectError([&] (\textcolor{keyword}{const} HTTPException&) \{
3321       \textcolor{keywordflow}{if} (handler1->txn\_) \{
3322         handler1->txn\_->setHandler(nullptr);
3323       \}
3324       handler1->txn\_ = \textcolor{keyword}{nullptr};
3325     \});
3326   flushRequestsAndLoop();
3327 
3328   gracefulShutdown();
3329 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Long\+Content\+Length)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Test\+Long\+Content\+Length}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_aaf242ac1a3f23e2bf656045059850fac}


Definition at line 3331 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Post\+Request(), proxygen\+::\+Exception\+::get\+Proxygen\+Error(), proxygen\+::k\+Error\+Parse\+Body, make\+Buf(), and stream\+ID.


\begin{DoxyCode}
3331                                                           \{
3332   \textcolor{keyword}{auto} req = getPostRequest(30);
3333   \textcolor{keyword}{auto} streamID = sendRequest(req, \textcolor{keyword}{false});
3334   clientCodec\_->generateBody(requests\_, streamID, makeBuf(20),
3335                              HTTPCodec::NoPadding, \textcolor{keyword}{true});
3336   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
3337 
3338   InSequence enforceOrder;
3339   handler1->expectHeaders();
3340   handler1->expectBody();
3341   handler1->expectError([&handler1] (\textcolor{keyword}{const} HTTPException& ex) \{
3342       EXPECT\_EQ(ex.getProxygenError(), kErrorParseBody);
3343       handler1->txn\_->sendAbort();
3344     \});
3345   handler1->expectDetachTransaction();
3346   flushRequestsAndLoop();
3347 
3348   gracefulShutdown();
3349 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Malformed\+Content\+Length)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Test\+Malformed\+Content\+Length}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a3434cb86722f1de67b26676c0c74bccb}


Definition at line 3351 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Post\+Request(), make\+Buf(), and stream\+ID.


\begin{DoxyCode}
3351                                                                \{
3352   \textcolor{keyword}{auto} req = getPostRequest();
3353   req.getHeaders().set(HTTP\_HEADER\_CONTENT\_LENGTH, \textcolor{stringliteral}{"malformed"});
3354   \textcolor{keyword}{auto} streamID = sendRequest(req, \textcolor{keyword}{false});
3355   clientCodec\_->generateBody(requests\_, streamID, makeBuf(20),
3356                              HTTPCodec::NoPadding, \textcolor{keyword}{true});
3357   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
3358 
3359   InSequence enforceOrder;
3360   handler1->expectHeaders();
3361   handler1->expectBody();
3362   handler1->expectEOM([&handler1] \{
3363       handler1->sendReplyWithBody(200, 100);
3364     \});
3365   handler1->expectDetachTransaction();
3366   flushRequestsAndLoop();
3367 
3368   gracefulShutdown();
3369 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Head\+Content\+Length)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Test\+Head\+Content\+Length}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a4fbc45dd8db7429d0a03e772424ea615}


Definition at line 3371 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Get\+Request().


\begin{DoxyCode}
3371                                                           \{
3372   InSequence enforceOrder;
3373   \textcolor{keyword}{auto} req = getGetRequest();
3374   req.setMethod(HTTPMethod::HEAD);
3375   sendRequest(req);
3376   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
3377 
3378   handler1->expectHeaders();
3379   handler1->expectEOM([&handler1] \{
3380       handler1->sendHeaders(200, 100);
3381       \textcolor{comment}{// no body for head}
3382       handler1->txn\_->sendEOM();
3383     \});
3384   handler1->expectDetachTransaction();
3385   flushRequestsAndLoop();
3386 
3387   gracefulShutdown();
3388 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Test304\+Content\+Length)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Test304\+Content\+Length}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a62ec411ba67e7690ef1a803b3813dc46}


Definition at line 3390 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Get\+Request().


\begin{DoxyCode}
3390                                                          \{
3391   InSequence enforceOrder;
3392   \textcolor{keyword}{auto} req = getGetRequest();
3393   req.setMethod(HTTPMethod::HEAD);
3394   sendRequest(req);
3395   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
3396 
3397   handler1->expectHeaders();
3398   handler1->expectEOM([&handler1] \{
3399       handler1->sendHeaders(304, 100);
3400       handler1->txn\_->sendEOM();
3401     \});
3402   handler1->expectDetachTransaction();
3403   flushRequestsAndLoop();
3404 
3405   gracefulShutdown();
3406 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P\+Downstream\+Session\+Test, Http\+Short\+Content\+Length)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Session\+Test}}]{, }
\item[{Http\+Short\+Content\+Length}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a4c40c07cbb5df91770c630693e2e1fa8}


Definition at line 3409 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Post\+Request(), proxygen\+::\+Exception\+::get\+Proxygen\+Error(), proxygen\+::k\+Error\+Parse\+Body, make\+Buf(), and stream\+ID.


\begin{DoxyCode}
3409                                                           \{
3410   InSequence enforceOrder;
3411   \textcolor{keyword}{auto} req = getPostRequest(10);
3412   req.setIsChunked(\textcolor{keyword}{true});
3413   req.getHeaders().add(HTTP\_HEADER\_TRANSFER\_ENCODING, \textcolor{stringliteral}{"chunked"});
3414   \textcolor{keyword}{auto} streamID = sendRequest(req, \textcolor{keyword}{false});
3415   clientCodec\_->generateChunkHeader(requests\_, streamID, 20);
3416   clientCodec\_->generateBody(requests\_, streamID, makeBuf(20),
3417                              HTTPCodec::NoPadding, \textcolor{keyword}{false});
3418   clientCodec\_->generateChunkTerminator(requests\_, streamID);
3419   clientCodec\_->generateEOM(requests\_, streamID);
3420   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
3421 
3422   handler1->expectHeaders();
3423   EXPECT\_CALL(*handler1, onChunkHeader(20));
3424 
3425   handler1->expectError([&handler1] (\textcolor{keyword}{const} HTTPException& ex) \{
3426       EXPECT\_EQ(ex.getProxygenError(), kErrorParseBody);
3427       handler1->txn\_->sendAbort();
3428     \});
3429   handler1->expectDetachTransaction();
3430   expectDetachSession();
3431   flushRequestsAndLoop();
3432 
3433 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Session\+Stall\+By\+Flow\+Control)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Test\+Session\+Stall\+By\+Flow\+Control}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a220389cd456f6582b1b8150789e6f47d}


Definition at line 3435 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
3435                                                                   \{
3436   NiceMock<MockHTTPSessionStats> stats;
3437   \textcolor{comment}{// By default the send and receive windows are 64K each.}
3438   \textcolor{comment}{// If we use only a single transaction, that transaction}
3439   \textcolor{comment}{// will be paused on reaching 64K. Therefore, to pause the session,}
3440   \textcolor{comment}{// it is used 2 transactions each sending 32K.}
3441 
3442   \textcolor{comment}{// Make write buffer limit exceding 64K, for example 128K}
3443   httpSession\_->setWriteBufferLimit(128 * 1024);
3444   httpSession\_->setSessionStats(&stats);
3445 
3446   InSequence enforceOrder;
3447   sendRequest();
3448   sendRequest();
3449 
3450   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
3451 
3452   handler1->expectHeaders();
3453   handler1->expectEOM([&] \{
3454       handler1->sendReplyWithBody(200, 32 * 1024);
3455     \});
3456 
3457   \textcolor{keyword}{auto} handler2 = addSimpleStrictHandler();
3458   handler2->expectHeaders();
3459   handler2->expectEOM([&] \{
3460       handler2->sendReplyWithBody(200, 32 * 1024);
3461     \});
3462 
3463   EXPECT\_CALL(stats, recordSessionStalled()).Times(1);
3464 
3465   handler1->expectDetachTransaction();
3466 
3467   \textcolor{comment}{// twice- once to send and once to receive}
3468   flushRequestsAndLoopN(2);
3469 
3470   \textcolor{comment}{// open the window}
3471   clientCodec\_->generateWindowUpdate(requests\_, 0, 100);
3472   handler2->expectDetachTransaction();
3473   flushRequestsAndLoopN(2);
3474 
3475   httpSession\_->closeWhenIdle();
3476   expectDetachSession();
3477   flushRequestsAndLoop();
3478 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Transaction\+Stall\+By\+Flow\+Control)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Test\+Transaction\+Stall\+By\+Flow\+Control}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a9b2fd36043229436c3ba7ac91f27afcf}


Definition at line 3480 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+Exception\+::get\+Proxygen\+Error(), proxygen\+::k\+Error\+Write\+Timeout, stream\+ID, and proxygen\+::\+Exception\+::what().


\begin{DoxyCode}
3480                                                                       \{
3481   StrictMock<MockHTTPSessionStats> stats;
3482 
3483   httpSession\_->setSessionStats(&stats);
3484 
3485   \textcolor{comment}{// Set the client side stream level flow control wind to 500 bytes,}
3486   \textcolor{comment}{// and try to send 1000 bytes through it.}
3487   \textcolor{comment}{// Then the flow control kicks in and stalls the transaction.}
3488   clientCodec\_->getEgressSettings()->setSetting(SettingsId::INITIAL\_WINDOW\_SIZE,
3489                                                 500);
3490   clientCodec\_->generateSettings(requests\_);
3491 
3492   \textcolor{keyword}{auto} streamID = sendRequest();
3493 
3494   EXPECT\_CALL(stats, recordTransactionOpened());
3495 
3496   InSequence handlerSequence;
3497   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
3498   handler->expectHeaders();
3499   handler->expectEOM([&] \{
3500       handler->sendReplyWithBody(200, 1000);
3501     \});
3502 
3503   EXPECT\_CALL(stats, recordTransactionStalled());
3504   handler->expectEgressPaused();
3505 
3506   handler->expectError([&] (\textcolor{keyword}{const} HTTPException& ex) \{
3507       ASSERT\_EQ(ex.getProxygenError(), kErrorWriteTimeout);
3508       ASSERT\_EQ(
3509         folly::to<std::string>(\textcolor{stringliteral}{"ingress timeout, streamID="}, streamID),
3510         std::string(ex.what()));
3511       handler->terminate();
3512     \});
3513 
3514   handler->expectDetachTransaction();
3515 
3516   EXPECT\_CALL(stats, recordTransactionClosed());
3517 
3518   flushRequestsAndLoop();
3519   gracefulShutdown();
3520 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Transaction\+Not\+Stall\+By\+Flow\+Control)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Test\+Transaction\+Not\+Stall\+By\+Flow\+Control}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a3ae6bb87dd38a3544c24db03c86738e8}


Definition at line 3522 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
3522                                                                          \{
3523   StrictMock<MockHTTPSessionStats> stats;
3524 
3525   httpSession\_->setSessionStats(&stats);
3526 
3527   clientCodec\_->getEgressSettings()->setSetting(SettingsId::INITIAL\_WINDOW\_SIZE,
3528                                                 500);
3529   clientCodec\_->generateSettings(requests\_);
3530 
3531   sendRequest();
3532 
3533   EXPECT\_CALL(stats, recordTransactionOpened());
3534 
3535   InSequence handlerSequence;
3536   \textcolor{keyword}{auto} handler = addSimpleStrictHandler();
3537   handler->expectHeaders();
3538   handler->expectEOM([&] \{
3539       handler->sendReplyWithBody(200, 500);
3540     \});
3541 
3542   \textcolor{comment}{// The egtress paused is notified due to existing logics,}
3543   \textcolor{comment}{// but egress transaction should not be counted as stalled by flow control,}
3544   \textcolor{comment}{// because there is nore more bytes to send}
3545   handler->expectEgressPaused();
3546 
3547   handler->expectDetachTransaction();
3548 
3549   EXPECT\_CALL(stats, recordTransactionClosed());
3550 
3551   flushRequestsAndLoop();
3552   gracefulShutdown();
3553 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Set\+Egress\+Settings)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Test\+Set\+Egress\+Settings}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_afac11e2803f4a63a018e4a64ca537981}


Definition at line 3555 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+H\+T\+T\+P\+Settings\+::get\+Setting(), settings, and proxygen\+::\+H\+T\+T\+P\+Setting\+::value.


\begin{DoxyCode}
3555                                                           \{
3556   SettingsList settings = \{\{ SettingsId::HEADER\_TABLE\_SIZE, 5555 \},
3557                            \{ SettingsId::MAX\_FRAME\_SIZE, 16384 \},
3558                            \{ SettingsId::ENABLE\_PUSH, 1 \}\};
3559 
3560   \textcolor{keyword}{const} HTTPSettings* codecSettings = rawCodec\_->getEgressSettings();
3561   \textcolor{keywordflow}{for} (\textcolor{keyword}{const} \textcolor{keyword}{auto}& setting: settings) \{
3562     \textcolor{keyword}{const} HTTPSetting* currSetting = codecSettings->getSetting(setting.id);
3563     \textcolor{keywordflow}{if} (currSetting) \{
3564       EXPECT\_EQ(setting.value, currSetting->value);
3565     \}
3566   \}
3567 
3568   flushRequestsAndLoop();
3569   gracefulShutdown();
3570 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}}
\index{T\+E\+S\+T\+\_\+F@{T\+E\+S\+T\+\_\+F}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+E\+S\+T\+\_\+\+F(\+H\+T\+T\+P2\+Downstream\+Session\+Test, Test\+Duplicate\+Request\+Stream)}]{\setlength{\rightskip}{0pt plus 5cm}T\+E\+S\+T\+\_\+F (
\begin{DoxyParamCaption}
\item[{H\+T\+T\+P2\+Downstream\+Session\+Test}]{, }
\item[{Test\+Duplicate\+Request\+Stream}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a0f85dbdd6d67af43fc3737d696d399e9}


Definition at line 3572 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::\+H\+T\+T\+P\+Headers\+::add(), and proxygen\+::get\+Get\+Request().


\begin{DoxyCode}
3572                                                                \{
3573   \textcolor{comment}{// Send the following:}
3574   \textcolor{comment}{// HEADERS id=1}
3575   \textcolor{comment}{// HEADERS id=2}
3576   \textcolor{comment}{// HEADERS id=1 (trailers)}
3577   \textcolor{comment}{// HEADERS id=2 -> contains pseudo-headers after EOM so ignored}
3578   \textcolor{keyword}{auto} handler2 = addSimpleStrictHandler();
3579   \textcolor{keyword}{auto} handler1 = addSimpleStrictHandler();
3580   \textcolor{keyword}{auto} streamID1 = sendRequest(\textcolor{stringliteral}{"/withtrailers"}, 0, \textcolor{keyword}{false});
3581   \textcolor{keyword}{auto} streamID2 = sendRequest();
3582   HTTPHeaders trailers;
3583   trailers.add(\textcolor{stringliteral}{"Foo"}, \textcolor{stringliteral}{"Bar"});
3584   clientCodec\_->generateTrailers(requests\_, streamID1, trailers);
3585   clientCodec\_->generateEOM(requests\_, streamID1);
3586 
3587   clientCodec\_->generateHeader(requests\_, streamID2, getGetRequest(), \textcolor{keyword}{false});
3588   handler1->expectHeaders();
3589   handler2->expectHeaders();
3590   handler2->expectEOM();
3591   handler1->expectTrailers();
3592   handler1->expectEOM([&] \{
3593       handler1->sendReplyWithBody(200, 100);
3594       \textcolor{comment}{// 2 got an error after EOM, which gets ignored - need a response to}
3595       \textcolor{comment}{// cleanly terminate it}
3596       handler2->sendReplyWithBody(200, 100);
3597     \});
3598   handler1->expectDetachTransaction();
3599   handler2->expectDetachTransaction();
3600   flushRequestsAndLoop();
3601   gracefulShutdown();
3602 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+P@{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+P}}
\index{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+P@{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+P}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+\+P(\+H\+T\+T\+P\+Downstream\+Test)}]{\setlength{\rightskip}{0pt plus 5cm}T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+C\+A\+S\+E\+\_\+P (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Test}}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a9bfc81ad78e255dc349688df8f9c8831}


Referenced by T\+E\+S\+T\+\_\+\+F().

\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P@{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P}}
\index{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P@{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+P(\+H\+T\+T\+P\+Downstream\+Test, Test\+Writes\+Draining)}]{\setlength{\rightskip}{0pt plus 5cm}T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Test}}]{, }
\item[{Test\+Writes\+Draining}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a650c2d000063b065c226284f80bf43ad}


Definition at line 2300 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Get\+Request(), proxygen\+::\+Exception\+::get\+Proxygen\+Error(), proxygen\+::k\+Error\+E\+OF, and proxygen\+::\+Exception\+::what().


\begin{DoxyCode}
2300                                                      \{
2301   \textcolor{keyword}{auto} badCodec =
2302     makeServerCodec<typename TypeParam::Codec>(TypeParam::version);
2303   this->sendRequest();
2304   badCodec->generatePushPromise(this->requests\_, 2 \textcolor{comment}{/* bad */}, getGetRequest(),
2305                                 1);
2306 
2307   this->expectDetachSession();
2308 
2309   InSequence handlerSequence;
2310   \textcolor{keyword}{auto} handler1 = this->addSimpleNiceHandler();
2311   handler1->expectHeaders();
2312   handler1->expectEOM();
2313   handler1->expectError([&](\textcolor{keyword}{const} HTTPException& ex) \{
2314     ASSERT\_EQ(ex.getProxygenError(), kErrorEOF);
2315     ASSERT\_TRUE(
2316         folly::StringPiece(ex.what()).startsWith(\textcolor{stringliteral}{"Shutdown transport: EOF"}))
2317         << ex.what();
2318   \});
2319   handler1->expectDetachTransaction();
2320 
2321   this->flushRequestsAndLoop();
2322 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P@{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P}}
\index{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P@{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+P(\+H\+T\+T\+P\+Downstream\+Test, Test\+Body\+Size\+Limit)}]{\setlength{\rightskip}{0pt plus 5cm}T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Test}}]{, }
\item[{Test\+Body\+Size\+Limit}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a39cf928f40245c8d601a8b770a30966a}


Definition at line 2324 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.


\begin{DoxyCode}
2324                                                     \{
2325   this->clientCodec\_->generateWindowUpdate(this->requests\_, 0, 65536);
2326   this->sendRequest();
2327   this->sendRequest();
2328 
2329   InSequence handlerSequence;
2330   \textcolor{keyword}{auto} handler1 = this->addSimpleNiceHandler();
2331   handler1->expectHeaders();
2332   handler1->expectEOM();
2333   \textcolor{keyword}{auto} handler2 = this->addSimpleNiceHandler();
2334   handler2->expectHeaders();
2335   handler2->expectEOM([&] \{
2336       handler1->sendReplyWithBody(200, 33000);
2337       handler2->sendReplyWithBody(200, 33000);
2338     \});
2339   handler1->expectDetachTransaction();
2340   handler2->expectDetachTransaction();
2341 
2342   this->flushRequestsAndLoop();
2343 
2344   std::list<HTTPCodec::StreamID> streams;
2345   EXPECT\_CALL(this->callbacks\_, onMessageBegin(1, \_));
2346   EXPECT\_CALL(this->callbacks\_, onHeadersComplete(1, \_));
2347   EXPECT\_CALL(this->callbacks\_, onMessageBegin(3, \_));
2348   EXPECT\_CALL(this->callbacks\_, onHeadersComplete(3, \_));
2349   \textcolor{keywordflow}{for} (uint32\_t i = 0; i < 8; i++) \{
2350     EXPECT\_CALL(this->callbacks\_, onBody(1, \_, \_));
2351     EXPECT\_CALL(this->callbacks\_, onBody(3, \_, \_));
2352   \}
2353   EXPECT\_CALL(this->callbacks\_, onBody(1, \_, \_));
2354   EXPECT\_CALL(this->callbacks\_, onMessageComplete(1, \_));
2355   EXPECT\_CALL(this->callbacks\_, onBody(3, \_, \_));
2356   EXPECT\_CALL(this->callbacks\_, onMessageComplete(3, \_));
2357 
2358   this->parseOutput(*this->clientCodec\_);
2359 
2360   this->cleanup();
2361 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P@{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P}}
\index{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P@{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+P(\+H\+T\+T\+P\+Downstream\+Test, Test\+Uniform\+Pause\+State)}]{\setlength{\rightskip}{0pt plus 5cm}T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Test}}]{, }
\item[{Test\+Uniform\+Pause\+State}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a9e5ff0f0a85b256d9860558f92b3b78d}


Definition at line 2366 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References I\+F\+\_\+\+H\+T\+T\+P2, and make\+Buf().


\begin{DoxyCode}
2366                                                         \{
2367   this->httpSession\_->setWriteBufferLimit(12000);
2368   this->clientCodec\_->getEgressSettings()->setSetting(
2369     SettingsId::INITIAL\_WINDOW\_SIZE, 1000000);
2370   this->clientCodec\_->generateSettings(this->requests\_);
2371   this->clientCodec\_->generateWindowUpdate(this->requests\_, 0, 1000000);
2372   this->sendRequest(\textcolor{stringliteral}{"/"}, 1);
2373   this->sendRequest(\textcolor{stringliteral}{"/"}, 1);
2374   this->sendRequest(\textcolor{stringliteral}{"/"}, 2);
2375 
2376   InSequence handlerSequence;
2377   \textcolor{keyword}{auto} handler1 = this->addSimpleStrictHandler();
2378   handler1->expectHeaders();
2379   handler1->expectEOM();
2380   \textcolor{keyword}{auto} handler2 = this->addSimpleStrictHandler();
2381   handler2->expectHeaders();
2382   handler2->expectEOM([&] \{
2383       handler1->sendHeaders(200, 24002);
2384       \textcolor{comment}{// triggers pause of all txns}
2385       this->transport\_->pauseWrites();
2386       handler1->txn\_->sendBody(std::move(makeBuf(12001)));
2387       this->resumeWritesAfterDelay(milliseconds(50));
2388     \});
2389   handler1->expectEgressPaused();
2390   handler2->expectEgressPaused();
2391   \textcolor{keyword}{auto} handler3 = this->addSimpleStrictHandler();
2392   handler3->expectEgressPaused();
2393   handler3->expectHeaders();
2394   handler3->expectEOM();
2395 
2396   handler1->expectEgressResumed([&] \{
2397       \textcolor{comment}{// resume does not trigger another pause,}
2398       handler1->txn\_->sendBody(std::move(makeBuf(12001)));
2399     \});
2400   \textcolor{comment}{// handler2 gets a fair shot, handler3 is not resumed}
2401   \textcolor{comment}{// HTTP/2 priority is not implemented, so handler3 is like another 0 pri txn}
2402   handler2->expectEgressResumed();
2403   IF_HTTP2(handler3->expectEgressResumed());
2404   handler1->expectEgressPaused();
2405   handler2->expectEgressPaused();
2406   IF_HTTP2(handler3->expectEgressPaused());
2407 
2408   handler1->expectEgressResumed();
2409   handler2->expectEgressResumed([&] \{
2410       handler2->sendHeaders(200, 12001);
2411       handler2->txn\_->sendBody(std::move(makeBuf(12001)));
2412       this->transport\_->pauseWrites();
2413       this->resumeWritesAfterDelay(milliseconds(50));
2414     \});
2415   \textcolor{comment}{// handler3 not resumed}
2416   IF_HTTP2(handler3->expectEgressResumed());
2417 
2418   handler1->expectEgressPaused();
2419   handler2->expectEgressPaused();
2420   IF_HTTP2(handler3->expectEgressPaused());
2421 
2422   handler1->expectEgressResumed();
2423   handler2->expectEgressResumed([&] \{
2424       handler1->txn\_->sendEOM();
2425       handler2->txn\_->sendEOM();
2426     \});
2427   handler3->expectEgressResumed([&] \{
2428       handler3->txn\_->sendAbort();
2429     \});
2430 
2431   handler3->expectDetachTransaction();
2432   handler1->expectDetachTransaction();
2433   handler2->expectDetachTransaction();
2434 
2435   this->flushRequestsAndLoop();
2436 
2437   this->cleanup();
2438 \}
\end{DoxyCode}
\index{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}!T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P@{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P}}
\index{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P@{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P}!H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp@{H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp}}
\subsubsection[{T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+\+P(\+H\+T\+T\+P\+Downstream\+Test, Test\+Max\+Txns)}]{\setlength{\rightskip}{0pt plus 5cm}T\+Y\+P\+E\+D\+\_\+\+T\+E\+S\+T\+\_\+P (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Downstream\+Test}}]{, }
\item[{Test\+Max\+Txns}]{}
\end{DoxyParamCaption}
)}\label{HTTPDownstreamSessionTest_8cpp_a506065bcbaa17eaff8bb506926ffae06}


Definition at line 2442 of file H\+T\+T\+P\+Downstream\+Session\+Test.\+cpp.



References settings, and stream\+ID.


\begin{DoxyCode}
2442                                               \{
2443   \textcolor{keyword}{auto} settings = this->rawCodec\_->getEgressSettings();
2444   \textcolor{keyword}{auto} maxTxns = settings->getSetting(SettingsId::MAX\_CONCURRENT\_STREAMS,
2445                                       100);
2446   std::list<unique\_ptr<StrictMock<MockHTTPHandler>>> handlers;
2447   \{
2448     InSequence enforceOrder;
2449     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} i = 0U; i < maxTxns; i++) \{
2450       this->sendRequest();
2451       \textcolor{keyword}{auto} handler = this->addSimpleStrictHandler();
2452       handler->expectHeaders();
2453       handler->expectEOM();
2454       handlers.push\_back(std::move(handler));
2455     \}
2456     \textcolor{keyword}{auto} streamID = this->sendRequest();
2457     this->clientCodec\_->generateGoaway(this->requests\_, 0, ErrorCode::NO\_ERROR);
2458 
2459     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}& handler: handlers) \{
2460       EXPECT\_CALL(*handler, onGoaway(ErrorCode::NO\_ERROR));
2461     \}
2462 
2463     this->flushRequestsAndLoop();
2464 
2465     EXPECT\_CALL(this->callbacks\_, onSettings(\_));
2466     EXPECT\_CALL(this->callbacks\_, onAbort(streamID, ErrorCode::REFUSED\_STREAM));
2467 
2468     this->parseOutput(*this->clientCodec\_);
2469   \}
2470   \textcolor{comment}{// handlers can finish out of order?}
2471   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}& handler: handlers) \{
2472     handler->sendReplyWithBody(200, 100);
2473     handler->expectDetachTransaction();
2474   \}
2475   this->expectDetachSession();
2476   this->eventBase\_.loop();
2477 \}
\end{DoxyCode}
