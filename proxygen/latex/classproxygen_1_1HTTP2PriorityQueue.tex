\section{proxygen\+:\+:H\+T\+T\+P2\+Priority\+Queue Class Reference}
\label{classproxygen_1_1HTTP2PriorityQueue}\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}


{\ttfamily \#include $<$H\+T\+T\+P2\+Priority\+Queue.\+h$>$}

Inheritance diagram for proxygen\+:\+:H\+T\+T\+P2\+Priority\+Queue\+:\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=3.000000cm]{classproxygen_1_1HTTP2PriorityQueue}
\end{center}
\end{figure}
\subsection*{Classes}
\begin{DoxyCompactItemize}
\item 
class {\bf Node}
\end{DoxyCompactItemize}
\subsection*{Public Types}
\begin{DoxyCompactItemize}
\item 
using {\bf Next\+Egress\+Result} = std\+::vector$<$ std\+::pair$<$ {\bf H\+T\+T\+P\+Transaction} $\ast$, double $>$$>$
\end{DoxyCompactItemize}
\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
{\bf H\+T\+T\+P2\+Priority\+Queue} ({\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID} root\+Node\+Id=0)
\item 
{\bf H\+T\+T\+P2\+Priority\+Queue} (const {\bf Wheel\+Timer\+Instance} \&timeout, {\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID} root\+Node\+Id=0)
\item 
void {\bf attach\+Thread\+Locals} (const {\bf Wheel\+Timer\+Instance} \&timeout)
\begin{DoxyCompactList}\small\item\em class \doxyref{H\+T\+T\+P2\+Priority\+Queue}{p.}{classproxygen_1_1HTTP2PriorityQueue} \end{DoxyCompactList}\item 
void {\bf detach\+Thread\+Locals} ()
\item 
void {\bf set\+Max\+Virtual\+Nodes} (uint32\+\_\+t max\+Virtual\+Nodes)
\item 
void {\bf signal\+Pending\+Egress} ({\bf Handle} h) override
\item 
void {\bf clear\+Pending\+Egress} ({\bf Handle} h) override
\item 
void {\bf add\+Priority\+Node} ({\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID} id, {\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID} parent) override
\item 
void {\bf add\+Or\+Update\+Priority\+Node} ({\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID} id, {\bf http2\+::\+Priority\+Update} pri)
\item 
void {\bf drop\+Priority\+Nodes} ()
\item 
{\bf Handle} {\bf add\+Transaction} ({\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID} id, {\bf http2\+::\+Priority\+Update} pri, {\bf H\+T\+T\+P\+Transaction} $\ast$txn, bool permanent=false, uint64\+\_\+t $\ast$depth={\bf nullptr}) override
\item 
{\bf Handle} {\bf update\+Priority} ({\bf Handle} handle, {\bf http2\+::\+Priority\+Update} pri, uint64\+\_\+t $\ast$depth={\bf nullptr}) override
\item 
void {\bf remove\+Transaction} ({\bf Handle} handle) override
\item 
bool {\bf empty} () const 
\item 
uint64\+\_\+t {\bf num\+Pending\+Egress} () const 
\item 
uint64\+\_\+t {\bf num\+Virtual\+Nodes} () const 
\item 
void {\bf iterate} (const std\+::function$<$ bool({\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID}, {\bf H\+T\+T\+P\+Transaction} $\ast$, double)$>$ \&fn, const std\+::function$<$ bool()$>$ \&stop\+Fn, bool all)
\item 
void {\bf iterate\+B\+FS} (const std\+::function$<$ bool({\bf H\+T\+T\+P2\+Priority\+Queue} \&, {\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID}, {\bf H\+T\+T\+P\+Transaction} $\ast$, double)$>$ \&fn, const std\+::function$<$ bool()$>$ \&stop\+Fn, bool all)
\item 
void {\bf next\+Egress} ({\bf Next\+Egress\+Result} \&result, bool spdy\+Mode=false)
\item 
void {\bf rebuild\+Tree} ()
\begin{DoxyCompactList}\small\item\em Error handling code. \end{DoxyCompactList}\item 
uint32\+\_\+t {\bf get\+Rebuild\+Count} () const 
\item 
bool {\bf is\+Rebuilt} () const 
\end{DoxyCompactItemize}
\subsection*{Static Public Member Functions}
\begin{DoxyCompactItemize}
\item 
static void {\bf set\+Node\+Lifetime} (std\+::chrono\+::milliseconds lifetime)
\end{DoxyCompactItemize}
\subsection*{Private Types}
\begin{DoxyCompactItemize}
\item 
using {\bf Node\+Map} = boost\+::intrusive\+::unordered\+\_\+set$<$ {\bf Node}, boost\+::intrusive\+::constant\+\_\+time\+\_\+size$<$ false $>$$>$
\item 
typedef boost\+::intrusive\+::link\+\_\+mode$<$ boost\+::intrusive\+::auto\+\_\+unlink $>$ {\bf link\+\_\+mode}
\end{DoxyCompactItemize}
\subsection*{Private Member Functions}
\begin{DoxyCompactItemize}
\item 
{\bf Node} $\ast$ {\bf find} ({\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID} id, uint64\+\_\+t $\ast$depth={\bf nullptr})
\item 
{\bf Node} $\ast$ {\bf find\+Internal} ({\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID} id)
\item 
bool {\bf allow\+Dangling\+Nodes} () const 
\item 
void {\bf schedule\+Node\+Expiration} ({\bf Node} $\ast$node)
\item 
void {\bf update\+Enqueued\+Weight} ()
\end{DoxyCompactItemize}
\subsection*{Static Private Member Functions}
\begin{DoxyCompactItemize}
\item 
static bool {\bf next\+Egress\+Result} ({\bf H\+T\+T\+P2\+Priority\+Queue} \&queue, {\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID} id, {\bf H\+T\+T\+P\+Transaction} $\ast$txn, double r)
\end{DoxyCompactItemize}
\subsection*{Private Attributes}
\begin{DoxyCompactItemize}
\item 
Node\+Map\+::bucket\+\_\+type {\bf node\+Buckets\+\_\+} [{\bf k\+Num\+Buckets}]
\item 
{\bf Node\+Map} {\bf nodes\+\_\+}
\item 
{\bf Node} {\bf root\+\_\+}
\item 
uint32\+\_\+t {\bf rebuild\+Count\+\_\+} \{0\}
\item 
uint64\+\_\+t {\bf active\+Count\+\_\+} \{0\}
\item 
uint32\+\_\+t {\bf max\+Virtual\+Nodes\+\_\+} \{50\}
\item 
uint32\+\_\+t {\bf num\+Virtual\+Nodes\+\_\+} \{0\}
\item 
bool {\bf pending\+Weight\+Change\+\_\+} \{false\}
\item 
{\bf Wheel\+Timer\+Instance} {\bf timeout\+\_\+}
\item 
{\bf Next\+Egress\+Result} $\ast$ {\bf next\+Egress\+Results\+\_\+} \{{\bf nullptr}\}
\end{DoxyCompactItemize}
\subsection*{Static Private Attributes}
\begin{DoxyCompactItemize}
\item 
static const size\+\_\+t {\bf k\+Num\+Buckets} = 100
\item 
static uint32\+\_\+t {\bf k\+Max\+Rebuilds\+\_\+} = 3
\item 
static std\+::chrono\+::milliseconds {\bf k\+Node\+Lifetime\+\_\+}
\end{DoxyCompactItemize}
\subsection*{Additional Inherited Members}


\subsection{Detailed Description}


Definition at line 69 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



\subsection{Member Typedef Documentation}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!link\+\_\+mode@{link\+\_\+mode}}
\index{link\+\_\+mode@{link\+\_\+mode}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{link\+\_\+mode}]{\setlength{\rightskip}{0pt plus 5cm}typedef boost\+::intrusive\+::link\+\_\+mode$<$boost\+::intrusive\+::auto\+\_\+unlink$>$ {\bf proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::link\+\_\+mode}\hspace{0.3cm}{\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_a2266613833cba96d623eee31338c1afe}


Definition at line 208 of file H\+T\+T\+P2\+Priority\+Queue.\+h.

\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!Next\+Egress\+Result@{Next\+Egress\+Result}}
\index{Next\+Egress\+Result@{Next\+Egress\+Result}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{Next\+Egress\+Result}]{\setlength{\rightskip}{0pt plus 5cm}using {\bf proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Next\+Egress\+Result} =  std\+::vector$<$std\+::pair$<${\bf H\+T\+T\+P\+Transaction}$\ast$, double$>$$>$}\label{classproxygen_1_1HTTP2PriorityQueue_a35f9381d8797bb0edbad64bc3b078047}


Definition at line 163 of file H\+T\+T\+P2\+Priority\+Queue.\+h.

\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!Node\+Map@{Node\+Map}}
\index{Node\+Map@{Node\+Map}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{Node\+Map}]{\setlength{\rightskip}{0pt plus 5cm}using {\bf proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+Map} =  boost\+::intrusive\+::unordered\+\_\+set$<$ {\bf Node}, boost\+::intrusive\+::constant\+\_\+time\+\_\+size$<$false$>$$>$\hspace{0.3cm}{\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_a06a6250504e4c0b66d42b60f6bb26a73}


Definition at line 74 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



\subsection{Constructor \& Destructor Documentation}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!H\+T\+T\+P2\+Priority\+Queue@{H\+T\+T\+P2\+Priority\+Queue}}
\index{H\+T\+T\+P2\+Priority\+Queue@{H\+T\+T\+P2\+Priority\+Queue}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{H\+T\+T\+P2\+Priority\+Queue(\+H\+T\+T\+P\+Codec\+::\+Stream\+I\+D root\+Node\+Id=0)}]{\setlength{\rightskip}{0pt plus 5cm}proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+H\+T\+T\+P2\+Priority\+Queue (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID}}]{root\+Node\+Id = {\ttfamily 0}}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}}\label{classproxygen_1_1HTTP2PriorityQueue_af9fa68197ad003d30bec187ea17edef2}


Definition at line 80 of file H\+T\+T\+P2\+Priority\+Queue.\+h.


\begin{DoxyCode}
81       : HTTP2PriorityQueueBase(rootNodeId),
82         nodes_(NodeMap::bucket\_traits(nodeBuckets_, kNumBuckets)),
83         root_(*\textcolor{keyword}{this}, \textcolor{keyword}{nullptr}, rootNodeId, 1, \textcolor{keyword}{nullptr}) \{
84     root_.setPermanent();
85   \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!H\+T\+T\+P2\+Priority\+Queue@{H\+T\+T\+P2\+Priority\+Queue}}
\index{H\+T\+T\+P2\+Priority\+Queue@{H\+T\+T\+P2\+Priority\+Queue}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{H\+T\+T\+P2\+Priority\+Queue(const Wheel\+Timer\+Instance \&timeout, H\+T\+T\+P\+Codec\+::\+Stream\+I\+D root\+Node\+Id=0)}]{\setlength{\rightskip}{0pt plus 5cm}proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+H\+T\+T\+P2\+Priority\+Queue (
\begin{DoxyParamCaption}
\item[{const {\bf Wheel\+Timer\+Instance} \&}]{timeout, }
\item[{{\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID}}]{root\+Node\+Id = {\ttfamily 0}}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [explicit]}}\label{classproxygen_1_1HTTP2PriorityQueue_aae95bca2043f86c1946c345aece42448}


Definition at line 87 of file H\+T\+T\+P2\+Priority\+Queue.\+h.


\begin{DoxyCode}
89       : HTTP2PriorityQueueBase(rootNodeId),
90         nodes_(NodeMap::bucket\_traits(nodeBuckets_, kNumBuckets)),
91         root_(*\textcolor{keyword}{this}, \textcolor{keyword}{nullptr}, rootNodeId, 1, \textcolor{keyword}{nullptr}),
92         timeout_(timeout) \{
93     root_.setPermanent();
94   \}
\end{DoxyCode}


\subsection{Member Function Documentation}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!add\+Or\+Update\+Priority\+Node@{add\+Or\+Update\+Priority\+Node}}
\index{add\+Or\+Update\+Priority\+Node@{add\+Or\+Update\+Priority\+Node}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{add\+Or\+Update\+Priority\+Node(\+H\+T\+T\+P\+Codec\+::\+Stream\+I\+D id, http2\+::\+Priority\+Update pri)}]{\setlength{\rightskip}{0pt plus 5cm}void proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::add\+Or\+Update\+Priority\+Node (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID}}]{id, }
\item[{{\bf http2\+::\+Priority\+Update}}]{pri}
\end{DoxyParamCaption}
)}\label{classproxygen_1_1HTTP2PriorityQueue_a67e4c47f7b598513ecf028605336135a}


Definition at line 444 of file H\+T\+T\+P2\+Priority\+Queue.\+cpp.



References add\+Transaction(), find(), and update\+Priority().



Referenced by proxygen\+::\+H\+T\+T\+P\+Session\+::on\+Priority(), and proxygen\+::\+H\+T\+T\+P\+Session\+::send\+Priority().


\begin{DoxyCode}
445                                                                      \{
446   \textcolor{keyword}{auto} handle = find(\textcolor{keywordtype}{id});
447   \textcolor{keywordflow}{if} (handle) \{
448     \textcolor{comment}{// already added}
449     CHECK(handle->getTransaction() == \textcolor{keyword}{nullptr});
450     updatePriority(handle, pri);
451   \} \textcolor{keywordflow}{else} \{
452     \textcolor{comment}{// brand new}
453     addTransaction(\textcolor{keywordtype}{id}, pri, \textcolor{keyword}{nullptr}, \textcolor{keyword}{false} \textcolor{comment}{/* not permanent */});
454   \}
455 \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!add\+Priority\+Node@{add\+Priority\+Node}}
\index{add\+Priority\+Node@{add\+Priority\+Node}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{add\+Priority\+Node(\+H\+T\+T\+P\+Codec\+::\+Stream\+I\+D id, H\+T\+T\+P\+Codec\+::\+Stream\+I\+D parent) override}]{\setlength{\rightskip}{0pt plus 5cm}void proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::add\+Priority\+Node (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID}}]{id, }
\item[{{\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID}}]{parent}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [override]}, {\ttfamily [virtual]}}\label{classproxygen_1_1HTTP2PriorityQueue_a92631ad8256084b9abd06ffe739de3b1}


Implements {\bf proxygen\+::\+H\+T\+T\+P\+Codec\+::\+Priority\+Queue} \doxyref{}{p.}{classproxygen_1_1HTTPCodec_1_1PriorityQueue_abb613f1d0278eca54bc7e80d87137944}.



Definition at line 110 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



References proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base\+::add\+Transaction().


\begin{DoxyCode}
111                                                          \{
112     addTransaction(\textcolor{keywordtype}{id}, \{parent, \textcolor{keyword}{false}, 0\}, \textcolor{keyword}{nullptr}, \textcolor{keyword}{true});
113   \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!add\+Transaction@{add\+Transaction}}
\index{add\+Transaction@{add\+Transaction}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{add\+Transaction(\+H\+T\+T\+P\+Codec\+::\+Stream\+I\+D id, http2\+::\+Priority\+Update pri, H\+T\+T\+P\+Transaction $\ast$txn, bool permanent=false, uint64\+\_\+t $\ast$depth=nullptr) override}]{\setlength{\rightskip}{0pt plus 5cm}{\bf H\+T\+T\+P2\+Priority\+Queue\+::\+Handle} proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::add\+Transaction (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID}}]{id, }
\item[{{\bf http2\+::\+Priority\+Update}}]{pri, }
\item[{{\bf H\+T\+T\+P\+Transaction} $\ast$}]{txn, }
\item[{bool}]{permanent = {\ttfamily false}, }
\item[{uint64\+\_\+t $\ast$}]{depth = {\ttfamily {\bf nullptr}}}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}\label{classproxygen_1_1HTTP2PriorityQueue_a0f1114b1ae4f30fbee8b97413ebd8d5b}


Implements {\bf proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base} \doxyref{}{p.}{classproxygen_1_1HTTP2PriorityQueueBase_ab88b943c7dc595b06dd998ac7fe61efe}.



Definition at line 458 of file H\+T\+T\+P2\+Priority\+Queue.\+cpp.



References proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::convert\+Virtual\+Node(), proxygen\+::http2\+::\+Priority\+Update\+::exclusive, find(), proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::get\+I\+D(), max\+Virtual\+Nodes\+\_\+, num\+Virtual\+Nodes\+\_\+, pending\+Weight\+Change\+\_\+, root\+\_\+, proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base\+::root\+Node\+Id\+\_\+, schedule\+Node\+Expiration(), proxygen\+::http2\+::\+Priority\+Update\+::stream\+Dependency, update\+Priority(), and proxygen\+::http2\+::\+Priority\+Update\+::weight.



Referenced by add\+Or\+Update\+Priority\+Node(), and update\+Priority().


\begin{DoxyCode}
462                                                     \{
463   CHECK\_NE(\textcolor{keywordtype}{id}, rootNodeId_);
464   CHECK\_NE(\textcolor{keywordtype}{id}, pri.streamDependency) << \textcolor{stringliteral}{"Tried to create a loop in the tree"};
465   CHECK(!txn || !permanent);
466   Node *existingNode = find(\textcolor{keywordtype}{id}, depth);
467   \textcolor{keywordflow}{if} (existingNode) \{
468     CHECK(!permanent);
469     existingNode->convertVirtualNode(CHECK\_NOTNULL(txn));
470     updatePriority(existingNode, pri);
471     \textcolor{keywordflow}{return} existingNode;
472   \}
473   \textcolor{keywordflow}{if} (!txn) \{
474     \textcolor{keywordflow}{if} (numVirtualNodes_ >= maxVirtualNodes_) \{
475       \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
476     \}
477     numVirtualNodes_++;
478   \}
479 
480   Node* parent = &root_;
481   \textcolor{keywordflow}{if} (depth) \{
482     *depth = 1;
483   \}
484   \textcolor{keywordflow}{if} (pri.streamDependency != rootNodeId_) \{
485     Node* dep = find(pri.streamDependency, depth);
486     \textcolor{keywordflow}{if} (dep == \textcolor{keyword}{nullptr}) \{
487       \textcolor{comment}{// specified a missing parent (timed out an idle node)?}
488       VLOG(4) << \textcolor{stringliteral}{"assigning default priority to txn="} << id;
489       \textcolor{comment}{// No point to try to instantiate one more virtual node}
490       \textcolor{comment}{// if we already reached the virtual node limit}
491       \textcolor{keywordflow}{if} (numVirtualNodes_ < maxVirtualNodes_) \{
492         \textcolor{comment}{// The parent node hasn't arrived yet. For now setting}
493         \textcolor{comment}{// its priority fields to default.}
494         parent = \textcolor{keyword}{dynamic\_cast<}Node*\textcolor{keyword}{>}(
495             addTransaction(pri.streamDependency,
496                            \{rootNodeId\_,
497                             http2::DefaultPriority.exclusive,
498                             http2::DefaultPriority.weight\},
499                            \textcolor{keyword}{nullptr},
500                            permanent,
501                            depth));
502         CHECK\_NOTNULL(parent);
503         \textcolor{keywordflow}{if} (depth) \{
504           *depth += 1;
505         \}
506       \} \textcolor{keywordflow}{else} \{
507         VLOG(4) << \textcolor{stringliteral}{"Virtual node limit reached, ignoring stream dependency "}
508                 << pri.streamDependency << \textcolor{stringliteral}{" for new node ID "} << id;
509       \}
510     \} \textcolor{keywordflow}{else} \{
511       parent = dep;
512       \textcolor{keywordflow}{if} (depth) \{
513         *depth += 1;
514       \}
515     \}
516   \}
517   VLOG(4) << \textcolor{stringliteral}{"Adding id="} << \textcolor{keywordtype}{id} << \textcolor{stringliteral}{" with parent="} << parent->getID() <<
518     \textcolor{stringliteral}{" and weight="} << ((uint16\_t)pri.weight + 1);
519   \textcolor{keyword}{auto} node = std::make\_unique<Node>(*\textcolor{keyword}{this}, parent, id, pri.weight, txn);
520   \textcolor{keywordflow}{if} (permanent) \{
521     node->setPermanent();
522   \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!txn) \{
523     scheduleNodeExpiration(node.get());
524   \}
525   \textcolor{keyword}{auto} result = parent->emplaceNode(std::move(node), pri.exclusive);
526   pendingWeightChange_ = \textcolor{keyword}{true};
527   \textcolor{keywordflow}{return} result;
528 \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!allow\+Dangling\+Nodes@{allow\+Dangling\+Nodes}}
\index{allow\+Dangling\+Nodes@{allow\+Dangling\+Nodes}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{allow\+Dangling\+Nodes() const }]{\setlength{\rightskip}{0pt plus 5cm}bool proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::allow\+Dangling\+Nodes (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
) const\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_a823dae29c613335844f12ef0b8b3eb6f}


Definition at line 189 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



Referenced by remove\+Transaction().


\begin{DoxyCode}
189                                   \{
190     \textcolor{keywordflow}{return} timeout_ && kNodeLifetime_.count() > 0;
191   \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!attach\+Thread\+Locals@{attach\+Thread\+Locals}}
\index{attach\+Thread\+Locals@{attach\+Thread\+Locals}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{attach\+Thread\+Locals(const Wheel\+Timer\+Instance \&timeout)}]{\setlength{\rightskip}{0pt plus 5cm}void proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::attach\+Thread\+Locals (
\begin{DoxyParamCaption}
\item[{const {\bf Wheel\+Timer\+Instance} \&}]{timeout}
\end{DoxyParamCaption}
)}\label{classproxygen_1_1HTTP2PriorityQueue_acaad3c130c9e92d91ffdcf97a7ac6d1c}


class \doxyref{H\+T\+T\+P2\+Priority\+Queue}{p.}{classproxygen_1_1HTTP2PriorityQueue} 



Definition at line 433 of file H\+T\+T\+P2\+Priority\+Queue.\+cpp.



References timeout\+\_\+.



Referenced by proxygen\+::\+H\+T\+T\+P\+Upstream\+Session\+::attach\+Thread\+Locals().


\begin{DoxyCode}
433                                                                              \{
434   timeout_ = timeout;
435 \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!clear\+Pending\+Egress@{clear\+Pending\+Egress}}
\index{clear\+Pending\+Egress@{clear\+Pending\+Egress}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{clear\+Pending\+Egress(\+Handle h) override}]{\setlength{\rightskip}{0pt plus 5cm}void proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::clear\+Pending\+Egress (
\begin{DoxyParamCaption}
\item[{{\bf Handle}}]{h}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}\label{classproxygen_1_1HTTP2PriorityQueue_abc08640ffefe5b0a867a29dea74eee59}


Implements {\bf proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base} \doxyref{}{p.}{classproxygen_1_1HTTP2PriorityQueueBase_a775fcd7d7d4c27b71ca700c4f7ef93ff}.



Definition at line 611 of file H\+T\+T\+P2\+Priority\+Queue.\+cpp.



References active\+Count\+\_\+, and pending\+Weight\+Change\+\_\+.


\begin{DoxyCode}
611                                                     \{
612   CHECK\_GT(activeCount_, 0);
613   \textcolor{comment}{// clear does a CHECK on handle->isEnqueued()}
614   CHECK\_NOTNULL(dynamic\_cast<HTTP2PriorityQueue::Node*>(handle))
615     ->clearPendingEgress();
616   activeCount_--;
617   pendingWeightChange_ = \textcolor{keyword}{true};
618 \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!detach\+Thread\+Locals@{detach\+Thread\+Locals}}
\index{detach\+Thread\+Locals@{detach\+Thread\+Locals}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{detach\+Thread\+Locals()}]{\setlength{\rightskip}{0pt plus 5cm}void proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::detach\+Thread\+Locals (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}\label{classproxygen_1_1HTTP2PriorityQueue_a795a9d524c7c784d2978f770368a4573}


Definition at line 437 of file H\+T\+T\+P2\+Priority\+Queue.\+cpp.



References proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::drop\+Priority\+Nodes(), and timeout\+\_\+.



Referenced by proxygen\+::\+H\+T\+T\+P\+Upstream\+Session\+::detach\+Thread\+Locals().


\begin{DoxyCode}
437                                             \{
438   \textcolor{comment}{// a bit harsh, we could cancel and reschedule the timeout}
439   dropPriorityNodes();
440   timeout_ = WheelTimerInstance();
441 \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!drop\+Priority\+Nodes@{drop\+Priority\+Nodes}}
\index{drop\+Priority\+Nodes@{drop\+Priority\+Nodes}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{drop\+Priority\+Nodes()}]{\setlength{\rightskip}{0pt plus 5cm}void proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::drop\+Priority\+Nodes (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}}\label{classproxygen_1_1HTTP2PriorityQueue_aaa4cae92ec2e25ffda692e39e2215fc3}


Definition at line 118 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



References proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base\+::add\+Transaction(), proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base\+::remove\+Transaction(), and proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base\+::update\+Priority().



Referenced by proxygen\+::\+H\+T\+T\+P\+Session\+::$\sim$\+H\+T\+T\+P\+Session().


\begin{DoxyCode}
118                            \{
119     root_.dropPriorityNodes();
120   \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!empty@{empty}}
\index{empty@{empty}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{empty() const }]{\setlength{\rightskip}{0pt plus 5cm}bool proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::empty (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
) const\hspace{0.3cm}{\ttfamily [inline]}}\label{classproxygen_1_1HTTP2PriorityQueue_ad0b3818288824506c5a3abb23101f439}


Definition at line 137 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



Referenced by proxygen\+::\+H\+T\+T\+P\+Session\+::get\+Next\+To\+Send(), proxygen\+::\+H\+T\+T\+P\+Session\+::has\+More\+Writes(), proxygen\+::\+H\+T\+T\+P\+Session\+::on\+Connection\+Send\+Window\+Closed(), proxygen\+::\+H\+T\+T\+P\+Session\+::schedule\+Write(), and proxygen\+::\+H\+T\+T\+P\+Session\+::$\sim$\+H\+T\+T\+P\+Session().


\begin{DoxyCode}
137                      \{
138     \textcolor{keywordflow}{return} activeCount_ == 0;
139   \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!find@{find}}
\index{find@{find}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{find(\+H\+T\+T\+P\+Codec\+::\+Stream\+I\+D id, uint64\+\_\+t $\ast$depth=nullptr)}]{\setlength{\rightskip}{0pt plus 5cm}{\bf H\+T\+T\+P2\+Priority\+Queue\+::\+Node} $\ast$ proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::find (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID}}]{id, }
\item[{uint64\+\_\+t $\ast$}]{depth = {\ttfamily {\bf nullptr}}}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_afb9f1555bf188aa261fae13785580d64}


Definition at line 700 of file H\+T\+T\+P2\+Priority\+Queue.\+cpp.



References nodes\+\_\+, and proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base\+::root\+Node\+Id\+\_\+.



Referenced by add\+Or\+Update\+Priority\+Node(), add\+Transaction(), and update\+Priority().


\begin{DoxyCode}
700                                                               \{
701   \textcolor{keywordflow}{if} (\textcolor{keywordtype}{id} == rootNodeId_) \{
702     \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
703   \}
704   \textcolor{keyword}{auto} it = nodes_.find(\textcolor{keywordtype}{id}, Node::IdHash(), Node::IdNodeEqual());
705   \textcolor{keywordflow}{if} (it == nodes_.end()) \{
706     \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
707   \}
708   \textcolor{keywordflow}{if} (depth) \{
709     *depth = it->calculateDepth();
710   \}
711   \textcolor{keywordflow}{return} &(*it);
712 \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!find\+Internal@{find\+Internal}}
\index{find\+Internal@{find\+Internal}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{find\+Internal(\+H\+T\+T\+P\+Codec\+::\+Stream\+I\+D id)}]{\setlength{\rightskip}{0pt plus 5cm}{\bf Node}$\ast$ proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::find\+Internal (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID}}]{id}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_ad17068dd456f93a95072ec3e43a978bb}


Definition at line 182 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



References proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base\+::root\+Node\+Id\+\_\+.



Referenced by iterate\+B\+F\+S().


\begin{DoxyCode}
182                                            \{
183     \textcolor{keywordflow}{if} (\textcolor{keywordtype}{id} == rootNodeId_) \{
184       \textcolor{keywordflow}{return} &root_;
185     \}
186     \textcolor{keywordflow}{return} find(\textcolor{keywordtype}{id});
187   \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!get\+Rebuild\+Count@{get\+Rebuild\+Count}}
\index{get\+Rebuild\+Count@{get\+Rebuild\+Count}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{get\+Rebuild\+Count() const }]{\setlength{\rightskip}{0pt plus 5cm}uint32\+\_\+t proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::get\+Rebuild\+Count (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
) const\hspace{0.3cm}{\ttfamily [inline]}}\label{classproxygen_1_1HTTP2PriorityQueue_a1999fc82a9aa0e63e48def2b601b681a}


Definition at line 175 of file H\+T\+T\+P2\+Priority\+Queue.\+h.


\begin{DoxyCode}
175 \{ \textcolor{keywordflow}{return} rebuildCount_; \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!is\+Rebuilt@{is\+Rebuilt}}
\index{is\+Rebuilt@{is\+Rebuilt}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{is\+Rebuilt() const }]{\setlength{\rightskip}{0pt plus 5cm}bool proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::is\+Rebuilt (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
) const\hspace{0.3cm}{\ttfamily [inline]}}\label{classproxygen_1_1HTTP2PriorityQueue_a19a74cb604e8236e03004676ebaf348b}


Definition at line 176 of file H\+T\+T\+P2\+Priority\+Queue.\+h.


\begin{DoxyCode}
176 \{ \textcolor{keywordflow}{return} rebuildCount_ > 0; \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!iterate@{iterate}}
\index{iterate@{iterate}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{iterate(const std\+::function$<$ bool(\+H\+T\+T\+P\+Codec\+::\+Stream\+I\+D, H\+T\+T\+P\+Transaction $\ast$, double)$>$ \&fn, const std\+::function$<$ bool()$>$ \&stop\+Fn, bool all)}]{\setlength{\rightskip}{0pt plus 5cm}void proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::iterate (
\begin{DoxyParamCaption}
\item[{const std\+::function$<$ bool({\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID}, {\bf H\+T\+T\+P\+Transaction} $\ast$, double)$>$ \&}]{fn, }
\item[{const std\+::function$<$ bool()$>$ \&}]{stop\+Fn, }
\item[{bool}]{all}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}}\label{classproxygen_1_1HTTP2PriorityQueue_aee7f2f2e01154e1db112e6b3aa455ce0}


Definition at line 150 of file H\+T\+T\+P2\+Priority\+Queue.\+h.


\begin{DoxyCode}
152                                                             \{
153     updateEnqueuedWeight();
154     root_.iterate(fn, stopFn, all);
155   \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!iterate\+B\+FS@{iterate\+B\+FS}}
\index{iterate\+B\+FS@{iterate\+B\+FS}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{iterate\+B\+F\+S(const std\+::function$<$ bool(\+H\+T\+T\+P2\+Priority\+Queue \&, H\+T\+T\+P\+Codec\+::\+Stream\+I\+D, H\+T\+T\+P\+Transaction $\ast$, double)$>$ \&fn, const std\+::function$<$ bool()$>$ \&stop\+Fn, bool all)}]{\setlength{\rightskip}{0pt plus 5cm}void proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::iterate\+B\+FS (
\begin{DoxyParamCaption}
\item[{const std\+::function$<$ bool({\bf H\+T\+T\+P2\+Priority\+Queue} \&, {\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID}, {\bf H\+T\+T\+P\+Transaction} $\ast$, double)$>$ \&}]{fn, }
\item[{const std\+::function$<$ bool()$>$ \&}]{stop\+Fn, }
\item[{bool}]{all}
\end{DoxyParamCaption}
)}\label{classproxygen_1_1HTTP2PriorityQueue_adcbbcfcc49189030798249dc896fcac7}


Definition at line 621 of file H\+T\+T\+P2\+Priority\+Queue.\+cpp.



References find\+Internal(), root\+\_\+, proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base\+::root\+Node\+Id\+\_\+, proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::update\+Enqueued\+Weight(), and proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::visit\+B\+F\+S().



Referenced by proxygen\+::\+H\+T\+T\+P\+Session\+::resume\+Transactions().


\begin{DoxyCode}
624                                                \{
625   Node::PendingList pendingNodes\{\{rootNodeId_, &root_, 1.0\}\};
626   Node::PendingList newPendingNodes;
627   \textcolor{keywordtype}{bool} stop = \textcolor{keyword}{false};
628 
629   updateEnqueuedWeight();
630   \textcolor{keywordflow}{while} (!stop && !stopFn() && !pendingNodes.empty()) \{
631     CHECK(newPendingNodes.empty());
632     \textcolor{keywordflow}{while} (!stop && !pendingNodes.empty()) \{
633       Node* node = findInternal(pendingNodes.front().id);
634       \textcolor{keywordflow}{if} (node) \{
635         stop = node->visitBFS(pendingNodes.front().ratio, fn, all,
636                               newPendingNodes, \textcolor{keyword}{false} \textcolor{comment}{/* all children */});
637       \}
638       pendingNodes.pop\_front();
639     \}
640     std::swap(pendingNodes, newPendingNodes);
641   \}
642 \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!next\+Egress@{next\+Egress}}
\index{next\+Egress@{next\+Egress}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{next\+Egress(\+Next\+Egress\+Result \&result, bool spdy\+Mode=false)}]{\setlength{\rightskip}{0pt plus 5cm}void proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::next\+Egress (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P2\+Priority\+Queue\+::\+Next\+Egress\+Result} \&}]{result, }
\item[{bool}]{spdy\+Mode = {\ttfamily false}}
\end{DoxyParamCaption}
)}\label{classproxygen_1_1HTTP2PriorityQueue_ae7a98e71ef297cccaa40e64ded686951}


Definition at line 653 of file H\+T\+T\+P2\+Priority\+Queue.\+cpp.



References active\+Count\+\_\+, next\+Egress\+Result(), next\+Egress\+Results\+\_\+, root\+\_\+, proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base\+::root\+Node\+Id\+\_\+, proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::update\+Enqueued\+Weight(), and proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::visit\+B\+F\+S().



Referenced by proxygen\+::\+H\+T\+T\+P\+Session\+::get\+Next\+To\+Send().


\begin{DoxyCode}
654                                               \{
655   \textcolor{keyword}{struct }WeightCmp \{
656     \textcolor{keywordtype}{bool} operator()(\textcolor{keyword}{const} std::pair<HTTPTransaction*, double>& t1,
657                     \textcolor{keyword}{const} std::pair<HTTPTransaction*, double>& t2) \{
658       \textcolor{keywordflow}{return} t1.second > t2.second;
659     \}
660   \};
661 
662   result.reserve(activeCount_);
663   nextEgressResults_ = &result;
664 
665   updateEnqueuedWeight();
666   Node::PendingList pendingNodes;
667   Node::PendingList pendingNodesTmp;
668   pendingNodes.emplace\_back(rootNodeId_, &root_, 1.0);
669   \textcolor{keywordtype}{bool} stop = \textcolor{keyword}{false};
670   \textcolor{keywordflow}{do} \{
671     \textcolor{keywordflow}{while} (!stop && !pendingNodes.empty()) \{
672       Node* node = pendingNodes.front().node;
673       \textcolor{keywordflow}{if} (node) \{
674         stop = node->visitBFS(pendingNodes.front().ratio, nextEgressResult,
675                               \textcolor{keyword}{false}, pendingNodesTmp,
676                               \textcolor{keyword}{true} \textcolor{comment}{/* enqueued children */});
677       \}
678       pendingNodes.pop\_front();
679     \}
680     \textcolor{comment}{// In SPDY mode, we stop as soon one level of the tree produces results,}
681     \textcolor{comment}{// then normalize the ratios.}
682     \textcolor{keywordflow}{if} (spdyMode && !result.empty() && !pendingNodesTmp.empty()) \{
683       \textcolor{keywordtype}{double} totalRatio = 0;
684       \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} &txnPair: result) \{
685         totalRatio += txnPair.second;
686       \}
687       CHECK\_GT(totalRatio, 0);
688       \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} &txnPair: result) \{
689         txnPair.second = txnPair.second / totalRatio;
690       \}
691       \textcolor{keywordflow}{break};
692     \}
693     std::swap(pendingNodes, pendingNodesTmp);
694   \} \textcolor{keywordflow}{while} (!stop && !pendingNodes.empty());
695   std::sort(result.begin(), result.end(), WeightCmp());
696   nextEgressResults_ = \textcolor{keyword}{nullptr};
697 \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!next\+Egress\+Result@{next\+Egress\+Result}}
\index{next\+Egress\+Result@{next\+Egress\+Result}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{next\+Egress\+Result(\+H\+T\+T\+P2\+Priority\+Queue \&queue, H\+T\+T\+P\+Codec\+::\+Stream\+I\+D id, H\+T\+T\+P\+Transaction $\ast$txn, double r)}]{\setlength{\rightskip}{0pt plus 5cm}bool proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::next\+Egress\+Result (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P2\+Priority\+Queue} \&}]{queue, }
\item[{{\bf H\+T\+T\+P\+Codec\+::\+Stream\+ID}}]{id, }
\item[{{\bf H\+T\+T\+P\+Transaction} $\ast$}]{txn, }
\item[{double}]{r}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}, {\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_ae806041664cbc84f66c5826b8d349177}


Definition at line 645 of file H\+T\+T\+P2\+Priority\+Queue.\+cpp.



References next\+Egress\+Results\+\_\+.



Referenced by next\+Egress().


\begin{DoxyCode}
647                                                                      \{
648   queue.nextEgressResults\_->emplace\_back(txn, r);
649   \textcolor{keywordflow}{return} \textcolor{keyword}{false};
650 \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!num\+Pending\+Egress@{num\+Pending\+Egress}}
\index{num\+Pending\+Egress@{num\+Pending\+Egress}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{num\+Pending\+Egress() const }]{\setlength{\rightskip}{0pt plus 5cm}uint64\+\_\+t proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::num\+Pending\+Egress (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
) const\hspace{0.3cm}{\ttfamily [inline]}}\label{classproxygen_1_1HTTP2PriorityQueue_a30544c5f16c80484c7ef3d32f155f490}


Definition at line 142 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



Referenced by proxygen\+::\+H\+T\+T\+P\+Session\+::run\+Loop\+Callback().


\begin{DoxyCode}
142                                     \{
143     \textcolor{keywordflow}{return} activeCount_;
144   \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!num\+Virtual\+Nodes@{num\+Virtual\+Nodes}}
\index{num\+Virtual\+Nodes@{num\+Virtual\+Nodes}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{num\+Virtual\+Nodes() const }]{\setlength{\rightskip}{0pt plus 5cm}uint64\+\_\+t proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::num\+Virtual\+Nodes (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
) const\hspace{0.3cm}{\ttfamily [inline]}}\label{classproxygen_1_1HTTP2PriorityQueue_a201fca5cd327bb602666f5cd928bc3c6}


Definition at line 146 of file H\+T\+T\+P2\+Priority\+Queue.\+h.


\begin{DoxyCode}
146                                    \{
147     \textcolor{keywordflow}{return} numVirtualNodes_;
148   \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!rebuild\+Tree@{rebuild\+Tree}}
\index{rebuild\+Tree@{rebuild\+Tree}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{rebuild\+Tree()}]{\setlength{\rightskip}{0pt plus 5cm}void proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::rebuild\+Tree (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}\label{classproxygen_1_1HTTP2PriorityQueue_a1c522c4128ea274ee5772d69d9f30b34}


Error handling code. 



Definition at line 727 of file H\+T\+T\+P2\+Priority\+Queue.\+cpp.



References proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::flatten\+Subtree(), k\+Max\+Rebuilds\+\_\+, rebuild\+Count\+\_\+, and root\+\_\+.


\begin{DoxyCode}
727                                 \{
728   CHECK\_LE(rebuildCount_ + 1, kMaxRebuilds_);
729   root_.flattenSubtree();
730   rebuildCount_++;
731 \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!remove\+Transaction@{remove\+Transaction}}
\index{remove\+Transaction@{remove\+Transaction}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{remove\+Transaction(\+Handle handle) override}]{\setlength{\rightskip}{0pt plus 5cm}void proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::remove\+Transaction (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P2\+Priority\+Queue\+::\+Handle}}]{handle}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}\label{classproxygen_1_1HTTP2PriorityQueue_a681d153d627f4f8d383e0859cce9f56d}


Implements {\bf proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base} \doxyref{}{p.}{classproxygen_1_1HTTP2PriorityQueueBase_ab9fda9e325d10dd40994ee45b49c0324}.



Definition at line 583 of file H\+T\+T\+P2\+Priority\+Queue.\+cpp.



References allow\+Dangling\+Nodes(), proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::clear\+Pending\+Egress(), proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::clear\+Transaction(), proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::get\+I\+D(), proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::is\+Enqueued(), max\+Virtual\+Nodes\+\_\+, num\+Virtual\+Nodes\+\_\+, pending\+Weight\+Change\+\_\+, proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::remove\+From\+Tree(), and schedule\+Node\+Expiration().


\begin{DoxyCode}
583                                                                      \{
584   Node* node = CHECK\_NOTNULL(dynamic\_cast<HTTP2PriorityQueue::Node*>(handle));
585   pendingWeightChange_ = \textcolor{keyword}{true};
586   \textcolor{comment}{// TODO: or require the node to do it?}
587   \textcolor{keywordflow}{if} (node->isEnqueued()) \{
588     clearPendingEgress(handle);
589   \}
590   \textcolor{keywordflow}{if} (allowDanglingNodes() && numVirtualNodes_ < maxVirtualNodes_) \{
591     node->clearTransaction();
592     numVirtualNodes_++;
593     scheduleNodeExpiration(node);
594   \} \textcolor{keywordflow}{else} \{
595     VLOG(5) << \textcolor{stringliteral}{"Deleting dangling node over max id="} << node->getID();
596     node->removeFromTree();
597   \}
598 \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!schedule\+Node\+Expiration@{schedule\+Node\+Expiration}}
\index{schedule\+Node\+Expiration@{schedule\+Node\+Expiration}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{schedule\+Node\+Expiration(\+Node $\ast$node)}]{\setlength{\rightskip}{0pt plus 5cm}void proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::schedule\+Node\+Expiration (
\begin{DoxyParamCaption}
\item[{{\bf Node} $\ast$}]{node}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_a031ffffa94e491cb5f2ae7c038d1a7cc}


Definition at line 193 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



References proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::get\+I\+D().



Referenced by add\+Transaction(), proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::detach\+Child(), and remove\+Transaction().


\begin{DoxyCode}
193                                           \{
194     \textcolor{keywordflow}{if} (timeout_) \{
195       VLOG(5) << \textcolor{stringliteral}{"scheduling expiration for node="} << node->getID();
196       DCHECK\_GT(kNodeLifetime_.count(), 0);
197       timeout_.scheduleTimeout(node, kNodeLifetime_);
198     \}
199   \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!set\+Max\+Virtual\+Nodes@{set\+Max\+Virtual\+Nodes}}
\index{set\+Max\+Virtual\+Nodes@{set\+Max\+Virtual\+Nodes}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{set\+Max\+Virtual\+Nodes(uint32\+\_\+t max\+Virtual\+Nodes)}]{\setlength{\rightskip}{0pt plus 5cm}void proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::set\+Max\+Virtual\+Nodes (
\begin{DoxyParamCaption}
\item[{uint32\+\_\+t}]{max\+Virtual\+Nodes}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}}\label{classproxygen_1_1HTTP2PriorityQueue_a2e486d1e0df051e3caf104c92a237595}


Definition at line 100 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



References proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base\+::clear\+Pending\+Egress(), and proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base\+::signal\+Pending\+Egress().


\begin{DoxyCode}
100                                                     \{
101     maxVirtualNodes_ = maxVirtualNodes;
102   \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!set\+Node\+Lifetime@{set\+Node\+Lifetime}}
\index{set\+Node\+Lifetime@{set\+Node\+Lifetime}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{set\+Node\+Lifetime(std\+::chrono\+::milliseconds lifetime)}]{\setlength{\rightskip}{0pt plus 5cm}static void proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::set\+Node\+Lifetime (
\begin{DoxyParamCaption}
\item[{std\+::chrono\+::milliseconds}]{lifetime}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [static]}}\label{classproxygen_1_1HTTP2PriorityQueue_aada08a779ebec54ef40f17657d2f1364}


Definition at line 167 of file H\+T\+T\+P2\+Priority\+Queue.\+h.


\begin{DoxyCode}
167                                                               \{
168     kNodeLifetime_ = lifetime;
169   \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!signal\+Pending\+Egress@{signal\+Pending\+Egress}}
\index{signal\+Pending\+Egress@{signal\+Pending\+Egress}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{signal\+Pending\+Egress(\+Handle h) override}]{\setlength{\rightskip}{0pt plus 5cm}void proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::signal\+Pending\+Egress (
\begin{DoxyParamCaption}
\item[{{\bf Handle}}]{h}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}\label{classproxygen_1_1HTTP2PriorityQueue_aa6cb4f1766dbef9faee951ddfb4478a6}


Implements {\bf proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base} \doxyref{}{p.}{classproxygen_1_1HTTP2PriorityQueueBase_affc0541d33b92f8ac94bb95faf4d9015}.



Definition at line 601 of file H\+T\+T\+P2\+Priority\+Queue.\+cpp.



References active\+Count\+\_\+, proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base\+::\+Base\+Node\+::is\+Enqueued(), and pending\+Weight\+Change\+\_\+.


\begin{DoxyCode}
601                                                      \{
602   \textcolor{keywordflow}{if} (!handle->isEnqueued()) \{
603     CHECK\_NOTNULL(dynamic\_cast<HTTP2PriorityQueue::Node*>(handle))
604       ->signalPendingEgress();
605     activeCount_++;
606     pendingWeightChange_ = \textcolor{keyword}{true};
607   \}
608 \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!update\+Enqueued\+Weight@{update\+Enqueued\+Weight}}
\index{update\+Enqueued\+Weight@{update\+Enqueued\+Weight}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{update\+Enqueued\+Weight()}]{\setlength{\rightskip}{0pt plus 5cm}void proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::update\+Enqueued\+Weight (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_ac57ce4be6d8e7623200739bdd2da8bf5}


Definition at line 715 of file H\+T\+T\+P2\+Priority\+Queue.\+cpp.



References active\+Count\+\_\+, pending\+Weight\+Change\+\_\+, root\+\_\+, and proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::update\+Enqueued\+Weight().


\begin{DoxyCode}
715                                          \{
716 \textcolor{preprocessor}{#ifndef NDEBUG}
717   \textcolor{keywordflow}{if} (pendingWeightChange_) \{
718     root_.updateEnqueuedWeight(activeCount_ > 0);
719     pendingWeightChange_ = \textcolor{keyword}{false};
720   \}
721 \textcolor{preprocessor}{#endif}
722 \}
\end{DoxyCode}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!update\+Priority@{update\+Priority}}
\index{update\+Priority@{update\+Priority}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{update\+Priority(\+Handle handle, http2\+::\+Priority\+Update pri, uint64\+\_\+t $\ast$depth=nullptr) override}]{\setlength{\rightskip}{0pt plus 5cm}{\bf H\+T\+T\+P2\+Priority\+Queue\+::\+Handle} proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::update\+Priority (
\begin{DoxyParamCaption}
\item[{{\bf H\+T\+T\+P2\+Priority\+Queue\+::\+Handle}}]{handle, }
\item[{{\bf http2\+::\+Priority\+Update}}]{pri, }
\item[{uint64\+\_\+t $\ast$}]{depth = {\ttfamily {\bf nullptr}}}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}\label{classproxygen_1_1HTTP2PriorityQueue_a16276ac880fcec6859ce73eb96daacf0}


Implements {\bf proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base} \doxyref{}{p.}{classproxygen_1_1HTTP2PriorityQueueBase_a79981b30f800a1f4872ddbd708c1bc5a}.



Definition at line 531 of file H\+T\+T\+P2\+Priority\+Queue.\+cpp.



References add\+Transaction(), proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base\+::\+Base\+Node\+::calculate\+Depth(), proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::calculate\+Depth(), proxygen\+::http2\+::\+Priority\+Update\+::exclusive, find(), proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::get\+I\+D(), proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::get\+Parent(), proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::is\+Descendant\+Of(), max\+Virtual\+Nodes\+\_\+, num\+Virtual\+Nodes\+\_\+, proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::parent\+I\+D(), pending\+Weight\+Change\+\_\+, proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::reparent(), root\+\_\+, proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+Base\+::root\+Node\+Id\+\_\+, proxygen\+::http2\+::\+Priority\+Update\+::stream\+Dependency, proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::update\+Weight(), and proxygen\+::http2\+::\+Priority\+Update\+::weight.



Referenced by add\+Or\+Update\+Priority\+Node(), and add\+Transaction().


\begin{DoxyCode}
533                                                     \{
534   Node* node = CHECK\_NOTNULL(dynamic\_cast<HTTP2PriorityQueue::Node*>(handle));
535   pendingWeightChange_ = \textcolor{keyword}{true};
536   VLOG(4) << \textcolor{stringliteral}{"Updating id="} << node->getID() << \textcolor{stringliteral}{" with parent="} <<
537     pri.streamDependency << \textcolor{stringliteral}{" and weight="} << ((uint16\_t)pri.weight + 1);
538   node->updateWeight(pri.weight);
539   CHECK\_NE(pri.streamDependency, node->getID()) <<
540     \textcolor{stringliteral}{"Tried to create a loop in the tree"};
541   \textcolor{keywordflow}{if} (pri.streamDependency == node->parentID() && !pri.exclusive) \{
542     \textcolor{comment}{// no move}
543     \textcolor{keywordflow}{if} (depth) \{
544       *depth = handle->calculateDepth();
545     \}
546     \textcolor{keywordflow}{return} handle;
547   \}
548 
549   Node* newParent = find(pri.streamDependency, depth);
550   \textcolor{keywordflow}{if} (!newParent) \{
551     \textcolor{keywordflow}{if} (pri.streamDependency == rootNodeId_ ||
552         numVirtualNodes_ >= maxVirtualNodes_) \{
553       newParent = &root_;
554     \} \textcolor{keywordflow}{else} \{
555       \textcolor{comment}{// allocate a virtual node for non-existing parent in my depenency tree}
556       \textcolor{comment}{// then do normal priority processing}
557       newParent = \textcolor{keyword}{dynamic\_cast<}Node*\textcolor{keyword}{>}(
558           addTransaction(pri.streamDependency,
559                          \{rootNodeId\_,
560                           http2::DefaultPriority.exclusive,
561                           http2::DefaultPriority.weight\},
562                          \textcolor{keyword}{nullptr},
563                          \textcolor{keyword}{false},
564                          depth));
565 
566       CHECK\_NOTNULL(newParent);
567       VLOG(4) << \textcolor{stringliteral}{"updatePriority missing parent, creating virtual parent="}
568               << newParent->getID() << \textcolor{stringliteral}{" for txn="} << node->getID();
569     \}
570   \}
571 
572   \textcolor{keywordflow}{if} (newParent->isDescendantOf(node)) \{
573     newParent = newParent->reparent(node->getParent(), \textcolor{keyword}{false});
574   \}
575   node = node->reparent(newParent, pri.exclusive);
576   \textcolor{keywordflow}{if} (depth) \{
577     *depth = node->calculateDepth();
578   \}
579   \textcolor{keywordflow}{return} node;
580 \}
\end{DoxyCode}


\subsection{Member Data Documentation}
\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!active\+Count\+\_\+@{active\+Count\+\_\+}}
\index{active\+Count\+\_\+@{active\+Count\+\_\+}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{active\+Count\+\_\+}]{\setlength{\rightskip}{0pt plus 5cm}uint64\+\_\+t proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::active\+Count\+\_\+ \{0\}\hspace{0.3cm}{\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_aec5a80788f0441adfb5f88a32d6a2fdc}


Definition at line 426 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



Referenced by clear\+Pending\+Egress(), next\+Egress(), signal\+Pending\+Egress(), and update\+Enqueued\+Weight().

\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!k\+Max\+Rebuilds\+\_\+@{k\+Max\+Rebuilds\+\_\+}}
\index{k\+Max\+Rebuilds\+\_\+@{k\+Max\+Rebuilds\+\_\+}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{k\+Max\+Rebuilds\+\_\+}]{\setlength{\rightskip}{0pt plus 5cm}uint32\+\_\+t proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::k\+Max\+Rebuilds\+\_\+ = 3\hspace{0.3cm}{\ttfamily [static]}, {\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_adfe15f90202ed06b96bfcf099b621af8}


Definition at line 425 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



Referenced by rebuild\+Tree().

\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!k\+Node\+Lifetime\+\_\+@{k\+Node\+Lifetime\+\_\+}}
\index{k\+Node\+Lifetime\+\_\+@{k\+Node\+Lifetime\+\_\+}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{k\+Node\+Lifetime\+\_\+}]{\setlength{\rightskip}{0pt plus 5cm}std\+::chrono\+::milliseconds proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::k\+Node\+Lifetime\+\_\+\hspace{0.3cm}{\ttfamily [static]}, {\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_a7ef07bbcb75673840058ca99261e490c}
{\bfseries Initial value\+:}
\begin{DoxyCode}
=
  std::chrono::seconds(30)
\end{DoxyCode}


Definition at line 433 of file H\+T\+T\+P2\+Priority\+Queue.\+h.

\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!k\+Num\+Buckets@{k\+Num\+Buckets}}
\index{k\+Num\+Buckets@{k\+Num\+Buckets}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{k\+Num\+Buckets}]{\setlength{\rightskip}{0pt plus 5cm}const size\+\_\+t proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::k\+Num\+Buckets = 100\hspace{0.3cm}{\ttfamily [static]}, {\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_ae1517dd39ac349c682c1a98e743c151e}


Definition at line 76 of file H\+T\+T\+P2\+Priority\+Queue.\+h.

\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!max\+Virtual\+Nodes\+\_\+@{max\+Virtual\+Nodes\+\_\+}}
\index{max\+Virtual\+Nodes\+\_\+@{max\+Virtual\+Nodes\+\_\+}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{max\+Virtual\+Nodes\+\_\+}]{\setlength{\rightskip}{0pt plus 5cm}uint32\+\_\+t proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::max\+Virtual\+Nodes\+\_\+ \{50\}\hspace{0.3cm}{\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_a0ea027a556c831f57c0579c172d4901c}


Definition at line 427 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



Referenced by add\+Transaction(), remove\+Transaction(), and update\+Priority().

\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!next\+Egress\+Results\+\_\+@{next\+Egress\+Results\+\_\+}}
\index{next\+Egress\+Results\+\_\+@{next\+Egress\+Results\+\_\+}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{next\+Egress\+Results\+\_\+}]{\setlength{\rightskip}{0pt plus 5cm}{\bf Next\+Egress\+Result}$\ast$ proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::next\+Egress\+Results\+\_\+ \{{\bf nullptr}\}\hspace{0.3cm}{\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_aa46f36146598be2c0a254619f7379d9d}


Definition at line 432 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



Referenced by next\+Egress(), and next\+Egress\+Result().

\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!node\+Buckets\+\_\+@{node\+Buckets\+\_\+}}
\index{node\+Buckets\+\_\+@{node\+Buckets\+\_\+}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{node\+Buckets\+\_\+}]{\setlength{\rightskip}{0pt plus 5cm}Node\+Map\+::bucket\+\_\+type proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::node\+Buckets\+\_\+[{\bf k\+Num\+Buckets}]\hspace{0.3cm}{\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_abf58a7d0c7a961b7464f297dafccf511}


Definition at line 421 of file H\+T\+T\+P2\+Priority\+Queue.\+h.

\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!nodes\+\_\+@{nodes\+\_\+}}
\index{nodes\+\_\+@{nodes\+\_\+}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{nodes\+\_\+}]{\setlength{\rightskip}{0pt plus 5cm}{\bf Node\+Map} proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::nodes\+\_\+\hspace{0.3cm}{\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_a3587cbdd473166fed035273971c28c52}


Definition at line 422 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



Referenced by find(), and proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::\+Node().

\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!num\+Virtual\+Nodes\+\_\+@{num\+Virtual\+Nodes\+\_\+}}
\index{num\+Virtual\+Nodes\+\_\+@{num\+Virtual\+Nodes\+\_\+}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{num\+Virtual\+Nodes\+\_\+}]{\setlength{\rightskip}{0pt plus 5cm}uint32\+\_\+t proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::num\+Virtual\+Nodes\+\_\+ \{0\}\hspace{0.3cm}{\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_ab34d7645f95a94e5f46349fc01757a7e}


Definition at line 428 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



Referenced by add\+Transaction(), proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::convert\+Virtual\+Node(), remove\+Transaction(), update\+Priority(), and proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::\+Node\+::$\sim$\+Node().

\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!pending\+Weight\+Change\+\_\+@{pending\+Weight\+Change\+\_\+}}
\index{pending\+Weight\+Change\+\_\+@{pending\+Weight\+Change\+\_\+}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{pending\+Weight\+Change\+\_\+}]{\setlength{\rightskip}{0pt plus 5cm}bool proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::pending\+Weight\+Change\+\_\+ \{false\}\hspace{0.3cm}{\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_a44c67d416b18c57368f22cf8dc92a188}


Definition at line 429 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



Referenced by add\+Transaction(), clear\+Pending\+Egress(), remove\+Transaction(), signal\+Pending\+Egress(), update\+Enqueued\+Weight(), and update\+Priority().

\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!rebuild\+Count\+\_\+@{rebuild\+Count\+\_\+}}
\index{rebuild\+Count\+\_\+@{rebuild\+Count\+\_\+}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{rebuild\+Count\+\_\+}]{\setlength{\rightskip}{0pt plus 5cm}uint32\+\_\+t proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::rebuild\+Count\+\_\+ \{0\}\hspace{0.3cm}{\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_ad03d3ff2b88896b65c4dcaaf2c04bf49}


Definition at line 424 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



Referenced by rebuild\+Tree().

\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!root\+\_\+@{root\+\_\+}}
\index{root\+\_\+@{root\+\_\+}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{root\+\_\+}]{\setlength{\rightskip}{0pt plus 5cm}{\bf Node} proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::root\+\_\+\hspace{0.3cm}{\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_a4557bda2ce50c7a0ffb0330874a1fe9a}


Definition at line 423 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



Referenced by add\+Transaction(), iterate\+B\+F\+S(), next\+Egress(), rebuild\+Tree(), update\+Enqueued\+Weight(), and update\+Priority().

\index{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}!timeout\+\_\+@{timeout\+\_\+}}
\index{timeout\+\_\+@{timeout\+\_\+}!proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue@{proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue}}
\subsubsection[{timeout\+\_\+}]{\setlength{\rightskip}{0pt plus 5cm}{\bf Wheel\+Timer\+Instance} proxygen\+::\+H\+T\+T\+P2\+Priority\+Queue\+::timeout\+\_\+\hspace{0.3cm}{\ttfamily [private]}}\label{classproxygen_1_1HTTP2PriorityQueue_a579a2d30527894df3a6339a160438d7c}


Definition at line 430 of file H\+T\+T\+P2\+Priority\+Queue.\+h.



Referenced by attach\+Thread\+Locals(), and detach\+Thread\+Locals().



The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
proxygen/lib/http/session/{\bf H\+T\+T\+P2\+Priority\+Queue.\+h}\item 
proxygen/lib/http/session/{\bf H\+T\+T\+P2\+Priority\+Queue.\+cpp}\end{DoxyCompactItemize}
