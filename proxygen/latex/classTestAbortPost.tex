\section{Test\+Abort\+Post$<$ stage $>$ Class Template Reference}
\label{classTestAbortPost}\index{Test\+Abort\+Post$<$ stage $>$@{Test\+Abort\+Post$<$ stage $>$}}
Inheritance diagram for Test\+Abort\+Post$<$ stage $>$\+:\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=4.000000cm]{classTestAbortPost}
\end{center}
\end{figure}
\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
void {\bf do\+Abort\+Test} ()
\end{DoxyCompactItemize}
\subsection*{Additional Inherited Members}


\subsection{Detailed Description}
\subsubsection*{template$<$int stage$>$\\*
class Test\+Abort\+Post$<$ stage $>$}



Definition at line 2170 of file H\+T\+T\+P\+Upstream\+Session\+Test.\+cpp.



\subsection{Member Function Documentation}
\index{Test\+Abort\+Post@{Test\+Abort\+Post}!do\+Abort\+Test@{do\+Abort\+Test}}
\index{do\+Abort\+Test@{do\+Abort\+Test}!Test\+Abort\+Post@{Test\+Abort\+Post}}
\subsubsection[{do\+Abort\+Test()}]{\setlength{\rightskip}{0pt plus 5cm}template$<$int stage$>$ void {\bf Test\+Abort\+Post}$<$ stage $>$\+::do\+Abort\+Test (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}}\label{classTestAbortPost_a51190bba3b25d910e02e0a2675a90015}


Definition at line 2172 of file H\+T\+T\+P\+Upstream\+Session\+Test.\+cpp.



References proxygen\+::get\+Post\+Request(), make\+Buf(), proxygen\+::make\+Response(), and stream\+ID.


\begin{DoxyCode}
2172                      \{
2173     \textcolor{comment}{// Send an abort at various points while receiving the response to a GET}
2174     \textcolor{comment}{// The test is broken into "stages"}
2175     \textcolor{comment}{// Stage 0) headers received}
2176     \textcolor{comment}{// Stage 1) chunk header received}
2177     \textcolor{comment}{// Stage 2) body received}
2178     \textcolor{comment}{// Stage 3) chunk complete received}
2179     \textcolor{comment}{// Stage 4) trailers received}
2180     \textcolor{comment}{// Stage 5) eom received}
2181     \textcolor{comment}{// This test makes sure expected callbacks are received if an abort is}
2182     \textcolor{comment}{// sent before any of these stages.}
2183     InSequence enforceOrder;
2184     StrictMock<MockHTTPHandler> handler;
2185     HTTPMessage req = getPostRequest(10);
2186 
2187     std::unique\_ptr<HTTPMessage> resp;
2188     std::unique\_ptr<folly::IOBuf> respBody;
2189     std::tie(resp, respBody) = makeResponse(200, 50);
2190 
2191     handler.expectTransaction();
2192     EXPECT\_CALL(*codecPtr_, generateHeader(\_, \_, \_, \_, \_));
2193 
2194     \textcolor{keywordflow}{if} (stage > 0) \{
2195       handler.expectHeaders();
2196     \}
2197     \textcolor{keywordflow}{if} (stage > 1) \{
2198       EXPECT\_CALL(handler, onChunkHeader(\_));
2199     \}
2200     \textcolor{keywordflow}{if} (stage > 2) \{
2201       EXPECT\_CALL(handler, onBody(\_));
2202     \}
2203     \textcolor{keywordflow}{if} (stage > 3) \{
2204       EXPECT\_CALL(handler, onChunkComplete());
2205     \}
2206     \textcolor{keywordflow}{if} (stage > 4) \{
2207       EXPECT\_CALL(handler, onTrailers(\_));
2208     \}
2209     \textcolor{keywordflow}{if} (stage > 5) \{
2210       handler.expectEOM();
2211     \}
2212 
2213     \textcolor{keyword}{auto} txn = httpSession_->newTransaction(&handler);
2214     \textcolor{keyword}{auto} streamID = txn->getID();
2215     txn->sendHeaders(req);
2216     txn->sendBody(makeBuf(5)); \textcolor{comment}{// only send half the body}
2217 
2218     \textcolor{keyword}{auto} doAbort = [&] \{
2219       EXPECT\_CALL(*codecPtr_, generateRstStream(\_, txn->getID(), \_));
2220       handler.expectDetachTransaction();
2221       \textcolor{keyword}{const} \textcolor{keyword}{auto} \textcolor{keywordtype}{id} = txn->getID();
2222       txn->sendAbort();
2223       EXPECT\_CALL(*codecPtr_,
2224                   generateRstStream(\_, \textcolor{keywordtype}{id}, ErrorCode::\_SPDY\_INVALID\_STREAM))
2225         .Times(AtLeast(0));
2226     \};
2227 
2228     \textcolor{keywordflow}{if} (stage == 0) \{
2229       doAbort();
2230     \}
2231     codecCb_->onHeadersComplete(streamID, std::move(resp));
2232     \textcolor{keywordflow}{if} (stage == 1) \{
2233       doAbort();
2234     \}
2235     codecCb_->onChunkHeader(streamID, respBody->computeChainDataLength());
2236     \textcolor{keywordflow}{if} (stage == 2) \{
2237       doAbort();
2238     \}
2239     codecCb_->onBody(streamID, std::move(respBody), 0);
2240     \textcolor{keywordflow}{if} (stage == 3) \{
2241       doAbort();
2242     \}
2243     codecCb_->onChunkComplete(streamID);
2244     \textcolor{keywordflow}{if} (stage == 4) \{
2245       doAbort();
2246     \}
2247     codecCb_->onTrailersComplete(streamID,
2248                                  std::make\_unique<HTTPHeaders>());
2249     \textcolor{keywordflow}{if} (stage == 5) \{
2250       doAbort();
2251     \}
2252     codecCb_->onMessageComplete(streamID, \textcolor{keyword}{false});
2253 
2254     eventBase_.loop();
2255   \}
\end{DoxyCode}


The documentation for this class was generated from the following file\+:\begin{DoxyCompactItemize}
\item 
proxygen/lib/http/session/test/{\bf H\+T\+T\+P\+Upstream\+Session\+Test.\+cpp}\end{DoxyCompactItemize}
